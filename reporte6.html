<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>666GRÁFICA INDIVIDUAL — MHP100</title>
<style>
  :root{
    --ink:#111; --mut:#666; --line:#e5e7eb; --soft:#f8fafc;
    --red:#e74c3c; --amber:#f4b400; --green:#2e7d32;
  }
  *{box-sizing:border-box}
  body{margin:24px;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;color:var(--ink);background:#fff}
  .top{display:flex;align-items:center;gap:12px}
  .brand{display:flex;align-items:center;gap:10px;flex:1}
  .brand img{height:34px}
  .search{display:flex;gap:8px;align-items:center}
  input[type=text]{padding:8px 10px;border:1px solid var(--line);border-radius:8px;width:160px;text-transform:uppercase}
  button{padding:9px 14px;border-radius:10px;border:1px solid var(--line);background:#f4f6f8;cursor:pointer}
  .msg{font-size:13px;margin-left:6px}
  .ok{color:#0a8}.err{color:#c00}

  .card{border:1px solid var(--line);border-radius:12px;background:#fff}
  .pad{padding:14px}
  .row{display:flex;gap:12px;align-items:center}
  .hdrline{display:grid;grid-template-columns:repeat(6,1fr);gap:10px}
  .hdrline .item{border:1px solid var(--line);border-radius:10px;padding:10px 12px;background:#fff}
  .hdrline .kv{font-size:12px;color:var(--mut)}
  .hdrline b{font-size:14px}
  .rightVal{font-weight:800}

  h2{font-size:18px;margin:16px 0 8px}
  h3{font-size:16px;margin:14px 0 10px}

  .two{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
  .box{border:1px solid var(--line);border-radius:12px;background:#fff}
  .box h3{padding:10px 12px;border-bottom:1px solid var(--line);margin:0}
  .box .body{padding:12px}

  /* curva */
  .legend-band{height:10px;border:1px solid #222;border-radius:4px;margin-top:6px;position:relative}
  .legend-red{position:absolute;left:0;top:0;bottom:0;width:39%;background:var(--red)}
  .legend-amber{position:absolute;left:39%;top:0;bottom:0;width:31%;background:var(--amber)}
  .legend-green{position:absolute;left:70%;top:0;bottom:0;width:30%;background:var(--green)}
  .ticks{display:flex;justify-content:space-between;font-size:12px;color:#333;margin-top:6px}
  svg{display:block;width:100%;height:170px}
  #dot{fill:#111}

  /* IV grid */
  .ivgrid{width:100%;border-collapse:collapse;font-size:14px}
  .ivgrid th,.ivgrid td{border:1px solid #222;padding:8px 10px;vertical-align:top}
  .ivgrid .hit{background:#fde68a}

  /* barras */
  .barrow{margin:10px 0}
  .barlbl{font-weight:800;margin-bottom:6px}
  .bar{position:relative;height:16px;border:1px solid #222;border-radius:8px;background:#fff;overflow:hidden}
  .seg{position:absolute;top:0;bottom:0}
  .seg.r{left:0;width:39%;background:var(--red)}
  .seg.a{left:39%;width:31%;background:var(--amber)}
  .seg.g{left:70%;width:30%;background:var(--green)}
  .mk{position:absolute;top:-2px;width:3px;height:20px;background:#111;transform:translateX(-50%)}

  table.tbl{width:100%;border-collapse:collapse}
  .tbl th,.tbl td{border:1px solid var(--line);padding:8px 10px;text-align:left}
  .tbl th{background:var(--soft)}

  .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-weight:800;color:#fff;font-size:12px}
  .b-red{background:var(--red)} .b-amb{background:#f59e0b} .b-grn{background:#2e7d32}

  @media print{
    .top,.search,.msg{display:none}
    body{margin:10mm}
  }
</style>
</head>
<body>

<!-- encabezado superior -->
<div class="top">
  <div class="brand">
    <img src="assets/img_ident.jpg" alt="MHP100"/>
    <h1 style="margin:0;font-size:22px">GRÁFICA INDIVIDUAL — MHP100</h1>
  </div>
  <div class="search">
    <label for="codigo" style="font-weight:700">Código</label>
    <input id="codigo" type="text" placeholder="LEX001"/>
    <button id="btn">Ver reporte</button>
    <span id="msg" class="msg"></span>
  </div>
  <img src="assets/img_sello.png" alt="Lexium" style="height:34px;margin-left:auto"/>
</div>

<!-- contenedor del reporte (oculto hasta buscar) -->
<div id="rep" class="card pad" style="margin-top:14px;display:none">

  <!-- encabezado una sola línea + IIE a la derecha -->
  <div class="hdrline" style="margin-bottom:10px">
    <div class="item"><div class="kv">Nombre</div><b id="nm">—</b></div>
    <div class="item"><div class="kv">Edad</div><b id="ed">—</b></div>
    <div class="item"><div class="kv">Curso/Grado</div><b id="gr">—</b></div>
    <div class="item"><div class="kv">Institución</div><b id="ins">—</b></div>
    <div class="item"><div class="kv">Grupo</div><b id="gp">—</b></div>
    <div class="item"><div class="kv">Fecha</div><b id="fe">—</b></div>
  </div>

  <div class="row" style="justify-content:space-between;margin-bottom:6px">
    <h2 style="margin:0">ÍNDICE DE INTELIGENCIA EMOCIONAL IIE:</h2>
    <div class="rightVal" id="iie">—</div>
  </div>

  <!-- curva + IVs -->
  <div class="two">
    <div class="box">
      <h3>CURVA DE DISTRIBUCIÓN DE FRECUENCIAS</h3>
      <div class="body">
        <div class="legend-band">
          <div class="seg r"></div><div class="seg a"></div><div class="seg g"></div>
        </div>
        <div class="ticks"><span>1</span><span>40</span><span>70</span><span>100</span></div>
        <svg viewBox="0 0 560 170" aria-hidden="true">
          <path id="curve" d="" stroke="#111" stroke-width="2" fill="none"/>
          <circle id="dot" cx="280" cy="85" r="5"/>
        </svg>
      </div>
    </div>

    <div class="box">
      <h3>IV1 – IV2 – IV3</h3>
      <div class="body">
        <table class="ivgrid">
          <tr id="iv1r">
            <th>IV1</th>
            <td>Se conoce o se compromete</td>
            <td>Se conoce o se compromete poco</td>
            <td>Se requiere mayor autoconocimiento o auto compromiso</td>
          </tr>
          <tr id="iv2r">
            <th>IV2</th>
            <td>No se contradice</td>
            <td>Se contradice</td>
            <td>Se contradice frecuentemente</td>
          </tr>
          <tr id="iv3r">
            <th>IV3</th>
            <td>Entre 30 y 90 minutos<br><span style="color:var(--mut)">Tomó el tiempo adecuado</span></td>
            <td>Entre 10 y 20 minutos<br><span style="color:var(--mut)">Demasiado breve</span></td>
            <td>Más de 90 minutos<br><span style="color:var(--mut)">Demasiado lento</span></td>
          </tr>
        </table>
      </div>
    </div>
  </div>

  <!-- barras -->
  <div class="two" style="margin-top:14px">
    <div class="box">
      <h3>ESTILOS DE COMUNICACIÓN INTERPERSONAL</h3>
      <div class="body">
        <div class="barrow">
          <div class="barlbl">AGRESIÓN</div>
          <div class="bar">
            <div class="seg r"></div><div class="seg a"></div><div class="seg g"></div>
            <div id="mkA" class="mk" style="left:0%"></div>
          </div>
        </div>
        <div class="barrow">
          <div class="barlbl">TIMIDEZ</div>
          <div class="bar">
            <div class="seg r"></div><div class="seg a"></div><div class="seg g"></div>
            <div id="mkT" class="mk" style="left:0%"></div>
          </div>
        </div>
        <div style="font-size:12px;color:var(--mut)">*</div>
        <div style="font-size:12px;color:var(--mut)">Un puntaje bajo indica mejor manejo en estas áreas.</div>
      </div>
    </div>

    <div class="box">
      <h3>PROPENSIÓN AL CAMBIO</h3>
      <div class="body">
        <div class="bar">
          <div class="seg r"></div><div class="seg a"></div><div class="seg g"></div>
          <div id="mkC" class="mk" style="left:0%"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- tablas -->
  <div class="two" style="margin-top:14px">
    <div class="box">
      <h3>RESULTADOS (sub-habilidades)</h3>
      <div class="body">
        <table class="tbl" id="subs">
          <thead><tr><th>Bloque</th><th>Sub-habilidad</th><th>Ítems</th><th>Puntos</th><th>%</th><th>Rango</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <div class="box">
      <h3>Por bloque</h3>
      <div class="body">
        <table class="tbl" id="bloques">
          <thead><tr><th>Bloque</th><th>Promedio %</th><th>Rango</th></tr></thead>
          <tbody></tbody>
        </table>
        <div style="font-size:12px;color:var(--mut);margin-top:6px">
          Rangos: <span class="badge b-red">1–40</span> <span class="badge b-amb">41–70</span> <span class="badge b-grn">71–100</span>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
  const $=s=>document.querySelector(s);
  const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));
  const rngBadge=p=> p<=40 ? ['1–40 Por desarrollar','b-red']
                     : p<=70 ? ['41–70 Por fortalecer','b-amb']
                             : ['71–100 Por enriquecer','b-grn'];

  function bell(){
    const P=$("#curve"); if(!P) return;
    const W=560, H=170, L=20, R=W-20, base=128, top=28, mid=(L+R)/2, sigma=95;
    const pts=[];
    for(let x=L;x<=R;x+=4){
      const z=(x-mid)/sigma;
      const y=base - Math.exp(-.5*z*z)*(base-top);
      pts.push([x,y]);
    }
    let d=`M${pts[0][0]} ${pts[0][1]}`;
    for(let i=1;i<pts.length;i++) d+=` L${pts[i][0]} ${pts[i][1]}`;
    P.setAttribute('d',d);
  }
  bell();

  function setDot(score){
    const W=560, L=20, R=W-20, base=128, top=28, mid=(L+R)/2, sigma=95;
    const s=clamp(Number(score)||0,1,100);
    const x= L + (s-1)/99*(R-L);
    const z=(x-mid)/sigma;
    const y= base - Math.exp(-.5*z*z)*(base-top);
    $("#dot").setAttribute('cx',x);
    $("#dot").setAttribute('cy',y);
  }
  function setMk(id,val){
    const p=(clamp(Number(val)||0,10,100)-10)/90*100;
    const el=$(id); if(!el) return; el.style.left=p+'%';
  }
  function hl(row,idx){
    const r=$(row); if(!r) return;
    r.querySelectorAll('td').forEach(td=>td.classList.remove('hit'));
    const tds=r.querySelectorAll('td');
    if (idx>=1 && idx<=3) tds[idx-1].classList.add('hit');
  }
  function ivIdx(v){
    if (v==null) return 2;
    const n=Number(v);
    if(Number.isInteger(n)&&n>=1&&n<=3) return n;
    if(!Number.isNaN(n)){ if(n<=40) return 1; if(n<=70) return 2; return 3; }
    const s=String(v).toLowerCase();
    if (s.includes("no se contradice")||s.includes("tiempo adecuado")) return 1;
    if (s.includes("frecuentemente")||s.includes("lento")) return 3;
    return 2;
  }

  async function cargar(){
    const code=$("#codigo").value.trim().toUpperCase();
    const msg=$("#msg"); msg.textContent=""; if(!code){msg.textContent="Ingresa código"; msg.className="msg err"; return;}
    try{
      const r=await fetch(`/api/report?codigo=${encodeURIComponent(code)}`);
      if(!r.ok) throw 0;
      const data=await r.json();
      const P=data.participante||data.participant||{};
      const A=data.attempt||data.intento||data||{};
      const R=A.resultados||data.resultados||{};

      // header
      $("#nm").textContent= A.nombre || P.nombre || "—";
      $("#ed").textContent= A.edad_anios || P.edad_anios || "—";
      $("#gr").textContent= A.curso || P.curso || "—";
      $("#ins").textContent= A.institucion || P.institucion || "—";
      $("#gp").textContent= A.grupo || P.grupo || "—";
      const f=(A.created_at||A.fecha||"").toString().slice(0,10);
      $("#fe").textContent= f || "—";

      // IIE
      const iie= A.iie ?? (R.globales && R.globales.IIE) ?? null;
      $("#iie").textContent= iie!=null? iie : "—";
      setDot(iie||0);

      // IVs
      hl("#iv1r", ivIdx(A.iv1 ?? (R.globales && R.globales.IV1)));
      hl("#iv2r", ivIdx(A.iv2 ?? (R.globales && R.globales.IV2)));
      hl("#iv3r", ivIdx(A.iv3 ?? (R.globales && R.globales.IV3)));

      // barras
      let agresion=null,timidez=null,prop=null;
      const subs = (R.subhabilidades||A.subhabilidades||[]);
      for(const s of subs){
        const n=(s.sub||s.subhabilidad||"").toLowerCase();
        if(n==="agresión"||n==="agresion") agresion=Number(s.pct);
        if(n==="timidez") timidez=Number(s.pct);
        if(n==="propensión al cambio"||n==="propension al cambio") prop=Number(s.pct);
      }
      if(prop==null && R.bloques && R.bloques.propension_cambio!=null) prop=Number(R.bloques.propension_cambio);

      setMk("#mkA", agresion||10);
      setMk("#mkT", timidez||10);
      setMk("#mkC", prop||10);

      // tablas
      const tb=$("#subs tbody"); tb.innerHTML="";
      for(const s of subs){
        const pct=Math.round(s.pct||0);
        const [txt,cls]=rngBadge(pct);
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${s.bloque||s.block||""}</td>
                      <td>${s.sub||s.subhabilidad||""}</td>
                      <td>${s.items??s.n_items??""}</td>
                      <td>${s.puntos??s.pts??""}</td>
                      <td><b>${pct}</b></td>
                      <td><span class="badge ${cls}">${txt}</span></td>`;
        tb.appendChild(tr);
      }

      const bl=$("#bloques tbody"); bl.innerHTML="";
      const B = R.bloques || A.bloques || {};
      const list = Array.isArray(B) ? B
                  : Object.entries(B).map(([k,v])=>({bloque:k,pct:v}));
      for(const b of list){
        const pct=Math.round(b.pct||b.percent||b.value||0);
        const [txt,cls]=rngBadge(pct);
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${b.bloque||b.block||""}</td>
                      <td><b>${pct}</b></td>
                      <td><span class="badge ${cls}">${txt}</span></td>`;
        bl.appendChild(tr);
      }

      $("#rep").style.display="block";
      msg.textContent="Código válido."; msg.className="msg ok";
      window.scrollTo({top:0,behavior:"smooth"});
    }catch(e){
      $("#rep").style.display="none";
      $("#msg").textContent="No encontrado / error de API"; $("#msg").className="msg err";
    }
  }

  $("#btn").addEventListener("click", cargar);
  $("#codigo").addEventListener("keydown",e=>{if(e.key==="Enter") cargar()});
  (function(){const q=new URLSearchParams(location.search).get("codigo"); if(q){$("#codigo").value=q; cargar();}})();
</script>
</body>
</html>
