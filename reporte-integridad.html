<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>mar 21 08  Integridad -  Reporte (AFINADO)</title>
  <style>
    :root{
      --ink:#111; --muted:#666; --line:#ddd;
      --yellow:#ffe36a; --green:#2e9b4f; --orange:#f4a338; --red:#e45757;
    }
    html,body{margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:#fff;color:#0f172a;min-height:100vh;}
    .wrap{max-width:900px;margin:18px auto 48px;padding:0 12px}
    h1,h2,h3{margin:0 0 8px 0}
    .muted{color:var(--muted)}
    .val-note{
  margin-top: 10px;
  font-size: 12px;
  color: #6b7280;
  line-height: 1.35;
}

    .topbar{display:flex;gap:12px;align-items:center;margin-bottom:8px}
    .topbar input{flex:0 0 180px;padding:8px 10px;border:1px solid #bbb;border-radius:8px;font-size:16px;text-transform:uppercase}
    .btn{padding:9px 14px;border-radius:999px;border:0;background:#1a8f3b;color:#fff;font-weight:700;font-size:16px;cursor:pointer}
    .msg{margin-left:8px;font-weight:700}
    .msg.ok{color:#0a8}
    .msg.err{color:#c00}
    .hint{font-size:12px;color:var(--muted);margin-bottom:8px}

    .rep-top{border-bottom:1px solid var(--line);padding-bottom:6px;margin-bottom:6px;}
    .rep-top-row1{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;font-size:12px;margin-bottom:6px;}
    .rep-date{justify-self:flex-start;}
    .rep-top-center{text-align:center;font-weight:700;text-transform:uppercase;}
    .rep-top-logo{justify-self:flex-end;}
    .mhp-logo{height:56px !important;width:auto !important;object-fit:contain;display:block;}
    .rep-top-row2{display:flex;justify-content:center;align-items:center;gap:12px;font-size:26px;font-weight:800;margin-bottom:2px;text-transform:uppercase;}
    .rep-top-row3{text-align:center;font-size:18px;font-weight:800;}

    .iv-table td.hl{background:var(--yellow)}
    .iv-key{font-weight:900;color:#000;}
    .iv-legend{display:flex;gap:14px;justify-content:flex-start;margin-top:6px;font-size:11px;color:#111;flex-wrap:wrap}
    .iv-legend span b{font-weight:900}

    .page{margin-top:10px}
    .page-break{break-after:page;page-break-after:always;margin-bottom:18px;}
    @media print{
      .page-break{margin-bottom:0;}

      @page{ size:A4; margin:8mm 8mm }
      .topbar,.hint{display:none !important}
      body{zoom:0.92;}
      .wrap{max-width:none;margin:0 auto;padding:0 6px}
      .page{margin-top:0;break-inside:auto}
      .page-break{break-after:page;page-break-after:always;margin-bottom:18px;}
      /* Mantener la PARTE 1 en una sola hoja */
      #page1{zoom:0.90;}
      .rep-top{margin-bottom:4px;padding-bottom:4px}
      .rep-ids{margin-top:4px !important}
      .rep-mid{margin-top:4px !important}
      .mhp-logo{height:56px !important;width:auto !important;object-fit:contain;display:block;}
      .rep-top-row2{font-size:22px !important;margin-bottom:0 !important}
      .rep-top-row3{font-size:16px !important}
      .bloque-title{margin:8px 0 4px !important}
      .scale-section{margin-top:8px !important}
      /* Compactaci√≥n para confirmar que la P√°gina 1 quede completa */
      #page1{page-break-after:always; break-after:page;}
      #page1 *{break-inside:avoid;}
      .rep-top{padding-bottom:4px;margin-bottom:4px}
      .rep-top-row2{font-size:22px;margin-bottom:0}
      .rep-top-row3{font-size:16px}
      .mhp-logo{height:56px !important;width:auto !important;object-fit:contain;display:block;}
      #repHeaderBox{padding:4px !important}
      .rep-mid{margin-top:6px !important}
      .bloque-title{margin:8px 0 4px}
      .iie-row{margin:8px 0 4px}
      .scale-section{margin-top:8px}
      .bars-row{margin:6px 0}
      .bars-slot{height:18px}
      .bars-slot .tick-label{top:15px}
      .scale-note-inline{margin-top:2px}
  /* === FIX PDF: asegurar que la curva (SVG) se imprima === */
  *{
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
  }

  .curve{
    background: #fff !important;
    box-shadow: none !important;
  }

  .curve-caption{
    background: #fff !important;
    box-shadow: none !important;
    backdrop-filter: none !important;
    -webkit-backdrop-filter: none !important;
  }

  /* Quitar filtros que suelen "romper" SVG en PDF */
  .curve-3d{ filter: none !important; }
  #curveFill{ filter: none !important; }

    }


    .bloque-title{font-weight:800;margin:12px 0 6px;display:flex;align-items:center;justify-content:space-between;gap:8px;}
    .bloque-left{display:flex;align-items:center;gap:6px;}
    .bloque-bullet{width:10px;height:10px;border-radius:999px;background:#f4a338;flex:0 0 auto;}
    .ih-badge{background:var(--yellow);padding:2px 10px;border-radius:2px;min-width:36px;text-align:center;font-weight:800;}
    .iie-row{display:flex;justify-content:flex-end;align-items:center;margin:12px 0 6px;font-weight:800;gap:8px;}
    .iie-badge{background:#1d4ed8;color:#fff;padding:3px 12px;border-radius:2px;min-width:40px;text-align:center;}

    .scale-section{margin-top:14px;}
    .section-title{display:flex;align-items:center;gap:6px;font-weight:800;margin-bottom:2px;}
    .section-dot{width:10px;height:10px;border-radius:999px;background:#f4a338;flex:0 0 auto;}
    .scale-range-header{display:grid;grid-template-columns:220px 1fr 1fr 1fr;font-size:11px;font-weight:700;margin:0 0 2px;align-items:flex-end;}
    .scale-range-header span{text-align:center;}
.scale-note-inline{
  font-size:11px;
  color:var(--muted);
  margin-top:4px;
  text-align:center;
  position: relative;
  left: 4cm;
}

    .bars-wrap{margin:8px 0}
    .bars-row{display:grid;grid-template-columns:220px 1fr;align-items:center;gap:8px;margin:10px 0;}
    .bars-row .label{font-weight:700;font-size:12px}
    .bars-slot{position:relative;height:22px;border:1px solid #9ca3af;border-radius:4px;background:#f3f4f6}
    .bars-slot .tick{position:absolute;top:-6px;width:1px;height:24px;background:#9ca3af}
    .bars-slot .tick-label{position:absolute;top:19px;font-size:10px;transform:translateX(-50%)}
    .bars-slot .marker{position:absolute;top:-2px;width:10px;height:16px;background:#111;border-radius:2px;transform:translateX(-50%);display:none}

    /* Interpretaci√≥n larga */
    .interp-title{margin-top:8px;font-size:18px;font-weight:800;}
    .interp-legend{font-size:12px;color:var(--muted);margin-top:4px;margin-bottom:4px;}
    .interp-legend-row{margin-top:3px;margin-bottom:3px;}
    .interp-bloque{border:1px solid var(--line);border-radius:10px;padding:10px;margin-top:8px;font-size:12px;background:#fff;}
    .interp-bloque-header{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:4px;}
    .interp-bloque-nombre{font-weight:800;text-transform:uppercase;}
    .interp-bloque-indice{font-weight:800;font-size:12px;}
    .interp-bloque-indice span{background:var(--yellow);padding:2px 8px;border-radius:2px;min-width:36px;text-align:center;display:inline-block;}
    .interp-bloque-desc{font-size:12px;color:var(--muted);margin-bottom:6px;}
    .skill-row{margin:6px 0 10px;}
    .skill-row-title{font-weight:700;font-size:12px;margin-bottom:2px;}
    .skill-row-desc{font-size:11px;color:var(--muted);margin-bottom:4px;}
    .skill-row-alert{color: var(--red);font-weight:600;}
    .skill-bar{display:flex;align-items:center;gap:6px;}
    .skill-bar-track{position:relative;flex:1;height:12px;border-radius:999px;overflow:hidden;background:linear-gradient(to right,var(--red) 0%, var(--red) 40%,var(--orange) 40%, var(--orange) 70%,var(--green) 70%, var(--green) 100%);}
    .skill-bar-marker{position:absolute;top:0;bottom:0;width:2px;background:#111;transform:translateX(-50%);}
    .skill-bar-value{font-size:11px;font-weight:700;min-width:48px;text-align:right;}

    .recom-subtitle{font-size:12px;color:var(--muted);margin-bottom:4px;}
    .recom-list{margin:4px 0 0 14px;padding:0;font-size:12px;color:#374151;}
    .recom-list li{margin-bottom:3px;}
    .plan-section-title{font-weight:700;font-size:12px;margin-top:4px;margin-bottom:2px;}
    /* ===== Prioridades (Top 3) ===== */
    .plan-focus-box{border:1px solid var(--line);border-radius:12px;padding:10px 12px;margin:10px 0 12px;background:#fff;}
    .plan-focus-item{border-top:1px dashed #e5e7eb;padding-top:10px;margin-top:10px;}
    .plan-focus-item:first-child{border-top:0;padding-top:0;margin-top:0;}
    .plan-focus-head{font-size:12px;margin-bottom:6px;}
    .plan-focus-obj{font-size:12px;margin-bottom:6px;color:#111827;}
    .plan-focus-meta{font-size:12px;color:#374151;margin-top:4px;}


    .p2-title{display:flex;justify-content:space-between;align-items:center;margin-top:6px}
    .p2-title h2{font-size:18px;font-weight:800}
    .card{border:1px solid var(--line);border-radius:10px;padding:10px;margin-top:8px}
    .result-table th,.result-table td{border-bottom:1px solid #e5e5e5;padding:6px 8px;font-size:13px;text-align:left}
    .result-table th{font-weight:800}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-weight:800;font-size:12px;color:#fff}
    .b-red{background:var(--red)}
    .b-orange{background:var(--orange)}
    .b-green{background:var(--green)}
  
    .complementarias{
      margin-top:14px;
      border-top:1px solid var(--line);
      padding-top:10px;
    }
    .esc-comp-header{
      text-align:center;
      margin-bottom:8px;
    }
    .esc-comp-title{
      font-weight:900;
      font-size:14px;
      text-transform:uppercase;
    }
    .esc-comp-subtitle{
      font-weight:800;
      font-size:12px;
      text-transform:uppercase;
      margin-top:2px;
    }
    @media print{
      .page-1{page-break-after:always}

      .complementarias{ page-break-before: always; break-before: page; border-top:0; padding-top:0; }
    }

  
    /* ===== Integridad layout ===== */
    .rep-head{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
    .rep-brand{display:flex;align-items:center;gap:12px}
    .rep-brand img{width:64px;height:64px;object-fit:contain}
    .rep-title{font-size:20px;font-weight:900;letter-spacing:.2px}
    .rep-subtitle{font-size:13px}
    .rep-meta{font-size:12px;white-space:nowrap}
    .rep-box{border:1px solid var(--line);border-radius:10px;padding:10px 12px;display:grid;grid-template-columns:1fr 1fr;gap:6px 14px;margin:10px 0 8px}
    .row2{display:grid;grid-template-columns:1.2fr .8fr;gap:14px;margin:6px 0 10px}
    .mini{border:1px solid var(--line);border-radius:10px;padding:10px 12px}
    .mini-title{font-weight:900;margin-bottom:8px}
    
    /* ===== Curva / gr√°fica moderna ===== */
    .curve{position:relative;border-radius:16px;padding:36px 12px 12px;background:linear-gradient(180deg,#ffffff 0%, #f8fafc 100%);box-shadow:0 12px 28px rgba(0,0,0,.08);overflow:hidden}
    .curve-svg{width:100%;height:72px;display:block}
    .curve-band{height:10px;border-radius:999px;background:linear-gradient(90deg,#e45757 0%, #f4a338 38%, #2e9b4f 68%, #2e9b4f 100%);opacity:.95;box-shadow:inset 0 1px 0 rgba(255,255,255,.55)}
    .curve-marker{position:absolute;top:118px;transform:translateX(-50%);display:flex;flex-direction:column;align-items:center;gap:4px;transition:left .35s cubic-bezier(.2,.8,.2,1)}
    .curve-marker .pin{width:14px;height:14px;border-radius:999px;background:#111;box-shadow:0 10px 22px rgba(0,0,0,.25)}
    .curve-marker .stem{width:2px;height:12px;background:#111;border-radius:999px;opacity:.9}
    .curve-marker .halo{position:absolute;inset:-12px auto auto -12px;width:38px;height:38px;border-radius:999px;background:radial-gradient(circle,rgba(17,17,17,.22),rgba(17,17,17,0) 60%);filter:blur(.2px)}
    .curve-axis{display:flex;justify-content:space-between;font-size:11px;color:var(--muted);margin-top:8px}
.curve-caption{position:absolute;top:10px;left:12px;right:auto;display:inline-flex;justify-content:flex-start;align-items:center;gap:6px;font-size:12px;color:#334155;margin:0;padding:4px 10px;border-radius:999px;background:rgba(255,255,255,.86);box-shadow:0 10px 22px rgba(0,0,0,.10);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px)}
        .curve-3d{filter:drop-shadow(0 14px 14px rgba(0,0,0,.12))}
    .curve-fill{fill:url(#curveGrad);opacity:.95}
    .curve-line{fill:none;stroke:url(#curveLineGrad);stroke-width:1.6}
    .curve-hi{fill:none;stroke:rgba(255,255,255,.9);stroke-width:1.2;opacity:.65}

    .ivline{font-size:14px;margin:4px 0}
    .cards2x2{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
    .cards2x2 .card{border-radius:12px;background:#bdebf0;display:flex;align-items:center;justify-content:space-between;padding:16px 18px}
    .cards2x2 .card-label{font-weight:900;font-size:18px}
    .cards2x2 .card-score{width:56px;height:44px;border-radius:8px;background:#fff;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:22px}
.iviRow{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:10px;
}
    /* T√≠tulo ‚ÄúINDICE DE VALORES E INTEGRIDAD‚Äù m√°s grande y centrado */
/* üîß Forzar 1 sola l√≠nea: T√≠tulo + [IVI|xx] */
.iviLeft{
  display:flex !important;
  flex-direction:row !important;
  align-items:center !important;
  justify-content:center !important;
  gap:14px !important;
  flex-wrap:nowrap !important;
}

/* La caja IVI se mantiene compacta y en l√≠nea */
.iviBox{
  display:inline-flex !important;
  flex:0 0 auto !important;
  margin:0 !important;
}
    .iviTag{padding:10px 12px;font-weight:900;display:flex;align-items:center}
    .iviVal{padding:10px 16px;background:var(--yellow);font-weight:900;font-size:20px;display:flex;align-items:center}
    /* El t√≠tulo NO debe ocupar todo el ancho */
.iviCaption{
  display:inline !important;
  width:auto !important;
  margin:0 !important;
  white-space:nowrap !important;
}
    .stars{font-size:30px;letter-spacing:3px}
    .star{color:#e5e7eb}
    .star.on{color:#f59e0b}
    .seals{
  display:inline-flex;
  align-items:center;
  gap:10px;
}
.seal{
  width:22px;       /* ajustable */
  height:auto;
  opacity:0.18;     /* difuminado */
}
.seal.on{
  opacity:1;        /* clarito */
}

    .iviLegend{margin-top:6px;font-size:14px}
    .interpGrid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
    .interpCard{border:1px solid var(--line);border-radius:12px;padding:12px 14px}
    .interpHead{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .interpTitle{font-weight:900}
    .interpBadge{border-radius:999px;padding:6px 10px;font-weight:900;background:#eef2ff}
    .interpTxt{color:#111;font-size:14px;line-height:1.35}
    .overall{border:1px solid var(--line);border-radius:12px;padding:12px 14px;margin-top:14px}
    .overallRow{display:flex;gap:12px;align-items:flex-start}
    .overallBadge{border-radius:10px;padding:10px 12px;font-weight:900;background:#111;color:#fff;min-width:56px;text-align:center}
    .overallTxt{font-size:14px;line-height:1.35}
    @media (max-width:720px){
      .rep-box{grid-template-columns:1fr}
      .row2{grid-template-columns:1fr}
      .cards2x2{grid-template-columns:1fr}
      .interpGrid{grid-template-columns:1fr}
    }

  
    .rep-brand img{width:56px;height:56px;object-fit:contain;}
    .rep-title{line-height:1.1}


/* === AFINADOS (overrides) === */
:root{
  --page-max-width: 980px;
  --page-pad-x: 28px;
  --page-pad-y: 22px;
}

/* Jerarqu√≠a tipogr√°fica */
h1{ margin:0 0 6px 0; line-height:1.08; letter-spacing:-.2px; }
.subtitle, .subtitulo, .report-subtitle{ margin-top:2px; }

/* Header: logo a la derecha m√°s grande */
.header, .report-header, .topbar, #header, .encabezado{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:18px;
}
.mhp-logo{
  height:82px !important;
  width:auto !important;
  object-fit:contain;
  display:block;
  margin-left:auto;
}

/* Contenedor de p√°gina: m√°s aire */
.page, .pagina{
  max-width: var(--page-max-width);
  margin-left:auto;
  margin-right:auto;
  padding: var(--page-pad-y) var(--page-pad-x);
}

/* Separaci√≥n visual Parte 1 / Parte 2 en pantalla */
@media screen{
  body{ background:#f3f5f8; }
  .page, .pagina{
    background:#fff;
    border:1px solid #e6e8ee;
    border-radius:14px;
    box-shadow:0 10px 30px rgba(0,0,0,.06);
  }
  .page + .page, .pagina + .pagina{ margin-top:34px; }

  /* Evitar colapso del salto en pantalla */
  .page-break{
    height:auto !important;
    margin:0 !important;
    border:0 !important;
    break-after: page;
    page-break-after: always;
  }
}

/* Aire y anti-encimado interno */
.section-title, .titulo-seccion{ margin:10px 0 8px; }
.card, .mini-box, .box{ overflow:hidden; }
.grid2, .two-col, .row2{ gap:18px; }


/* Logo (arriba a la derecha) */
.rep-brand{display:flex;align-items:center;gap:14px;}
.rep-brand > img{order:2;margin-left:18px;}
.rep-brand > div{order:1;}
.mhp-logo{height:175px !important;width:auto !important;object-fit:contain;display:block;margin-left:auto;}

.starNote{margin-top:10px;font-size:12.5px;line-height:1.35;}

/* (removido) override antiguo de curva */



/* === LOGO a la derecha (sin tocar colores ni cards) === */
.rep-head .rep-brand{
  display:flex !important;
  align-items:center !important;
  gap:14px !important;
  width:100% !important;
}
.rep-head .rep-brand > div{
  flex: 1 1 auto !important;
  text-align:center !important; /* como te gust√≥ */
}
.rep-head .rep-brand #brandLogo{
  margin-left:auto !important;
}


/* === Interpretaci√≥n (acorde√≥n) === */
.interpGrid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:10px}
@media (max-width: 860px){.interpGrid{grid-template-columns:1fr}}
.interpCard{background:#fff;border:1px solid rgba(0,0,0,.08);border-radius:16px;padding:16px}
.interpHead{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
.interpTitle{font-weight:800;font-size:18px;margin:0 0 6px 0}
.interpBadge{display:inline-flex;align-items:center;gap:8px;font-size:13px;color:#1f2937}
.interpBadge .pill{display:inline-block;padding:4px 10px;border-radius:999px;font-weight:700;font-size:12px;background:rgba(59,130,246,.12);color:#1d4ed8}
.interpBadge .pct{color:#6b7280;font-weight:600}
.interpToggle{width:42px;height:42px;border-radius:999px;border:none;background:rgba(59,130,246,.12);color:#1d4ed8;font-weight:900;font-size:22px;cursor:pointer;flex:0 0 auto}
.interpToggle:hover{filter:brightness(.98)}
.interpBody{margin-top:12px;font-size:14px;line-height:1.55;color:#111827}
.interpBody h4{margin:10px 0 6px 0;font-size:14px}
.interpBody ul{margin:6px 0 10px 18px}
.interpBody li{margin:4px 0}
#repSeals .seal{
  width: 66px;   /* doble aprox */
  height: auto;
}
.iviSoft{
  margin-top: 8px;
  font-size: 13px;
  line-height: 1.35;
  color: #6b7280;
}
.iviLevels{
  margin-top: 10px;
  display: grid;
  gap: 6px;
  font-size: 13px;
  line-height: 1.35;
}
.iviLevels b{ color:#111827; }
.iviLevelsNote{
  margin-top: 6px;
  font-size: 12px;
  color:#6b7280;
}
    .iviRight{
  width:100%;
  display:flex;
  align-items:baseline;
  justify-content:center;
  gap:12px;
  flex-wrap:wrap;
}
.iviLegend{
  margin:0;
  white-space:nowrap;
}
.iviBox .iviTag{
  padding:10px 14px;
  font-weight:900;
  background:#fff;
}
.iviBox .iviVal{
  padding:10px 18px;
  font-weight:900;
  background:#ffe76a;
}
/* Quitar la nota duplicada solo en Parte 2 (iviBox2) */
#iviBox2 > .muted{
  display: none !important;
}


/* ===== Parte 2: cuadro gu√≠a (sellos por etapa) ===== */
#page2 h2{ font-size:22px; }

.iviGuide{ margin-top:12px; padding-top:10px; border-top:1px dashed rgba(0,0,0,.12); }
.iviGuideIntro{ margin:0 0 10px; font-size:13px; line-height:1.35; }
.iviGuideTitle{ font-weight:800; font-size:13px; margin:8px 0 8px; text-transform:uppercase; letter-spacing:.4px; }

.iviGuideTable{
  width:100%;
  border-collapse:separate;
  border-spacing:0;
  overflow:hidden;
  border:1px solid rgba(0,0,0,.12);
  border-radius:12px;
  font-size:13px;
}
.iviGuideTable th{
  background:rgba(0,0,0,.04);
  font-weight:800;
  text-align:left;
  padding:10px 12px;
  border-bottom:1px solid rgba(0,0,0,.10);
}
.iviGuideTable td{
  padding:10px 12px;
  border-bottom:1px solid rgba(0,0,0,.08);
  vertical-align:top;
}
.iviGuideTable tr:last-child td{ border-bottom:none; }
.iviGuideTable tr.is-active td{
  background:rgba(255, 231, 106, .35);
}
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <input id="codigoInput" placeholder="COD001" maxlength="12"/>
    <button class="btn" id="btnVer">Ver reporte</button>
    <span id="msg" class="msg"></span>
  </div>
  <div class="hint">Tip: tambi√©n puedes abrir ?codigo=COD001</div>


    <div id="reporteContainer" style="display:none;">
  <!-- ===== PAGE 1 ===== -->
  <section id="page1" class="page page-break">
    <div class="rep-top">
      <div class="rep-head">
        <div class="rep-brand">
          <img id="brandLogo" alt="ADALAM" src="assets/logo_adalam.png" onerror="this.style.display='none'" class="mhp-logo"/>
          <div>
            <div class="rep-title">VALORES E INTEGRIDAD </div>
            <div class="rep-subtitle muted">REPORTE INDIVIDUAL1</div>
          </div>
        </div>
        <div class="rep-meta muted" id="repDateLine">‚Äî</div>
      </div>

      <div class="rep-box" id="repHeaderBox"></div>

      <div class="row2">
        <div class="mini">
          <div class="mini-title">Curva de distribuci√≥n</div>
          <div class="curve">
            <div class="curve-caption" id="curveCaption">Tu puntaje: ‚Äî</div>

            <svg id="curveSvg" class="curve-svg curve-3d" viewBox="0 0 100 32" preserveAspectRatio="none" aria-hidden="true">
              <defs>
                <linearGradient id="curveGrad" x1="0" y1="0" x2="0" y2="1">
                  <stop offset="0%" stop-color="#22c55e" stop-opacity="0.55"/>
                  <stop offset="55%" stop-color="#f4a338" stop-opacity="0.35"/>
                  <stop offset="100%" stop-color="#e45757" stop-opacity="0.22"/>
                </linearGradient>
                <linearGradient id="curveLineGrad" x1="0" y1="0" x2="1" y2="0">
                  <stop offset="0%" stop-color="#e45757"/>
                  <stop offset="45%" stop-color="#f4a338"/>
                  <stop offset="70%" stop-color="#2e9b4f"/>
                  <stop offset="100%" stop-color="#2e9b4f"/>
                </linearGradient>
                <filter id="softShadow" x="-20%" y="-40%" width="140%" height="200%">
                  <feDropShadow dx="0" dy="2.5" stdDeviation="2.2" flood-color="#000" flood-opacity="0.18"/>
                </filter>
              </defs>
              <path id="curveFill" d="" class="curve-fill" filter="url(#softShadow)"></path>
              <path id="curveLine" d="" class="curve-line"></path>
              <path id="curveHi" d="" class="curve-hi"></path>
            </svg>
            <div class="curve-band"></div>
            <div class="curve-marker" id="curveMarker" style="left:0%">
              <span class="halo" aria-hidden="true"></span>
              <span class="pin" aria-hidden="true"></span>
              <span class="stem" aria-hidden="true"></span>
            </div>
            <div class="curve-axis">
              <span>0</span><span>40</span><span>60</span><span>100</span>
            </div>
          </div>
        </div>

        <div class="mini">
          <div class="mini-title">√çndices de validaci√≥n</div>
          <div class="ivline"><b>Incoherencia</b>: <span id="repIncoh">0%</span></div>
          <div class="ivline"><b>Contradicci√≥n</b>: <span id="repContra">0%</span></div>
          <div class="ivline"><b>Tiempo (PT)</b>: <span id="repTiempo">‚Äî</span></div>
<div class="val-note">
  Nota: estos indicadores eval√∫an consistencia y tiempo de respuesta. Si aparece ‚ÄúAlerta‚Äù, interpreta los resultados con mayor cautela.
</div>
<div class="muted val-note" id="ivNote" style="display:none">
  * √çndices calculados autom√°ticamente seg√∫n patr√≥n de respuesta.
</div>

        </div>
      </div>
    </div>

    <div class="cards2x2">
      <div class="card">
        <div class="card-label">Rectitud</div>
        <div class="card-score" id="pctRectitud">‚Äî</div>
      </div>
      <div class="card">
        <div class="card-label">Honestidad</div>
        <div class="card-score" id="pctHonestidad">‚Äî</div>
      </div>
      <div class="card">
        <div class="card-label">Justicia</div>
        <div class="card-score" id="pctJusticia">‚Äî</div>
      </div>
      <div class="card">
        <div class="card-label">Veracidad</div>
        <div class="card-score" id="pctVeracidad">‚Äî</div>
      </div>
    </div>

<div class="iviRow">
  <div class="iviLeft">
    <div class="iviCaption">INDICE DE VALORES E INTEGRIDAD</div>
    <div class="iviBox">
      <div class="iviTag">IVI</div>
      <div class="iviVal" id="repIVI">‚Äî</div>
    </div>
  </div>

  <div class="iviRight">
    <div class="iviLegend muted" id="iviLegend">La integridad de esta persona es:</div>

    <div class="seals" id="repSeals" aria-label="sellos">
      <img class="seal" data-i="1" src="/assets/adalam_mini.png" alt="Sello 1">
      <img class="seal" data-i="2" src="/assets/adalam_mini.png" alt="Sello 2">
      <img class="seal" data-i="3" src="/assets/adalam_mini.png" alt="Sello 3">
      <img class="seal" data-i="4" src="/assets/adalam_mini.png" alt="Sello 4">
    </div>
  </div>
</div>

    
<div class="iviSoft muted" id="iviSoftMsg">
  Este resultado es una referencia inicial. La interpretaci√≥n completa depende del √≠ndice de validaci√≥n y del contexto (etapa escolar o adulto/profesional).
  Revisa la Parte 2 para ver el significado detallado y recomendaciones.
</div>

<div class="starNote muted" id="starNote">
  <b>Sellos:</b> reflejan el nivel global (IVI) y la consistencia/coherencia de las respuestas (√≠ndices de validaci√≥n).
  A mayor n√∫mero de sellos, mayor solidez del perfil observado.
  <br><br>

  <div class="iviLevels muted" id="iviLevelsSoft">
  <div><b>1 sello:</b> Nivel inicial</div>
  <div><b>2 sellos:</b> Nivel en desarrollo</div>
  <div><b>3 sellos:</b> Nivel s√≥lido</div>
  <div><b>4 sellos:</b> Nivel destacado</div>
  <div class="iviLevelsNote">
    Nota: el significado detallado de cada nivel var√≠a seg√∫n la etapa (escolar o adulto/profesional) y se explica en la Parte 2.
  </div>
</div>

</div>



  </section>

  <!-- ===== PAGE 2+ (Interpretaci√≥n) ===== -->
  <section id="page2" class="page">
    <div class="rep-top">
  <div class="rep-head">
    <div class="rep-brand">
      <img id="brandLogo2" alt="ADALAM" src="assets/logo_adalam.png"
           onerror="this.style.display='none'" class="mhp-logo"/>
      <div>
        <div class="rep-title">INFORME E INTERPRETACI√ìN</div>
        <div class="rep-subtitle muted">REPORTE INDIVIDUAL DE INTEGRIDAD</div>
      </div>
    </div>
    <div class="rep-meta muted" id="repDateLine2">‚Äî</div>
  </div>

  <div class="rep-box" id="repHeaderBox2"></div>
</div>

<h2 style="margin-top:10px">1.- Interpretaci√≥n</h2>
  <p class="muted" style="margin-top:0">
    Esta secci√≥n describe tus resultados en  Integridad a partir de tus percentiles por subprueba y el IVI (promedio de las cuatro subpruebas).
  </p>

  <div class="interpGrid">
    <!-- Honestidad -->
    <div class="interpCard" data-skill="Honestidad">
      <div class="interpHead">
        <div>
          <div class="interpTitle">Honestidad</div>
          <div id="interpHonBadge" class="interpBadge">‚Äî</div>
        </div>
        <button class="interpToggle" type="button" aria-label="Expandir" data-target="interpHonBody">+</button>
      </div>
      <div id="interpHonBody" class="interpBody" style="display:none"></div>
    </div>

    <!-- Rectitud -->
    <div class="interpCard" data-skill="Rectitud">
      <div class="interpHead">
        <div>
          <div class="interpTitle">Rectitud</div>
          <div id="interpRecBadge" class="interpBadge">‚Äî</div>
        </div>
        <button class="interpToggle" type="button" aria-label="Expandir" data-target="interpRecBody">+</button>
      </div>
      <div id="interpRecBody" class="interpBody" style="display:none"></div>
    </div>

    <!-- Justicia -->
    <div class="interpCard" data-skill="Justicia">
      <div class="interpHead">
        <div>
          <div class="interpTitle">Justicia</div>
          <div id="interpJusBadge" class="interpBadge">‚Äî</div>
        </div>
        <button class="interpToggle" type="button" aria-label="Expandir" data-target="interpJusBody">+</button>
      </div>
      <div id="interpJusBody" class="interpBody" style="display:none"></div>
    </div>

    <!-- Veracidad -->
    <div class="interpCard" data-skill="Veracidad">
      <div class="interpHead">
        <div>
          <div class="interpTitle">Veracidad</div>
          <div id="interpVerBadge" class="interpBadge">‚Äî</div>
        </div>
        <button class="interpToggle" type="button" aria-label="Expandir" data-target="interpVerBody">+</button>
      </div>
      <div id="interpVerBody" class="interpBody" style="display:none"></div>
    </div>
  </div>

  <div class="iviBox" id="iviBox2" style="margin-top:14px">
    <div class="iviHead">
<div class="iviTitle">2.- Lectura global (IVI)</div>
    </div>
    <div class="iviRow">
      <div class="iviScore" id="iviScore2">‚Äî</div>
      <div class="iviText" id="iviText2"></div>

    <div class="iviGuide">
      <p class="iviGuideIntro"><b>¬øQu√© significa este cuadro?</b><br>
        Los <b>sellos</b> resumen el nivel general de integridad seg√∫n el <b>IVI</b>. Adem√°s, los indicadores de <b>incoherencia</b> y <b>contradicci√≥n</b> muestran qu√© tan consistentes fueron las respuestas: si aparecen alertas, el resultado se puede interpretar, pero <b>con m√°s cuidado</b>.
      </p>

      <div class="iviGuideTitle">Gu√≠a r√°pida por etapa (seg√∫n sellos)</div>

      <table class="iviGuideTable" aria-label="Gu√≠a de lectura por etapa seg√∫n sellos">
        <thead>
          <tr>
            <th>Sellos</th>
            <th>Secundaria / Preparatoria</th>
            <th>Adulto / Profesional</th>
          </tr>
        </thead>
        <tbody>
          <tr id="guideS1"><td><b>1 sello</b></td><td>Requiere acompa√±amiento</td><td>No recomendado</td></tr>
          <tr id="guideS2"><td><b>2 sellos</b></td><td>En formaci√≥n</td><td>Con reserva</td></tr>
          <tr id="guideS3"><td><b>3 sellos</b></td><td>√çntegro <span class="muted">(leer con m√°s cuidado)</span></td><td>Recomendable <span class="muted">(leer con m√°s cuidado)</span></td></tr>
          <tr id="guideS4"><td><b>4 sellos</b></td><td>Muy √≠ntegro</td><td>Muy recomendable</td></tr>
        </tbody>
      </table>

      <div class="muted" style="font-size:12px;margin-top:8px">
        Nota: Los √≠ndices de validaci√≥n (incoherencia y contradicci√≥n) indican cu√°nta confianza tener en la interpretaci√≥n.
      </div>
    </div>
    </div>
    <div class="muted" style="font-size:12px;margin-top:10px">
      Nota: Si los √≠ndices de validaci√≥n no est√°n disponibles, el reporte calcula las estrellas solo con el IVI.
    </div>
  </div>

  <!-- ===== PARTE 2 (robusta) ===== -->
  <div id="perfilGlobal" class="interp-bloque" style="margin-top:14px"></div>
  <div id="recomendaciones" class="interp-bloque"></div>
  <div id="planAccion" class="interp-bloque"></div>
</section>
</div>

<script>
  const $ = sel => document.querySelector(sel);
  function clamp(n,min,max){ return Math.max(min,Math.min(max,n)); }
  function normalizeName(name){ return (name||"").replace(/\s+/g," ").trim().toLowerCase(); }

  // Alias de nombres de bloques: permite que el reporte muestre los NUEVOS t√≠tulos,
  // pero siga encontrando los datos aunque vengan con nombres anteriores en la BD/API.
  const BLOQUE_ALIAS = {
    // Nuevos -> antiguos (normalizados)
    "desarrollo personal": "habilidades intrapersonales",
    "v√≠nculos interpersonales": "habilidades interpersonales",
    "vinculos interpersonales": "habilidades interpersonales",
    "competencias para la vida": "habilidades para la vida",
    "comunicaci√≥n interpersonal": "estilos de comunicaci√≥n interpersonal",
    "comunicacion interpersonal": "estilos de comunicaci√≥n interpersonal",
    "adaptaci√≥n al cambio": "propensi√≥n al cambio",
    "adaptacion al cambio": "propensi√≥n al cambio"
  };

  function canonBloque(name){
    const n = normalizeName(name);
    return BLOQUE_ALIAS[n] || n;
  }


  const DISPLAY = {
    bloque: {
      "desarrollo personal": "DESARROLLO PERSONAL",
      "v√≠nculos interpersonales": "VINCULOS INTERPERSONALES",
      "competencias para la vida": "HABILIDADES PARA LA VIDA",
      "estilos de comunicaci√≥n interpersonal": "COMUNICACI√ìN INTERPERSONAL",
      "propensi√≥n al cambio": "ADAPTACI√ìN AL CAMBIO",

      "habilidades intrapersonales": "DESARROLLO PERSONAL",
    "habilidades interpersonales": "VINCULOS INTERPERSONALES",
    "habilidades para la vida": "HABILIDADES PARA LA VIDA"
    },
    sub: {}
  };
  // sub mapping (normalizado, sin tildes) construido en runtime:
  (function(){
    const src = {"autoestima": "Autoestima", "manejo de la tension": "Manejo de Estr√©s", "manejo de la tensi√≥n": "Manejo de Estr√©s", "bienestar fisico": "H√°bitos Saludables", "bienestar f√≠sico": "H√°bitos Saludables", "asertividad": "Expresi√≥n Asertiva", "conciencia de los demas": "Percepci√≥n de los Dem√°s", "conciencia de los dem√°s": "Percepci√≥n de los Dem√°s", "empatia": "Sensibilidad Emp√°tica", "empat√≠a": "Sensibilidad Emp√°tica", "motivacion": "Motivaci√≥n Interna", "motivaci√≥n": "Motivaci√≥n Interna", "compromiso": "Nivel de Compromiso", "administracion del tiempo": "Organizaci√≥n del Tiempo", "administraci√≥n del tiempo": "Organizaci√≥n del Tiempo", "toma de decisiones": "Toma de Decisiones", "toma de desiciones": "Toma de Decisiones", "liderazgo": "Liderazgo", "propensi√≥n al cambio": "Adaptaci√≥n al cambio", "propension al cambio": "Adaptaci√≥n al cambio"};
    const strip = s => (s||"").normalize("NFD").replace(/\p{Diacritic}/gu,"");
    for (const [k,v] of Object.entries(src)) {
      DISPLAY.sub[k] = v;
    }
    DISPLAY._strip = strip;
  })();
function dispBloque(name){
  const canon = canonBloque(name);      // convierte lo que venga a nombre can√≥nico (BD)
  return DISPLAY.bloque[canon] || name; // devuelve el nombre NUEVO si existe
}

  function dispSub(name){
    const strip = DISPLAY._strip;
    const k = strip(normalizeName(name));
    return DISPLAY.sub[k] || name;
  }

  /* Ajuste visual -10 (solo visual, no BD) */
  const SCORE_ADJUST = { ENABLED:true, OFFSET:10, APPLY_TO_RISK:true };
  function isRiskScale(bloqueNorm, subNorm){
    const b = canonBloque(bloqueNorm || "");
    const s = normalizeName(subNorm || "");
    return (b === normalizeName("estilos de comunicaci√≥n interpersonal") && (s === "agresi√≥n" || s === "timidez"));
  }
  function adjScore(v, {bloqueNorm=null, subNorm=null}={}){
    const n = Number(v);
    if(!Number.isFinite(n)) return v;
    if(n<=0) return n;
    if(!SCORE_ADJUST.ENABLED) return Math.round(n);
    if(isRiskScale(bloqueNorm||"", subNorm||"") && !SCORE_ADJUST.APPLY_TO_RISK){
      return clamp(Math.round(n),1,100);
    }
    return clamp(Math.round(n - SCORE_ADJUST.OFFSET),1,100);
  }

  function rangoBadge(p){
    // Integridad (manual): 0‚Äì39 / 40‚Äì60 / 61‚Äì100
    if (p<=39) return {txt:"0‚Äì39 Requiere acompa√±amiento", cls:"b-red"};
    if (p<=60) return {txt:"40‚Äì60 En formaci√≥n", cls:"b-orange"};
    return {txt:"61‚Äì100 √çntegro", cls:"b-green"};
  }
  function rangoBadgeRiesgo(p){
    if (p<=40) return {txt:"1‚Äì40 Bajo riesgo", cls:"b-green"};
    if (p<=70) return {txt:"41‚Äì70 Riesgo medio", cls:"b-orange"};
    return {txt:"71‚Äì100 Riesgo alto", cls:"b-red"};
  }

  function highlightIV(rowId, colIndex){
    const row = document.getElementById(rowId);
    if(!row) return;
    [...row.children].forEach(td=>td.classList.remove("hl"));
    const idx = Math.max(1, Math.min(3, colIndex|0));
    const td = row.children[idx];
    if(td) td.classList.add("hl");
  }

  function ivToCol(v){
    if (v === null || v === undefined) return 2;
    const n = Number(v);
    if (!Number.isNaN(n)){
      if (n === 0 || n === 1 || n === 2) return n + 1;
      if (Number.isInteger(n) && n>=1 && n<=3) return n;
      if (n >= 0 && n <= 100){
        if (n >= 71) return 1;
        if (n >= 41) return 2;
        return 3;
      }
    }
    const s = String(v).toLowerCase();
    if (s.includes("no se contradice") || s.includes("tom√≥ el tiempo adecuado") || s.includes("tiempo adecuado")) return 1;
    if (s.includes("se contradice frecuentemente") || s.includes("demasiado lento")) return 3;
    return 2;
  }

  function drawBellCurve(){
    const path = document.getElementById("bellPath");
    const fill = document.getElementById("bellFill");
    if(!path || !fill) return;
    const left=10, right=510, baseY=100, topY=18;
    const mid=(left+right)/2, sigma=90;
    const pts=[];
    for(let x=left; x<=right; x+=5){
      const z=(x-mid)/sigma;
      const y = baseY - Math.exp(-0.5*z*z)*(baseY-topY);
      pts.push([x,y]);
    }
    let d=`M${pts[0][0].toFixed(1)} ${pts[0][1].toFixed(1)}`;
    for(let i=1;i<pts.length;i++) d += ` L${pts[i][0].toFixed(1)} ${pts[i][1].toFixed(1)}`;
    path.setAttribute("d", d);
    const df = d + ` L${right} ${baseY} L${left} ${baseY} Z`;
    fill.setAttribute("d", df);
  }

  function setCurveMarker(iie){
    drawBellCurve();
    const left=10, right=510, baseY=100, topY=18, mid=260, sigma=90;
    const score = clamp(Number(iie)||0,1,100);
    const x = left + (score-1)/99*(right-left);
    const z=(x-mid)/sigma;
    const y = baseY - Math.exp(-0.5*z*z)*(baseY-topY);
    const dot = document.getElementById("curveMarker");
    if(dot){ dot.setAttribute("cx", x); dot.setAttribute("cy", y); }
  }

  function addRow(container, name, pct){
    const row=document.createElement('div');
    row.style.display='grid';
    row.style.gridTemplateColumns='220px 1fr 1fr 1fr';
    row.style.alignItems='center';
    row.style.gap='6px';
    row.style.margin='2px 0';

    const nameCell=document.createElement('div');
    nameCell.textContent=dispSub(name);
    nameCell.style.fontWeight='700';
    nameCell.style.fontSize='12px';
    row.appendChild(nameCell);

    for(let i=0;i<3;i++){ 
      const track=document.createElement('div');
      track.style.position='relative';
      track.style.height='14px';
      track.style.border='1px solid #aab';
      track.style.borderRadius='4px';
      track.style.background='#f3f5f8';
      track.style.overflow='hidden';

      const fill=document.createElement('div');
      fill.style.position='absolute';
      fill.style.left='0';
      fill.style.top='0';
      fill.style.bottom='0';
      fill.style.background='#6b7280';

      let w=0;
      if(i===0 && pct<=40)  w = Math.max(2, Math.round((pct/40)*100));
      if(i===1 && pct>40 && pct<=70) w = Math.max(2, Math.round(((pct-40)/30)*100));
      if(i===2 && pct>70)  w = Math.max(2, Math.round(((pct-70)/30)*100));
      fill.style.width = w + '%';
      track.appendChild(fill);
      row.appendChild(track);
    }
    container.appendChild(row);
  }

  function buildBloque(containerId, subRows, bloqueNombre){
    const cont = document.getElementById(containerId);
    if(!cont) return;
    cont.innerHTML = '';

    const cols = document.createElement('div');
    cols.style.display='grid';
    cols.style.gridTemplateColumns='220px 1fr 1fr 1fr';
    cols.style.gap='6px';
    cols.style.marginBottom='6px';

    const blank=document.createElement('div');
    cols.appendChild(blank);

    ['POR DESARROLLAR','POR FORTALECER','POR ENRIQUECER'].forEach(t=>{
      const d=document.createElement('div');
      d.style.fontSize='11px';
      d.style.textAlign='center';
      d.style.color='#374151';
      d.textContent=t;
      cols.appendChild(d);
    });
    cont.appendChild(cols);

    const bloqueKey = canonBloque(bloqueNombre);
    const ordenes = {
      "desarrollo personal": ["Autoestima","Manejo de Estr√©s","H√°bitos Saludables"],
      "v√≠nculos interpersonales": ["Expresi√≥n Asertiva","Percepci√≥n de los Dem√°s","Sensibilidad Emp√°tica"],
      "competencias para la vida": ["Motivaci√≥n Interna","Nivel de Compromiso","Organizaci√≥n del Tiempo","Toma de Decisiones","Liderazgo"]
    };

    let rowsFiltradas = (subRows||[]).filter(r=> canonBloque(r.bloque||r.block||"")===bloqueKey);

    const orden = ordenes[bloqueKey];
    if (orden){
      rowsFiltradas.sort((a,b)=>{
        const nameA = (a.subhabilidad || a.sub || a.nombre || "").toLowerCase();
        const nameB = (b.subhabilidad || b.sub || b.nombre || "").toLowerCase();
        const ia = orden.findIndex(x=> x.toLowerCase()===nameA);
        const ib = orden.findIndex(x=> x.toLowerCase()===nameB);
        if (ia===-1 && ib===-1) return nameA.localeCompare(nameB);
        if (ia===-1) return 1;
        if (ib===-1) return -1;
        return ia-ib;
      });
    }

    rowsFiltradas.forEach(r=>{
      const sub = r.subhabilidad || r.sub || r.nombre || "";
      const pctRaw = Math.round(r.percent ?? r.pct ?? r.porcentaje ?? 0);
      const pct = adjScore(pctRaw, {bloqueNorm: bloqueKey, subNorm: normalizeName(sub)});
      addRow(cont, sub, pct);
    });
  }

  function renderBars(containerId, items, showNote){
    const host = document.getElementById(containerId);
    if (!host) return;
    host.innerHTML = "";
    const wrap = document.createElement("div");
    wrap.className = "bars-wrap";

    items.forEach(it => {
      const row = document.createElement("div");
      row.className = "bars-row";

      // Separaci√≥n visual entre Agresi√≥n y Timidez
      if (it.label === "TIMIDEZ") {
        row.style.marginTop = "20px";
      }

      const label = document.createElement("div");
      label.className = "label";
      label.textContent = it.label + " (10‚Äì100)";
      row.appendChild(label);

      const slot = document.createElement("div");
      slot.className = "bars-slot";

      [10,40,70,100].forEach(v => {
        const pct = (v - 10) / 90 * 100;
        const tick = document.createElement("div");
        tick.className = "tick";
        tick.style.left = pct + "%";
        slot.appendChild(tick);

        const tLabel = document.createElement("div");
        tLabel.className = "tick-label";
        tLabel.style.left = pct + "%";
        tLabel.textContent = v;
        slot.appendChild(tLabel);
      });

      const marker = document.createElement("div");
      marker.className = "marker";
      marker.id = it.id;
      marker.style.display = "none";
      slot.appendChild(marker);

      row.appendChild(slot);
      wrap.appendChild(row);
    });

    host.appendChild(wrap);

    // Nota SOLO para la P√°gina 1 (no alertas rojas aqu√≠)
    if (showNote) {
      const note = document.createElement("div");
      note.className = "scale-note-inline";
      note.textContent = "Un puntaje bajo indica mejor manejo en estas √°reas.";
      host.appendChild(note);
    }
  }

  function setMarker(id, val){
    const el = document.getElementById(id);
    if(!el) return;
    if(val==null || isNaN(val)) { el.style.display="none"; return; }
    const pct = (clamp(val,10,100)-10)/90*100;
    el.style.left = pct + "%";
    el.style.display="block";
  }

  function renderPage2(subRows){
    const subT = document.querySelector("#subTable tbody");
    subT.innerHTML = "";
    (subRows||[]).forEach(r=>{
      const bloque = r.bloque || r.block || "";
      const sub = r.subhabilidad || r.sub || "";
      const items = r.items ?? r.n_items ?? "";
      const puntos = r.puntos ?? r.points ?? r.pts ?? "";
      const pctRaw = Math.round(r.percent ?? r.pct ?? 0);

      const bloqueNorm = canonBloque(bloque);
      const subNorm = normalizeName(sub);

      const pct = adjScore(pctRaw, {bloqueNorm, subNorm});

      let badge;
      if (isRiskScale(bloqueNorm, subNorm)) badge = rangoBadgeRiesgo(pct);
      else badge = rangoBadge(pct);

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${dispBloque(bloque)}</td>
        <td>${dispSub(sub)}</td>
        <td>${items}</td>
        <td>${puntos}</td>
        <td><b>${pct}%</b></td>
        <td><span class="badge ${badge.cls}">${badge.txt}</span></td>
      `;
      subT.appendChild(tr);
    });
  }

  function findSubPct(subRows, bloqueNombre, subNombre){
    const bloqueKey = canonBloque(bloqueNombre);
    const subKey = normalizeName(subNombre);
    const row = (subRows || []).find(r =>
      canonBloque(r.bloque || r.block || "") === bloqueKey &&
      normalizeName(r.subhabilidad || r.sub || r.nombre || "") === subKey
    );
    if(!row) return null;
    const vRaw = Number(row.percent ?? row.pct ?? row.porcentaje ?? row.value);
    if(Number.isNaN(vRaw)) return null;
    return adjScore(vRaw, {bloqueNorm: bloqueKey, subNorm: subKey});
  }

  const BLOQUE_DESCS = {
    desarrollo: "El desarrollo personal re√∫ne capacidades para comprenderse, regularse y cuidarse. Incluye la forma en que la persona se percibe (autoestima), maneja el estr√©s y sostiene h√°bitos de h√°bitos saludables.",
    vinculos: "Los v√≠nculos interpersonales agrupan habilidades para relacionarse de manera respetuosa y efectiva. Incluye la capacidad de vincularse, percibir a los dem√°s y responder con sensibilidad emp√°tica.",
    competencias: "Las competencias para la vida son destrezas que favorecen el funcionamiento cotidiano y el logro de metas. Incluye motivaci√≥n interna, compromiso, organizaci√≥n del tiempo, toma de decisiones y liderazgo.",
    comunicacion: "La comunicaci√≥n interpersonal describe estilos de interacci√≥n. En Agresi√≥n y Timidez la interpretaci√≥n es inversa: puntajes bajos sugieren mejor manejo, mientras que puntajes altos indican mayor riesgo y requieren observaci√≥n y apoyo.",
    adaptacion: "La adaptaci√≥n al cambio refleja la apertura y flexibilidad para ajustarse a situaciones nuevas, aceptar transformaciones y promover cambios positivos en el entorno."
  };

  const HABILIDAD_DESCS = {
    "Autoestima": "Es la percepci√≥n que una persona tiene de s√≠ misma: c√≥mo se describe, qu√© cree que puede lograr y c√≥mo interpreta sus propias capacidades.",
    "Manejo del Estr√©s": "Capacidad para reconocer se√±ales de tensi√≥n, regular la respuesta emocional y utilizar estrategias saludables para afrontar presi√≥n, frustraci√≥n o incertidumbre.",
    "Manejo de Estr√©s": "Capacidad para reconocer se√±ales de tensi√≥n, regular la respuesta emocional y utilizar estrategias saludables para afrontar presi√≥n, frustraci√≥n o incertidumbre.",
    "H√°bitos Saludables": "Conjunto de h√°bitos y decisiones orientadas a cuidar el bienestar f√≠sico y mental (sue√±o, alimentaci√≥n, movimiento, higiene, descanso y l√≠mites saludables).",

    "Expresi√≥n Asertiva": "Habilidad para construir relaciones positivas, cooperar, resolver desacuerdos y mantener una convivencia respetuosa.",
    "Percepci√≥n de los Dem√°s": "Capacidad de observar y comprender se√±ales sociales y emocionales en otras personas (gestos, tono, intenci√≥n) para relacionarse con mayor ajuste.",
    "Sensibilidad Emp√°tica": "Capacidad de ponerse en el lugar del otro, comprender c√≥mo se siente y responder con consideraci√≥n y apoyo cuando corresponde.",

    "Motivaci√≥n Interna": "Impulso personal para iniciar y sostener acciones hacia metas, incluso cuando hay dificultad, manteniendo inter√©s y esfuerzo.",
    "Nivel de Compromiso": "Grado en que la persona asume responsabilidades, cumple acuerdos y mantiene constancia con lo que decide o promete.",
    "Organizaci√≥n del Tiempo": "Capacidad de planificar, priorizar y distribuir el tiempo para cumplir tareas y objetivos, evitando la postergaci√≥n excesiva.",
    "Toma de Decisiones": "Proceso de analizar alternativas, evaluar consecuencias y elegir la opci√≥n m√°s adecuada para resolver problemas o alcanzar objetivos.",
    "Liderazgo": "Capacidad de influir de manera positiva, coordinar esfuerzos, motivar a otros y tomar iniciativa para lograr metas comunes.",

    "Agresi√≥n": "Tendencia a responder de forma hostil o impulsiva (verbal, f√≠sica o emocional) ante conflictos o frustraci√≥n.",
    "Timidez": "Tendencia a inhibirse o evitar interacci√≥n social por inseguridad, temor a la evaluaci√≥n o dificultad para expresarse.",
    "Adaptaci√≥n al cambio": "Apertura para adaptarse a nuevas condiciones, ideas o rutinas, ajustando conductas y estrategias cuando el contexto lo requiere."
  };

  const DATA_BLOQUE_POR_TITULO = {
    "DESARROLLO PERSONAL": "Habilidades intrapersonales",
    "VINCULOS INTERPERSONALES": "Habilidades interpersonales",
    "HABILIDADES PARA LA VIDA": "Habilidades para la vida",
    "COMUNICACI√ìN INTERPERSONAL": "Estilos de comunicaci√≥n interpersonal",
    "ADAPTACI√ìN AL CAMBIO": "Propensi√≥n al cambio"
  };

  const SUB_DISPLAY = {
    "Autoestima": "Autoestima",
    "Asertividad": "Expresi√≥n Asertiva",
    "Conciencia de los dem√°s": "Percepci√≥n de los Dem√°s",
    "Empat√≠a": "Sensibilidad Emp√°tica",
    "Compromiso": "Nivel de Compromiso",
    "Motivaci√≥n": "Motivaci√≥n Interna",
    "Liderazgo": "Liderazgo",
    "Manejo de la Tensi√≥n": "Manejo del Estr√©s",
    "Manejo de la tensi√≥n": "Manejo del Estr√©s",
    "Administraci√≥n del tiempo": "Organizaci√≥n del Tiempo",
    "Toma de Decisiones": "Decisi√≥n y Elecci√≥n",
    "Toma de decisiones": "Decisi√≥n y Elecci√≥n",
    "Bienestar f√≠sico": "H√°bitos Saludables",
    "Propensi√≥n al cambio": "Adaptaci√≥n al cambio",
    "Agresi√≥n": "Agresi√≥n",
    "Timidez": "Timidez"
  };

  function dispSub(n){
    const key = (n||"").trim();
    return SUB_DISPLAY[key] || key;
  }

  function renderSkillRow(parent, nombre, pct){
    const row = document.createElement("div");
    row.className = "skill-row";

    const title = document.createElement("div");
    title.className = "skill-row-title";
    const numeric = (pct != null && !Number.isNaN(Number(pct))) ? Math.round(pct) : null;
    const nombreDisp = dispSub(nombre);
    title.textContent = numeric != null ? `${nombreDisp} (Puntaje: ${numeric}/100)` : nombreDisp;
    row.appendChild(title);

    const descTxt =
  HABILIDAD_DESCS[nombreDisp] ||
  HABILIDAD_DESCS[nombre] ||
  HABILIDAD_DESCS[Object.keys(SUB_DISPLAY).find(k => SUB_DISPLAY[k] === nombre)] ||
  "";

    if(descTxt){
      const desc = document.createElement("div");
      desc.className = "skill-row-desc";
      desc.textContent = descTxt;
      row.appendChild(desc);
    }

    const bar = document.createElement("div");
    bar.className = "skill-bar";

    const track = document.createElement("div");
    track.className = "skill-bar-track";

    const isAggOrTim = (nombre === "Agresi√≥n" || nombre === "Timidez");
    if (isAggOrTim){
      track.style.background =
        "linear-gradient(to right,var(--green) 0%, var(--green) 40%,var(--orange) 40%, var(--orange) 70%,var(--red) 70%, var(--red) 100%)";
    }

    const marker = document.createElement("div");
    marker.className = "skill-bar-marker";
    if(numeric == null) marker.style.display = "none";
    else marker.style.left = clamp(numeric,1,100) + "%";
    track.appendChild(marker);

    const value = document.createElement("div");
    value.className = "skill-bar-value";
    value.textContent = numeric != null ? `${numeric} / 100` : "‚Äî";

    bar.appendChild(track);
    bar.appendChild(value);
    row.appendChild(bar);

    parent.appendChild(row);
  }

  function nivelFromPct(p){
    if(p == null || Number.isNaN(p)) return "medio";
    if(p <= 39) return "bajo";
    if(p <= 60) return "medio";
    return "alto";
  }

  const RECOM_BLOQUES = {
    intra: {
      bajo: ["Fortalecer rutinas de h√°bitos saludables y autoconfianza.","Practicar t√©cnicas breves de regulaci√≥n emocional (respiraci√≥n, pausas)."],
      medio: ["Consolidar h√°bitos de h√°bitos saludables y reconocer logros alcanzados.","Aplicar estrategias de manejo del estr√©s en momentos demandantes."],
      alto: ["Proponer metas personales desafiantes y realistas.","Modelar h√°bitos positivos de h√°bitos saludables y regulaci√≥n emocional."]
    },
    inter: {
      bajo: ["Practicar comunicaci√≥n asertiva con mensajes en primera persona.","Realizar din√°micas guiadas para desarrollar conciencia social y empat√≠a."],
      medio: ["Reforzar escucha activa y respeto por turnos de palabra.","Reconocer conductas prosociales y cooperaci√≥n."],
      alto: ["Asignar roles de mediaci√≥n o apoyo entre pares.","Participar en actividades de convivencia y liderazgo positivo."]
    },
    vida: {
      bajo: ["Apoyar planificaci√≥n diaria con pasos simples y recordatorios.","Acompa√±ar toma de decisiones con an√°lisis de consecuencias."],
      medio: ["Estimular organizaci√≥n del tiempo y cumplimiento de tareas.","Ofrecer roles peque√±os de iniciativa y liderazgo con supervisi√≥n."],
      alto: ["Asignar responsabilidades estables para potenciar liderazgo.","Involucrar en proyectos donde organice y coordine acciones."]
    }
  };

  function renderRecomendaciones(extras){
    const cont = document.getElementById("recomendaciones");
    if(!cont) return;
    cont.innerHTML = "";

    const header = document.createElement("div");
    header.className = "interp-bloque-header";
    header.innerHTML = `<div class="interp-bloque-nombre">4.- Recomendaciones y plan de acci√≥n</div>`;
    cont.appendChild(header);

    const sub = document.createElement("div");
    sub.className = "recom-subtitle";
    sub.textContent = "Las siguientes recomendaciones se generan a partir de los puntajes obtenidos y pueden usarse como gu√≠a inicial de acompa√±amiento.";
    cont.appendChild(sub);

    const lista = document.createElement("ul");
    lista.className = "recom-list";

    const nIntra = nivelFromPct(extras.bIntra);
    const nInter = nivelFromPct(extras.bInter);
    const nPV    = nivelFromPct(extras.bPV);

    (RECOM_BLOQUES.intra[nIntra] || []).forEach(t=>{ const li=document.createElement("li"); li.textContent = "DESARROLLO PERSONAL: " + t; lista.appendChild(li); });
    (RECOM_BLOQUES.inter[nInter] || []).forEach(t=>{ const li=document.createElement("li"); li.textContent = "VINCULOS INTERPERSONALES: " + t; lista.appendChild(li); });
    (RECOM_BLOQUES.vida[nPV] || []).forEach(t=>{ const li=document.createElement("li"); li.textContent = "HABILIDADES PARA LA VIDA: " + t; lista.appendChild(li); });

    if(extras.agresionVal != null && extras.agresionVal > 70){
      const li=document.createElement("li");
      li.textContent = "COMUNICACI√ìN INTERPERSONAL (Agresi√≥n): trabajar control de impulsos y alternativas para expresar enojo sin da√±ar a otros.";
      lista.appendChild(li);
    }
    if(extras.timidezVal != null && extras.timidezVal > 70){
      const li=document.createElement("li");
      li.textContent = "COMUNICACI√ìN INTERPERSONAL (Timidez): favorecer participaci√≥n gradual en actividades grupales con apoyo de un adulto.";
      lista.appendChild(li);
    }
    if(extras.propCambioVal != null){
      if(extras.propCambioVal <= 40){
        const li=document.createElement("li");
        li.textContent = "ADAPTACI√ìN AL CAMBIO: acompa√±ar procesos de cambio con anticipaci√≥n y tiempos de adaptaci√≥n.";
        lista.appendChild(li);
      } else if(extras.propCambioVal >= 71){
        const li=document.createElement("li");
        li.textContent = "ADAPTACI√ìN AL CAMBIO: aprovechar apertura para proyectos innovadores e iniciativas de mejora.";
        lista.appendChild(li);
      }
    }

    cont.appendChild(lista);
  }

  function renderPlanAccion(extras){
    const cont = document.getElementById("planAccion");
    if(!cont) return;
    cont.innerHTML = "";

    const header=document.createElement("div");
    header.className="interp-bloque-header";
    header.innerHTML = `<div class="interp-bloque-nombre">Plan de acci√≥n sugerido</div>`;
    cont.appendChild(header);

    const sub=document.createElement("div");
    sub.className="recom-subtitle";
    sub.textContent="Orientaciones generales para acompa√±ar el desarrollo socioemocional. No reemplaza valoraci√≥n cl√≠nica.";
    cont.appendChild(sub);

    const mkList=(title, items)=>{
      const t=document.createElement("div"); t.className="plan-section-title"; t.textContent=title; cont.appendChild(t);
      const ul=document.createElement("ul"); ul.className="recom-list";
      items.forEach(x=>{ const li=document.createElement("li"); li.textContent=x; ul.appendChild(li); });
      cont.appendChild(ul);
    };

    mkList("En el hogar / familia:", [
      "Conversar diariamente sobre emociones y experiencias del d√≠a (validaci√≥n).",
      "Reconocer esfuerzos y avances con mensajes concretos.",
      "Mantener rutinas claras de estudio, descanso y ocio."
    ]);

    mkList("En el aula / instituci√≥n educativa:", [
      "Promover respeto, colaboraci√≥n y expresi√≥n emocional adecuada.",
      "Observar conductas socioemocionales relevantes y coordinar con la familia.",
      "Incluir actividades breves de educaci√≥n emocional."
    ]);

    mkList("Con apoyo del orientador / psic√≥logo:", [
      "Si las dificultades se sostienen o son intensas, considerar evaluaci√≥n m√°s profunda y acompa√±amiento especializado.",
      "Mantener comunicaci√≥n peri√≥dica entre familia y escuela para alinear estrategias."
    ]);

    const foot=document.createElement("div");
    foot.style.textAlign="right";
    foot.style.fontSize="10px";
    foot.style.color="var(--muted)";
    foot.style.marginTop="8px";
    foot.textContent="IPLAED CORP 2025";
    cont.appendChild(foot);
  }

  function renderPerfilGlobal(extras){
    const cont = document.getElementById("perfilGlobal");
    if(!cont) return;
    cont.innerHTML = "";

    const header = document.createElement("div");
    header.className = "interp-bloque-header";
    header.innerHTML = `<div class="interp-bloque-nombre">3.- Perfil cuantitativo global</div>`;
    cont.appendChild(header);

    const p = document.createElement("div");
    p.className = "interp-bloque-desc";
    const nombre = extras.nombre || "el participante";
    p.textContent = `Del reporte individual de ${nombre} se desprenden los siguientes √≠ndices:`;
    cont.appendChild(p);

    const ul = document.createElement("ul");
    ul.className = "recom-list";

    const fmt = v => (v != null && !Number.isNaN(v)) ? Math.round(v) : "‚Äî";

    [
      `√çndice de Desarrollo Personal: ${fmt(extras.bIntra)}`,
      `√çndice de V√≠nculos Interpersonales: ${fmt(extras.bInter)}`,
      `√çndice de Habilidades para la Vida: ${fmt(extras.bPV)}`,
      `√çndice Global de Inteligencia Emocional (IIE): ${fmt(extras.iieFinal)}`
    ].forEach(t=>{
      const li = document.createElement("li");
      li.textContent = t;
      ul.appendChild(li);
    });

    cont.appendChild(ul);

    const subt = document.createElement("div");
    subt.className = "plan-section-title";
    subt.textContent = "Comunicaci√≥n interpersonal (en estas escalas puntajes bajos indican mejor manejo):";
    cont.appendChild(subt);

    const ul2 = document.createElement("ul");
    ul2.className = "recom-list";

    const liA = document.createElement("li");
    liA.textContent = "Agresi√≥n: " + fmt(extras.agresionVal);
    if (extras.agresionVal != null && !Number.isNaN(extras.agresionVal) && extras.agresionVal > 70){
      liA.classList.add("skill-row-alert");
      liA.textContent += " (rango alto, requiere atenci√≥n y acompa√±amiento).";
    }
    ul2.appendChild(liA);

    const liT = document.createElement("li");
    liT.textContent = "Timidez: " + fmt(extras.timidezVal);
    if (extras.timidezVal != null && !Number.isNaN(extras.timidezVal) && extras.timidezVal > 70){
      liT.classList.add("skill-row-alert");
      liT.textContent += " (rango alto, sugiere inhibici√≥n social significativa).";
    }
    ul2.appendChild(liT);

    cont.appendChild(ul2);

    const subt2 = document.createElement("div");
    subt2.className = "plan-section-title";
    subt2.textContent = "Adaptaci√≥n al cambio:";
    cont.appendChild(subt2);

    const ul3 = document.createElement("ul");
    ul3.className = "recom-list";
    const liC = document.createElement("li");
    liC.textContent = "Adaptaci√≥n al cambio: " + fmt(extras.propCambioVal) + " (a mayor puntaje, mayor apertura al cambio).";
    ul3.appendChild(liC);
    cont.appendChild(ul3);
  }

  function renderBloqueInterpretacion(containerId, tituloDisplay, bloqueKeyOriginal, bloqueDescKey, subRows, pctBloqueVal){
    const cont=document.getElementById(containerId);
    if(!cont) return;
    cont.innerHTML="";

    const idxText=(pctBloqueVal!=null && !Number.isNaN(pctBloqueVal)) ? pctBloqueVal : "‚Äî";
    const header=document.createElement("div");
    header.className="interp-bloque-header";
    header.innerHTML=`<div class="interp-bloque-nombre">${tituloDisplay}</div><div class="interp-bloque-indice">√çndice: <span>${idxText}</span></div>`;
    cont.appendChild(header);

    const desc=document.createElement("div");
    desc.className="interp-bloque-desc";
    desc.textContent=BLOQUE_DESCS[bloqueDescKey] || "";
    cont.appendChild(desc);

    const bloqueKey = canonBloque(bloqueKeyOriginal);
    let rows=(subRows||[]).filter(r=> canonBloque(r.bloque||r.block||"")===bloqueKey);

    rows.forEach(r=>{
      const sub=r.subhabilidad || r.sub || r.nombre || "";
      const pctRaw=Number(r.percent ?? r.pct ?? r.porcentaje ?? r.value ?? null);
      const pct=(pctRaw!=null && !Number.isNaN(pctRaw)) ? adjScore(pctRaw, {bloqueNorm: bloqueKey, subNorm: normalizeName(sub)}) : null;
      renderSkillRow(cont, dispSub(sub), pct);
    });
  }

  function renderInterpretacion(subRows, extras){
    const date1=document.getElementById("repDateLine");
    const date2=document.getElementById("repDateLine2");
    const dateEsc=document.getElementById("repDateLineEsc");
    if(date1 && date2) date2.textContent = date1.textContent;
    if(date1 && dateEsc) dateEsc.textContent = date1.textContent;

    const h1=document.getElementById("repHeaderBox");
    const h2=document.getElementById("repHeaderBox2");
    if(h1 && h2) h2.innerHTML = h1.innerHTML;

    renderBloqueInterpretacion("interpIntra","DESARROLLO PERSONAL","Desarrollo Personal","desarrollo", subRows, extras.bIntra);
    renderBloqueInterpretacion("interpInter","VINCULOS INTERPERSONALES","V√≠nculos Interpersonales","vinculos", subRows, extras.bInter);
    renderBloqueInterpretacion("interpPV","HABILIDADES PARA LA VIDA","Competencias Para la Vida","competencias", subRows, extras.bPV);

    const estCont=document.getElementById("interpEstilos");
    if(estCont){
      estCont.innerHTML="";
      const header=document.createElement("div");
      header.className="interp-bloque-header";
      header.innerHTML=`<div class="interp-bloque-nombre">COMUNICACI√ìN INTERPERSONAL</div>`;
      estCont.appendChild(header);

      const desc=document.createElement("div");
      desc.className="interp-bloque-desc";
      desc.textContent=BLOQUE_DESCS.estilos;
      estCont.appendChild(desc);

      renderSkillRow(estCont, "Agresi√≥n", extras.agresionVal);
      renderSkillRow(estCont, "Timidez", extras.timidezVal);
    }

    const cambCont=document.getElementById("interpCambio");
    if(cambCont){
      cambCont.innerHTML="";
      const header=document.createElement("div");
      header.className="interp-bloque-header";
      header.innerHTML=`<div class="interp-bloque-nombre">ADAPTACI√ìN AL CAMBIO</div>`;
      cambCont.appendChild(header);

      const desc=document.createElement("div");
      desc.className="interp-bloque-desc";
      desc.textContent=BLOQUE_DESCS.cambio;
      cambCont.appendChild(desc);

      renderSkillRow(cambCont, "Adaptaci√≥n al cambio", extras.propCambioVal);
    }

    renderPerfilGlobal(extras);
    renderRecomendaciones(extras);
    renderPlanAccion(extras);
  }

  

  // ================================
  // PARTE 2 (INTEGRIDAD) - robusta
  // ================================

  function escapeHtml(s){
    return String(s ?? "")
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#39;");
  }

  const INTEGRIDAD_SKILLS = [
    {key:"Honestidad", idBadge:"interpHonBadge", idBody:"interpHonBody"},
    {key:"Rectitud",   idBadge:"interpRecBadge", idBody:"interpRecBody"},
    {key:"Justicia",   idBadge:"interpJusBadge", idBody:"interpJusBody"},
    {key:"Veracidad",  idBadge:"interpVerBadge", idBody:"interpVerBody"},
  ];

  const INTEGRIDAD_DESC = {
    "Honestidad": "Se refiere a actuar con transparencia, reconocer errores y evitar beneficios injustos. Implica coherencia entre lo que se piensa, se dice y se hace.",
    "Rectitud": "Capacidad de sostener principios √©ticos aun cuando hay presi√≥n externa. Incluye autocontrol, respeto por normas y consistencia conductual.",
    "Justicia": "Tendencia a decidir y actuar considerando equidad, reglas claras y trato imparcial. Incluye sensibilidad ante privilegios y favoritismos.",
    "Veracidad": "Compromiso con la verdad en la comunicaci√≥n: precisi√≥n, evitar exageraci√≥n u omisiones relevantes, y cuidar la confianza que se genera."
  };

  // Recomendaciones por nivel (1-40 / 41-70 / 71-100)
  const INTEGRIDAD_RECOM = {
    "Honestidad": {
      bajo: [
        "Establecer un acuerdo personal de transparencia: decir la verdad incluso en situaciones peque√±as (1‚Äì2 semanas).",
        "Registrar 3 momentos diarios donde se eligi√≥ la opci√≥n correcta (refuerzo de conducta)."
      ],
      medio: [
        "Consolidar h√°bitos de claridad: explicar decisiones y reconocer errores sin justificarse en exceso.",
        "Practicar ‚Äúreparaci√≥n‚Äù: si hubo una omisi√≥n o error, corregirlo en menos de 24 horas."
      ],
      alto: [
        "Modelar integridad: compartir buenas pr√°cticas con pares (sin se√±alar a otros).",
        "Sostener consistencia bajo presi√≥n: anticipar dilemas y preparar respuestas (plan de 2 pasos)."
      ]
    },
    "Rectitud": {
      bajo: [
        "Definir 3 reglas no negociables (por ejemplo: no copiar, no tomar lo ajeno, no mentir) y revisarlas semanalmente.",
        "Entrenar autocontrol con pausas de 10 segundos antes de responder en conflictos."
      ],
      medio: [
        "Reforzar l√≠mites y autocontrol: usar ‚Äúpausa + alternativa‚Äù ante tentaciones o presi√≥n.",
        "Mantener rutinas de responsabilidad (cumplir acuerdos y horarios) 4 d√≠as/semana."
      ],
      alto: [
        "Asumir responsabilidades estables (encargos, seguimiento de tareas, cumplimiento de normas).",
        "Apoyar clima √©tico: proponer mejoras simples a reglas/procesos cuando sea necesario."
      ]
    },
    "Justicia": {
      bajo: [
        "Practicar decisiones imparciales: aplicar la misma regla para todos (lista de criterios).",
        "Hacer un ejercicio semanal de ‚Äòperspectiva‚Äô: ¬øc√≥mo se sentir√≠a la otra persona?"
      ],
      medio: [
        "Consolidar trato equitativo: turnos, reparto de tareas, y reconocimiento sin favoritismos.",
        "Resolver desacuerdos con criterios claros (hechos ‚Üí regla ‚Üí consecuencia)."
      ],
      alto: [
        "Promover cooperaci√≥n y mediaci√≥n: ayudar a resolver conflictos con neutralidad.",
        "Participar en roles de organizaci√≥n donde se cuide la equidad (equipo, aula, trabajo)."
      ]
    },
    "Veracidad": {
      bajo: [
        "Entrenar precisi√≥n: describir hechos sin exagerar (qu√© pas√≥, cu√°ndo, qui√©n, evidencia).",
        "Evitar omisiones: antes de comunicar, revisar 3 preguntas (¬øes cierto? ¬øes completo? ¬øes respetuoso?)."
      ],
      medio: [
        "Reforzar comunicaci√≥n confiable: aclarar dudas y corregir informaci√≥n si fue imprecisa.",
        "Practicar mensajes breves y directos (sin adornos) en situaciones relevantes."
      ],
      alto: [
        "Modelar confianza: mantener coherencia entre lo que se promete y lo que se entrega.",
        "Promover cultura de evidencia: respaldar afirmaciones con datos o hechos verificables."
      ]
    }
  };

  // Pack accionable para ‚ÄúPrioridades seg√∫n puntaje‚Äù
  const PLAN_FOCO = {
    "Honestidad": {
      bajo:{objetivo:"Fortalecer transparencia en decisiones y comunicaci√≥n.", acciones:[
        "Registro diario: 1 decisi√≥n honesta + por qu√© fue importante (5 d√≠as/sem).",
        "Reparaci√≥n en <24h si hubo omisi√≥n o error (si aplica).",
        "Compromiso visible: definir 1 regla personal y cumplirla (semanal)."
      ], indicador:"‚â•5 registros/sem + 1 reparaci√≥n o aclaraci√≥n cuando corresponda.", revision:"Revisi√≥n semanal (5 min) con adulto/mentor."},
      medio:{objetivo:"Consolidar consistencia y reparaci√≥n oportuna.", acciones:[
        "Revisar acuerdos y cumplirlos (4 d√≠as/sem).",
        "Comunicaci√≥n clara: explicar decisiones relevantes (2 veces/sem).",
        "Correcci√≥n inmediata de imprecisiones (cuando ocurra)."
      ], indicador:"Cumplimiento 4 d√≠as/sem + 2 comunicaciones claras/sem.", revision:"Revisi√≥n quincenal."},
      alto:{objetivo:"Sostener modelaje y coherencia bajo presi√≥n.", acciones:[
        "Anticipar dilemas: plan de respuesta (1 vez/sem).",
        "Modelar buenas pr√°cticas con pares (1 vez/sem).",
        "Mantener coherencia promesa‚Äìentrega (seguimiento semanal)."
      ], indicador:"1 plan/sem + 1 modelaje/sem.", revision:"Revisi√≥n mensual."}
    },
    "Rectitud": {
      bajo:{objetivo:"Reducir impulsividad y fortalecer autocontrol √©tico.", acciones:[
        "Pausa de 10 segundos antes de responder en tensi√≥n (diario).",
        "Lista de 3 reglas no negociables (revisi√≥n semanal).",
        "Elegir alternativa segura ante presi√≥n de pares (2 situaciones/sem)."
      ], indicador:"Aplicaci√≥n de pausa ‚â•5 d√≠as/sem + 2 situaciones/sem con alternativa.", revision:"Revisi√≥n semanal."},
      medio:{objetivo:"Sostener l√≠mites y h√°bitos responsables.", acciones:[
        "Rutina de responsabilidad (4 d√≠as/sem).",
        "Pausa + alternativa ante tentaci√≥n (2 veces/sem).",
        "Autoevaluaci√≥n breve: ¬øqu√© hice bien? (semanal)."
      ], indicador:"Rutina 4 d√≠as/sem + 2 pausas/sem.", revision:"Revisi√≥n quincenal."},
      alto:{objetivo:"Potenciar responsabilidades y mejora de normas/procesos.", acciones:[
        "Asumir 1 responsabilidad estable (semanal).",
        "Proponer 1 mejora simple a normas/procesos (mensual).",
        "Acompa√±ar cumplimiento de acuerdos del grupo (semanal)."
      ], indicador:"1 responsabilidad/sem + 1 mejora/mes.", revision:"Revisi√≥n mensual."}
    },
    "Justicia": {
      bajo:{objetivo:"Fortalecer decisiones imparciales y empat√≠a.", acciones:[
        "Criterios claros antes de decidir (2 veces/sem).",
        "Ejercicio de perspectiva (semanal).",
        "Reparto equitativo de tareas (cuando aplique)."
      ], indicador:"2 decisiones/sem con criterios + 1 perspectiva/sem.", revision:"Revisi√≥n quincenal."},
      medio:{objetivo:"Consolidar trato equitativo y resoluci√≥n objetiva de conflictos.", acciones:[
        "Turnos y reglas claras (semanal).",
        "Resolver desacuerdos con hechos‚Üíregla‚Üíconsecuencia (2 situaciones/sem).",
        "Reconocer cooperaci√≥n sin favoritismos (semanal)."
      ], indicador:"2 situaciones/sem resueltas con criterio + 1 reconocimiento/sem.", revision:"Revisi√≥n quincenal."},
      alto:{objetivo:"Promover mediaci√≥n y equidad en el grupo.", acciones:[
        "Rol de apoyo/mediaci√≥n (semanal).",
        "Actividad grupal con reglas equitativas (semanal).",
        "Revisi√≥n de decisiones sensibles (mensual)."
      ], indicador:"1 rol/sem + 1 actividad/sem.", revision:"Revisi√≥n mensual."}
    },
    "Veracidad": {
      bajo:{objetivo:"Mejorar precisi√≥n y completitud al comunicar.", acciones:[
        "Antes de comunicar: 3 preguntas (cierto/completo/respetuoso) (diario).",
        "Resumen de hechos sin exagerar (2 veces/sem).",
        "Corregir informaci√≥n imprecisa (cuando ocurra)."
      ], indicador:"Uso de checklist ‚â•5 d√≠as/sem + 2 res√∫menes/sem.", revision:"Revisi√≥n semanal."},
      medio:{objetivo:"Consolidar comunicaci√≥n confiable y correcci√≥n oportuna.", acciones:[
        "Mensajes breves y directos (2 veces/sem).",
        "Aclarar dudas cuando haya ambig√ºedad (semanal).",
        "Corregir imprecisiones en <24h (si aplica)."
      ], indicador:"2 mensajes directos/sem + 1 aclaraci√≥n/sem.", revision:"Revisi√≥n quincenal."},
      alto:{objetivo:"Sostener confianza y cultura de evidencia.", acciones:[
        "Respaldar afirmaciones relevantes con hechos/datos (semanal).",
        "Cuidar coherencia promesa‚Äìentrega (semanal).",
        "Modelar pr√°cticas de transparencia (mensual)."
      ], indicador:"1 respaldo/sem + coherencia semanal.", revision:"Revisi√≥n mensual."}
    }
  };

  function nivelLabel(p){
    const n = nivelFromPct(p);
    if(n==="bajo") return {nivel:"bajo", label:"0‚Äì39 Requiere acompa√±amiento"};
    if(n==="medio") return {nivel:"medio", label:"40‚Äì60 En formaci√≥n"};
    return {nivel:"alto", label:"61‚Äì100 √çntegro"};
  }

  function setInterpCard(skill, pct){
    const badgeEl = document.getElementById(INTEGRIDAD_SKILLS.find(x=>x.key===skill)?.idBadge || "");
    const bodyEl  = document.getElementById(INTEGRIDAD_SKILLS.find(x=>x.key===skill)?.idBody  || "");
    if(!badgeEl || !bodyEl) return;

    const p = (pct==null || Number.isNaN(pct)) ? null : Math.round(Number(pct));
    const lvl = p==null ? {nivel:"medio", label:"‚Äî"} : nivelLabel(p);

    badgeEl.innerHTML = `<span class="pill">${lvl.label}</span> <span class="pct">${p==null ? "‚Äî" : (p + "/100")}</span>`;

    const desc = INTEGRIDAD_DESC[skill] || "";
    const recs = (INTEGRIDAD_RECOM[skill] && INTEGRIDAD_RECOM[skill][lvl.nivel]) ? INTEGRIDAD_RECOM[skill][lvl.nivel] : [];

    bodyEl.innerHTML = `
      <div class="muted" style="margin-bottom:8px">${escapeHtml(desc)}</div>
      <h4>Enfoque pr√°ctico (2‚Äì3 semanas)</h4>
      <ul>
        ${recs.map(r=>`<li>${escapeHtml(r)}</li>`).join("")}
      </ul>
      <h4>Indicador de avance</h4>
      <div class="muted">Evidencias simples: cumplimiento de acuerdos, coherencia en decisiones, y calidad de comunicaci√≥n (precisa y completa).</div>
    `;
  }

  function renderPerfilGlobalIntegridad(extras){
    const cont = document.getElementById("perfilGlobal");
    if(!cont) return;
    cont.innerHTML = "";

    const header = document.createElement("div");
    header.className = "interp-bloque-header";
    header.innerHTML = `<div class="interp-bloque-nombre">3.- Perfil cuantitativo global</div>`;
    cont.appendChild(header);

    const p = document.createElement("div");
    p.className = "interp-bloque-desc";
    p.textContent = "A continuaci√≥n se muestran los puntajes (0‚Äì100) y su rango de lectura.";
    cont.appendChild(p);

    // helper: rango 0-100
    const rango = (v) => {
      const n = Number(v);
      if (!Number.isFinite(n)) return "‚Äî";
      if (n <= 39) return "Requiere acompa√±amiento";
      if (n <= 60) return "En formaci√≥n";
      return "√çntegro";
    };

    const items = [
      { label: "Honestidad", value: extras.honestidad },
      { label: "Rectitud",   value: extras.rectitud },
      { label: "Justicia",   value: extras.justicia },
      { label: "Veracidad",  value: extras.veracidad },
      { label: "IVI",        value: extras.ivi }
    ];

    const wrap = document.createElement("div");
    wrap.className = "bars-wrap";

    items.forEach(it => {
      const row = document.createElement("div");
      row.className = "bars-row";

      const v = (it.value!=null && !Number.isNaN(it.value)) ? Math.round(it.value) : null;

      const label = document.createElement("div");
      label.className = "label";
      label.textContent = v==null ? `${it.label}` : `${it.label}: ${v}/100 ‚Äî ${rango(v)}`;
      row.appendChild(label);

      const slot = document.createElement("div");
      slot.className = "bars-slot";
      // fondo con rangos (0-39 rojo, 40-60 amarillo, 61-100 verde)
      slot.style.background = "linear-gradient(90deg, var(--red) 0%, var(--red) 39%, var(--orange) 39%, var(--orange) 60%, var(--green) 60%, var(--green) 100%)";

      // ticks 0,39,60,100
      [0,39,60,100].forEach(vt => {
        const tick = document.createElement("div");
        tick.className = "tick";
        tick.style.left = vt + "%";
        slot.appendChild(tick);

        const tLabel = document.createElement("div");
        tLabel.className = "tick-label";
        tLabel.style.left = vt + "%";
        tLabel.textContent = vt;
        slot.appendChild(tLabel);
      });

      const marker = document.createElement("div");
      marker.className = "marker";
      if (v != null){
        marker.style.left = Math.max(0, Math.min(100, v)) + "%";
        marker.style.display = "block";
      }
      slot.appendChild(marker);

      row.appendChild(slot);
      wrap.appendChild(row);
    });

    cont.appendChild(wrap);

    // Nota de cautela (solo por incoherencia/contradicci√≥n; PT no cambia sellos)
    const ivVal = Math.max(extras.incoh || 0, extras.nc || 0);
    if (ivVal >= 1){
      const note = document.createElement("div");
      note.className = "muted";
      note.style.marginTop = "8px";
      note.textContent = "Nota: Se detectaron se√±ales de inconsistencia en las respuestas. Interpreta estos puntajes con mayor cautela.";
      cont.appendChild(note);
    }
  }

  function renderRecomendacionesIntegridad(extras){
    const cont = document.getElementById("recomendaciones");
    if(!cont) return;
    cont.innerHTML = "";

    const header = document.createElement("div");
    header.className = "interp-bloque-header";
    header.innerHTML = `<div class="interp-bloque-nombre">4.- Recomendaciones y plan de acci√≥n</div>`;
    cont.appendChild(header);

    const sub = document.createElement("div");
    sub.className = "recom-subtitle";
    sub.textContent = "Las siguientes recomendaciones se generan a partir de los puntajes obtenidos y pueden usarse como gu√≠a inicial de acompa√±amiento.";
    cont.appendChild(sub);

    const lista = document.createElement("ul");
    lista.className = "recom-list";

    const items = [
      {k:"Honestidad", v: extras.honestidad},
      {k:"Rectitud", v: extras.rectitud},
      {k:"Justicia", v: extras.justicia},
      {k:"Veracidad", v: extras.veracidad},
    ];

    items.forEach(it=>{
      const p = (it.v==null || Number.isNaN(it.v)) ? null : Math.round(Number(it.v));
      const n = nivelFromPct(p);
      const recs = (INTEGRIDAD_RECOM[it.k] && INTEGRIDAD_RECOM[it.k][n]) ? INTEGRIDAD_RECOM[it.k][n] : [];
      recs.slice(0,2).forEach(t=>{
        const li=document.createElement("li");
        li.textContent = `${it.k.toUpperCase()}: ${t}`;
        lista.appendChild(li);
      });
    });

    cont.appendChild(lista);
  }

  function renderPlanAccionIntegridad(extras){
    const cont = document.getElementById("planAccion");
    if(!cont) return;
    cont.innerHTML = "";

    const header=document.createElement("div");
    header.className="interp-bloque-header";
    header.innerHTML = `<div class="interp-bloque-nombre">Plan de acci√≥n sugerido</div>`;
    cont.appendChild(header);

    const sub=document.createElement("div");
    sub.className="recom-subtitle";
    sub.textContent="Orientaciones generales y prioridades accionables. No reemplaza valoraci√≥n cl√≠nica.";
    cont.appendChild(sub);

    // ===== Prioridades seg√∫n puntaje (Top 3) =====
    const items = [
      { key:"Honestidad",  pct: extras.honestidad },
      { key:"Rectitud",    pct: extras.rectitud },
      { key:"Justicia",    pct: extras.justicia },
      { key:"Veracidad",   pct: extras.veracidad },
    ];
    items.forEach(it => it.nivel = nivelFromPct(it.pct));
    const ord = { bajo: 0, medio: 1, alto: 2 };
    items.sort((a,b)=> (ord[a.nivel]??9) - (ord[b.nivel]??9));

    const candidatos = items.filter(x => x.nivel !== "alto");
    const focos = (candidatos.length ? candidatos : items).slice(0,3);

    const box = document.createElement("div");
    box.className = "plan-focus-box";
    box.innerHTML = `<div class="plan-section-title">Prioridades seg√∫n puntaje (Top 3)</div>`;

    focos.forEach(f=>{
      const pack = PLAN_FOCO[f.key]?.[f.nivel];
      if(!pack) return;

      const sec = document.createElement("div");
      sec.className = "plan-focus-item";
      sec.innerHTML = `
        <div class="plan-focus-head"><b>${escapeHtml(f.key)}</b> ‚Äî ${escapeHtml(f.nivel)} (${Math.round(Number(f.pct)||0)}/100)</div>
        <div class="plan-focus-obj"><b>Objetivo (2‚Äì3 semanas):</b> ${escapeHtml(pack.objetivo)}</div>
        <ul class="recom-list">${pack.acciones.map(a=>`<li>${escapeHtml(a)}</li>`).join("")}</ul>
        <div class="plan-focus-meta"><b>Indicador:</b> ${escapeHtml(pack.indicador)}</div>
        <div class="plan-focus-meta"><b>Revisi√≥n:</b> ${escapeHtml(pack.revision)}</div>
      `;
      box.appendChild(sec);
    });
    cont.appendChild(box);
    // ===== Fin prioridades =====

    // Acciones generales (se mantienen)
    const mkList=(title, items)=>{
      const t=document.createElement("div"); t.className="plan-section-title"; t.textContent=title; cont.appendChild(t);
      const ul=document.createElement("ul"); ul.className="recom-list";
      items.forEach(x=>{ const li=document.createElement("li"); li.textContent=x; ul.appendChild(li); });
      cont.appendChild(ul);
    };

    mkList("En el hogar / familia:", [
      "Modelar conductas de integridad: cumplir acuerdos y reconocer errores sin castigo excesivo.",
      "Establecer reglas claras y consecuencias consistentes (no impulsivas).",
      "Revisar semanalmente situaciones donde fue dif√≠cil actuar con integridad."
    ]);

    mkList("En el aula / instituci√≥n educativa / equipo:", [
      "Promover reglas expl√≠citas de convivencia y √©tica (claridad sobre lo permitido/no permitido).",
      "Reconocer conductas de honestidad y reparaci√≥n (refuerzo positivo).",
      "Usar criterios transparentes en decisiones y evaluaciones (equidad)."
    ]);

    mkList("Con apoyo del orientador / psic√≥logo / HR:", [
      "Si los √≠ndices de validaci√≥n son altos o hay se√±ales de riesgo, profundizar con entrevista y seguimiento.",
      "Alinear familia‚Äìescuela/trabajo en estrategias (metas y evidencias observables)."
    ]);

    const foot=document.createElement("div");
    foot.style.textAlign="right";
    foot.style.fontSize="10px";
    foot.style.color="var(--muted)";
    foot.style.marginTop="8px";
    foot.textContent="IPLAED CORP 2025";
    cont.appendChild(foot);
  }

  function renderParte2Integridad(extras){
    // tarjetas (acorde√≥n)
    setInterpCard("Honestidad", extras.honestidad);
    setInterpCard("Rectitud",   extras.rectitud);
    setInterpCard("Justicia",   extras.justicia);
    setInterpCard("Veracidad",  extras.veracidad);

    // global IVI (parte superior de p√°gina 2)
    const s2 = document.getElementById("iviScore2");
    const t2 = document.getElementById("iviText2");
    if (s2) s2.textContent = extras.ivi != null ? Math.round(extras.ivi) : "‚Äî";
    if (t2) t2.textContent = interpGlobal(extras.ivi, extras.stars);

    // bloques 3 y 4 + plan
    renderPerfilGlobalIntegridad(extras);
    renderRecomendacionesIntegridad(extras);
    renderPlanAccionIntegridad(extras);
  }
function renderAll(data){
  window.__LAST_REPORT__ = data;
  const attempt = data.attempt || data;
  const snap = attempt.snapshot || attempt.snap || attempt;

  const resultados = attempt.resultados || attempt.resultados_json || attempt.result || {};
  const subRows = attempt.subhabilidades || resultados.subhabilidades || attempt.subRows || attempt.sub || [];
  const fechaRaw = attempt.created_at || attempt.creado_en || attempt.fecha_intento;
  const fechaObj = fechaRaw ? new Date(fechaRaw) : null;
  const ahora = new Date();
  document.getElementById("repDateLine").textContent = ahora.toLocaleString("es-EC", { dateStyle:"short", timeStyle:"short" });

  const fechaTexto = fechaObj ? fechaObj.toLocaleDateString("es-EC", { year:"numeric", month:"long", day:"2-digit" }) : "‚Äî";
  const nombre = snap.nombre || attempt.nombre || "‚Äî";
  document.getElementById("repHeaderBox").innerHTML = `
    <div><b>Nombre:</b> ${nombre}</div>
    <div><b>Curso/Grado:</b> ${snap.curso || attempt.curso || "‚Äî"}</div>
    <div><b>Grupo:</b> ${snap.grupo || attempt.grupo || "‚Äî"}</div>
    <div><b>Instituci√≥n:</b> ${snap.institucion || attempt.institucion || "‚Äî"}</div>
    <div><b>Fecha:</b> ${fechaTexto}</div>
  `;
const d1 = document.getElementById("repDateLine");
const d2 = document.getElementById("repDateLine2");
if (d1 && d2) d2.textContent = d1.textContent;

const h1 = document.getElementById("repHeaderBox");
const h2 = document.getElementById("repHeaderBox2");
if (h1 && h2) h2.innerHTML = h1.innerHTML;

  function normalizeName(s){ return (s||"").toString().trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,""); }

  function pctSub(nombreSub){
    const target = normalizeName(nombreSub);
    let raw = null;
    if(Array.isArray(subRows)){
      const f = subRows.find(r => normalizeName(r.sub || r.subhabilidad || r.nombre || "") === target);
      if (f) raw = (f.pct ?? f.percent ?? f.porcentaje ?? null);
    }
    if (raw == null && resultados && resultados.subhabilidades && Array.isArray(resultados.subhabilidades)){
      const f = resultados.subhabilidades.find(r => normalizeName(r.sub || r.subhabilidad || r.nombre || "") === target);
      if (f) raw = (f.pct ?? f.percent ?? f.porcentaje ?? null);
    }
    if (raw == null) return 0;
    return Math.round(Number(raw) || 0);
  }

  const pHon = pctSub("Honestidad");
  const pRec = pctSub("Rectitud");
  const pJus = pctSub("Justicia");
  const pVer = pctSub("Veracidad");

  document.getElementById("pctHonestidad").textContent = pHon || "‚Äî";
  document.getElementById("pctRectitud").textContent = pRec || "‚Äî";
  document.getElementById("pctJusticia").textContent = pJus || "‚Äî";
  document.getElementById("pctVeracidad").textContent = pVer || "‚Äî";

  const vals = [pHon,pRec,pJus,pVer].filter(v => typeof v === "number" && v > 0);
  const ivi = vals.length ? Math.round(vals.reduce((a,b)=>a+b,0)/vals.length) : 0;
  document.getElementById("repIVI").textContent = ivi || "‚Äî";
  buildCurveSvg();
  setCurveMarker(ivi || 0);

  
  const incoh = attempt.incoherencia ?? attempt.incoherencia_pct ?? attempt.incoherenciaPct ?? (resultados.validacion && (resultados.validacion.incoherencia ?? resultados.validacion.incoherencia_pct));
  const contra = attempt.contradiccion ?? attempt.contradiccion_pct ?? attempt.contradiccionPct ?? (resultados.validacion && (resultados.validacion.contradiccion ?? resultados.validacion.contradiccion_pct));

  let incohN = (incoh == null || incoh === "") ? null : Math.round(Number(incoh));
  let contraN = (contra == null || contra === "") ? null : Math.round(Number(contra));

  if ((incohN == null || Number.isNaN(incohN)) && (contraN == null || Number.isNaN(contraN))) {
    const est = estimateValidation(attempt);
    if (est){
      incohN = est.incoh;
      contraN = est.contra;
      const note = document.getElementById("ivNote");
      if (note) note.style.display = "block";
    }
  }


  // No dejamos N/D: si no hay datos suficientes, mostramos 0% como estimaci√≥n conservadora.
const incohFromBackend =
  attempt?.iv1 ??
  attempt?.resultados?.globales?.IV1 ??
  null;

let incohSafe = 0;

if (Number.isFinite(Number(incohFromBackend))) {
  incohSafe = Number(incohFromBackend);
} else {
  const est = estimateValidation(attempt) || { incohPct: 0 };
  incohSafe = Number(est.incohPct) || 0;
}
const iv1Val = (incohSafe == null ? null : Number(incohSafe));
const iv1Txt = (iv1Val == null || Number.isNaN(iv1Val))
  ? "‚Äî"
  : `${iv1Val} ${iv1Val === 1 ? "pt" : "pts"}${iv1Val >= 1 ? " ‚Äî Alerta" : ""}`;

document.getElementById("repIncoh").textContent = iv1Txt;

  
const g = (resultados && resultados.globales) ? resultados.globales : {};
const nc = (g.IV2 == null ? null : Math.round(Number(g.IV2) || 0));
const iv2Val = (nc == null ? null : Number(nc));
const iv2Txt = (iv2Val == null || Number.isNaN(iv2Val))
  ? "‚Äî"
  : `${iv2Val} ${iv2Val === 1 ? "pt" : "pts"}${iv2Val >= 1 ? " ‚Äî Alerta" : ""}`;

document.getElementById("repContra").textContent = iv2Txt;

  
// Tiempo (PT) desde BD: resultados.globales.IV3 (0/1/2) con rango 20‚Äì30 min
const pt = (g.IV3 == null || g.IV3 === "") ? null : Math.round(Number(g.IV3) || 0);
const ptVal = (pt == null ? null : Number(pt));
const ptPrefix = (ptVal == null || Number.isNaN(ptVal))
  ? "‚Äî"
  : `${ptVal} ${ptVal === 1 ? "pt" : "pts"}`;

const PT_LABEL = {
  2: "Tiempo adecuado (20‚Äì30 min)",
  1: "Demasiado breve (<20 min)",
  0: "Demasiado lento (>30 min)"
};

const elPT = document.getElementById("repTiempo");
if (elPT) elPT.textContent = (pt == null ? "‚Äî" : `${pt} ${pt === 1 ? "pt" : "pts"} ‚Äî ${PT_LABEL[pt] || ""}`);

  const validIdx = (incohN == null || Number.isNaN(incohN)) && (contraN == null || Number.isNaN(contraN))
    ? null
    : Math.max(incohN || 0, contraN || 0);

const sellos = calcSellos(ivi, incohSafe, nc);
paintSellos(sellos);
updateGuideBySellos(sellos);
  

const stars = sellos; // compatibilidad: el resto del reporte a√∫n usa "stars"


  setInterp(pHon, "interpHonBadge", "interpHonBody", "Honestidad");
  setInterp(pRec, "interpRecBadge", "interpRecBody", "Rectitud");
  setInterp(pJus, "interpJusBadge", "interpJusBody", "Justicia");
  setInterp(pVer, "interpVerBadge", "interpVerBody", "Veracidad");
  wireInterpToggles();

  const elBIVI = document.getElementById("bIVI") || document.getElementById("repIVI") || document.getElementById("iviScore2"); if (elBIVI) elBIVI.textContent = ivi || "‚Äî";
  const elTIVI = document.getElementById("tIVI") || document.getElementById("iviText2"); if (elTIVI) elTIVI.textContent = interpGlobal(ivi, sellos);
  const s2 = document.getElementById("iviScore2");
  const t2 = document.getElementById("iviText2");
  if (s2) s2.textContent = ivi || "‚Äî";
  if (t2) t2.textContent = interpGlobal(ivi, sellos);

  // ===== PARTE 2 robusta (perfil + recomendaciones + plan) =====
  const ptLabel = (pt == null) ? "‚Äî" : `${pt} pts ‚Äî ${PT_LABEL[pt] || ""}`.trim();
  renderParte2Integridad({
    honestidad: pHon,
    rectitud: pRec,
    justicia: pJus,
    veracidad: pVer,
    ivi: ivi,
sellos: sellos,
    incoh: incohSafe,
    nc: nc,
    ptLabel: ptLabel
  });




  document.getElementById("reporteContainer").style.display = "block";
}


function buildCurveSvg(){
  const svg = document.getElementById("curveSvg");
  const line = document.getElementById("curveLine");
  const fill = document.getElementById("curveFill");
  const hi   = document.getElementById("curveHi");
  if (!svg || !line || !fill || !hi) return;

  // Curva tipo campana (gaussiana) en viewBox 0..100 x 0..32
  const pts = [];
  const mu = 50, sigma = 16;
  for (let x=0; x<=100; x+=2){
    const y = Math.exp(-0.5*Math.pow((x-mu)/sigma,2)); // 0..1
    const yy = 30 - y*24; // altura
    pts.push([x, yy]);
  }
  const dLine = "M " + pts.map(p=>p[0].toFixed(1)+" "+p[1].toFixed(1)).join(" L ");
  const dFill = dLine + " L 100 30 L 0 30 Z";

  line.setAttribute("d", dLine);
  hi.setAttribute("d", dLine);
  fill.setAttribute("d", dFill);
}

function setCurveMarker(pct){
  const el = document.getElementById("curveMarker");
  const cap = document.getElementById("curveCaption");
  const p = Math.max(0, Math.min(100, Number(pct)||0));
  if (el) el.style.left = p + "%";
  if (cap) cap.textContent = "Tu puntaje: " + Math.round(p) + " / 100";
}

function extractAnswers(attempt){
  const cand = attempt.answers ?? attempt.respuestas ?? attempt.respuestas_json ?? attempt.payload?.answers ?? attempt.data?.answers;
  if (!cand) return null;
  try{
    if (Array.isArray(cand)) return cand;
    if (typeof cand === "string") return JSON.parse(cand);
    if (typeof cand === "object") return cand;
  }catch(e){ return null; }
  return null;
}

// Estimaci√≥n autom√°tica (proxy) cuando no existen pares de incoherencia/contradicci√≥n.
// - Incoherencia: variabilidad global de respuestas (m√°s variabilidad -> m√°s incoherencia).
// - Contradicci√≥n: alternancia entre respuestas consecutivas (m√°s cambios bruscos -> m√°s contradicci√≥n).
function estimateValidation(attempt){
  const a = extractAnswers(attempt);
  // esperamos 96 respuestas en escala 1-3
  //const arr = Array.isArray(a) ? a : (a && Array.isArray(a.items) ? a.items : null);
  let arr = null;

// Caso 1: array directo
if (Array.isArray(a)) {
  arr = a;
}
// Caso 2: {items:[...]}
else if (a && Array.isArray(a.items)) {
  arr = a.items;
}
// Caso 3: {"1":3,"2":2,...}  (objeto con llaves num√©ricas)
else if (a && typeof a === "object") {
  const keys = Object.keys(a).filter(k => /^\d+$/.test(k));
  if (keys.length) {
    keys.sort((x,y)=>Number(x)-Number(y));
    arr = keys.map(k => a[k]);
  }
}

  
  if (!arr || !arr.length) return null;

const vals = [];
for (const it of arr){
  let n;

  // Si viene como n√∫mero o string ("1","2","3")
  if (typeof it === "number" || typeof it === "string") {
    n = Number(it);
  } else {
    // Si viene como objeto {value:...} o {respuesta:...}
    n = Number(it?.value ?? it?.v ?? it?.respuesta ?? it?.answer);
  }

  if (n >= 1 && n <= 3) vals.push(n);
}

  if (vals.length < 20) return null;

  const mean = vals.reduce((s,x)=>s+x,0)/vals.length;
  const varr = vals.reduce((s,x)=>s+Math.pow(x-mean,2),0)/vals.length;
  const sd = Math.sqrt(varr);

  // max sd for {1,3} split is 1.0; but in 1-3 with middle, practical max ~1.0
  const incoh = Math.round(Math.max(0, Math.min(100, (sd/1.0)*100)));

  let switches = 0;
  for (let i=1;i<vals.length;i++){
    if (vals[i] !== vals[i-1]) switches++;
  }
  const contra = Math.round(Math.max(0, Math.min(100, (switches/Math.max(1, vals.length-1))*100)));

  return { incoh, contra };
}


function calcSellos(ivi, incohPts, contradPts){
  const v = Number(ivi) || 0;

  // 1) Base por IVI (manual)
  if (v <= 39) return 1;       // requiere acompa√±amiento / no recomendado
  if (v <= 60) return 2;       // en formaci√≥n / con reserva

  // 2) IVI 61‚Äì100: "muy √≠ntegro" solo si la validaci√≥n no es alta
  // En BD IV1/IV2 se guardan como 0, 1 o 2 (puntos, no %). Usamos el peor caso.
  const incoh = Number(incohPts) || 0;
  const contra = Number(contradPts) || 0;
  const validacion = Math.max(incoh, contra);

  // Regla intermedia:
  // - validaci√≥n 0 o 1 -> 4 sellos
  // - validaci√≥n 2      -> 3 sellos
  if (validacion <= 1) return 4;
  return 3;
}




function paintSellos(n){
  const root = document.getElementById("repSeals");
  if (!root) return; // evita que rompa

  const seals = root.querySelectorAll(".seal");
  if (!seals || seals.length === 0) return;

  seals.forEach((img, idx) => {
    img.classList.toggle("on", idx < n);
  });
}

function updateGuideBySellos(n){
  const ids = ["guideS1","guideS2","guideS3","guideS4"];
  ids.forEach(id=>{
    const tr = document.getElementById(id);
    if (tr) tr.classList.remove("is-active");
  });
  const active = document.getElementById("guideS"+String(n));
  if (active) active.classList.add("is-active");
}




function interpBand(pct){
  const p = Number(pct)||0;
  if (p <= 39) return {tag:"Requiere acompa√±amiento", txt:"Este resultado sugiere que el valor est√° poco consolidado. Puede beneficiar trabajar h√°bitos concretos y recibir acompa√±amiento para fortalecerlo de forma consistente."};
  if (p <= 60) return {tag:"En formaci√≥n", txt:"Este resultado sugiere avances, pero con espacios de mejora. Es √∫til reforzar decisiones y acciones alineadas al valor en situaciones cotidianas."};
  return {tag:"√çntegro", txt:"Este resultado sugiere una vivencia consistente del valor. Mant√©n pr√°cticas que lo sostengan y busca retos donde puedas modelarlo y fortalecerlo a√∫n m√°s."};
}

// Interpretaci√≥n por subprueba (rangos solicitados: <=40, <=70, >70)
function interpBandSkill(skillName, pct){
  const p = Number(pct);
  const v = Number.isFinite(p) ? p : 0;

  if (v <= 39) return { key: "low",  label: "Requiere acompa√±amiento" };
  if (v <= 60) return { key: "mid",  label: "En formaci√≥n" };
  return { key: "high", label: "√çntegro" };
}

const INTERP_CONTENT = {
  "Honestidad": {
    low: {
      idea: "Tu resultado sugiere que, en situaciones cotidianas, podr√≠a haber inconsistencias al actuar con transparencia o al sostener la verdad cuando resulta inc√≥modo.",
      risks: [
        "Dificultad para reconocer errores o asumir responsabilidades.",
        "Tendencia a justificar omisiones, medias verdades o ¬´ajustes¬ª a la realidad para evitar consecuencias.",
        "Riesgo de p√©rdida de confianza en equipos, familia o entorno cercano."
      ],
      actions: [
        "Practica el ¬´hecho vs. interpretaci√≥n¬ª: describe lo ocurrido sin adjetivos ni suposiciones.",
        "Si te equivocas, n√≥mbralo y propone una reparaci√≥n concreta (qu√© har√°s y cu√°ndo).",
        "Antes de hablar, revisa: ¬ølo que dir√© es exacto, completo y necesario?"
      ]
    },
    mid: {
      idea: "Tu resultado refleja una base adecuada de transparencia, con margen para sostenerla con mayor constancia en contextos de presi√≥n, conflicto o estr√©s.",
      risks: [
        "En escenarios tensos, podr√≠as suavizar informaci√≥n relevante o postergar conversaciones dif√≠ciles.",
        "Podr√≠as ser selectivo con la verdad para cuidar tu imagen o evitar discusiones."
      ],
      actions: [
        "Establece un h√°bito de claridad: comunica lo esencial primero y luego el detalle.",
        "Acuerda expectativas: qu√© informaci√≥n es importante compartir y con qu√© frecuencia.",
        "Entrena conversaciones dif√≠ciles: prepara 3 puntos clave y una propuesta de soluci√≥n."
      ]
    },
    high: {
      idea: "Tu resultado sugiere una vivencia consistente de honestidad: tiendes a comunicar con claridad, reconocer errores y sostener la verdad incluso cuando requiere valent√≠a.",
      risks: [
        "Cuidar el equilibrio entre franqueza y tacto para no sonar r√≠gido o confrontativo."
      ],
      actions: [
        "Modela con el ejemplo: reconoce logros y errores con la misma naturalidad.",
        "Ofrece feedback con empat√≠a: qu√© ocurri√≥, impacto, expectativa y acuerdo.",
        "Mant√©n tu est√°ndar incluso en peque√±os detalles: ah√≠ se consolida la confianza."
      ]
    }
  },

  "Rectitud": {
    low: {
      idea: "Tu resultado sugiere que puedes flexibilizar reglas o principios cuando sientes que te limitan, o cuando ¬´nadie est√° mirando¬ª.",
      risks: [
        "Inconsistencia entre lo que se considera correcto y lo que se hace.",
        "Mayor vulnerabilidad a presiones externas o a decisiones impulsivas.",
        "Se√±ales de doble est√°ndar (para ti vs. para otros)."
      ],
      actions: [
        "Define 3 principios no negociables y trad√∫celos a conductas observables.",
        "Cuando est√©s por ¬´ceder¬ª, preg√∫ntate: ¬ølo har√≠a si esto fuese p√∫blico?",
        "Crea recordatorios: reglas personales simples para decisiones repetidas."
      ]
    },
    mid: {
      idea: "Tu resultado refleja un criterio √©tico funcional, con variaciones cuando hay urgencia, conveniencia o presi√≥n social.",
      risks: [
        "En momentos de prisa, podr√≠as priorizar resultados por encima del proceso.",
        "Podr√≠as normalizar peque√±as excepciones que luego se vuelven h√°bito."
      ],
      actions: [
        "Usa un ¬´check¬ª r√°pido: legal, justo, coherente con mis valores, sostenible.",
        "Estandariza decisiones: si la situaci√≥n se repite, define una regla general.",
        "Busca un ¬´aliado de integridad¬ª para validar decisiones complejas."
      ]
    },
    high: {
      idea: "Tu resultado sugiere rectitud s√≥lida: act√∫as con coherencia entre valores, reglas y decisiones, incluso si implica esfuerzo.",
      risks: [
        "Evitar caer en rigidez: la rectitud tambi√©n incluye escuchar y ajustar sin traicionar principios."
      ],
      actions: [
        "Comparte tus criterios: muestran transparencia y ayudan a alinear al equipo.",
        "Distingue principio vs. preferencia: as√≠ negocias sin perder tu centro.",
        "Reconoce mejoras: refuerza una cultura de coherencia."
      ]
    }
  },

  "Justicia": {
    low: {
      idea: "Tu resultado sugiere que podr√≠as percibir el trato justo como relativo, o priorizar beneficios personales por encima de la equidad en algunas decisiones.",
      risks: [
        "Conflictos por favoritismos o por decisiones percibidas como desbalanceadas.",
        "Dificultad para asumir responsabilidad cuando refleja errores propios.",
        "Resistencia a reglas comunes cuando no favorecen."
      ],
      actions: [
        "Antes de decidir, pregunta: ¬øesto es igual para todos en la misma situaci√≥n?",
        "Separa persona de conducta: eval√∫a hechos y criterios, no simpat√≠as.",
        "Si alguien se ve afectado, explica el criterio y ofrece alternativas."
      ]
    },
    mid: {
      idea: "Tu resultado refleja una orientaci√≥n razonable hacia la equidad, con margen para fortalecer consistencia y transparencia en decisiones.",
      risks: [
        "En situaciones ambiguas, podr√≠as usar criterios distintos sin notarlo.",
        "Tendencia a ¬´compensar¬ª con tratos especiales en lugar de corregir el sistema."
      ],
      actions: [
        "Define criterios por escrito para decisiones recurrentes (asignaciones, turnos, apoyos).",
        "Practica la escucha activa antes de concluir: resume lo que entendiste y valida.",
        "Revisa consecuencias: ¬øla decisi√≥n genera resentimiento o claridad?"
      ]
    },
    high: {
      idea: "Tu resultado sugiere un sentido de justicia consistente: tiendes a evaluar con imparcialidad, explicar criterios y cuidar la equidad en el trato.",
      risks: [
        "Evitar sobrecargarte intentando ¬´ser justo con todos¬ª sin l√≠mites claros."
      ],
      actions: [
        "Facilita acuerdos: establece reglas claras y medibles para el grupo.",
        "Promueve reparaci√≥n: cuando hay error, enf√≥cate en corregir y aprender.",
        "Refuerza lo justo: reconocerlo hace que se repita."
      ]
    }
  },

  "Veracidad": {
    low: {
      idea: "Tu resultado sugiere que, en ocasiones, podr√≠as omitir, distorsionar o ajustar informaci√≥n para evitar consecuencias, quedar bien o reducir conflicto.",
      risks: [
        "P√©rdida de credibilidad cuando se detectan inconsistencias.",
        "Confusi√≥n y errores por informaci√≥n incompleta.",
        "Mayor tensi√≥n interpersonal por desconfianza."
      ],
      actions: [
        "Entrena precisi√≥n: responde con datos concretos (qu√©, cu√°ndo, cu√°nto).",
        "Si no sabes algo, dilo y comprom√©tete con un seguimiento.",
        "Evita suposiciones: pregunta antes de afirmar."
      ]
    },
    mid: {
      idea: "Tu resultado refleja veracidad adecuada, con espacio para fortalecer consistencia cuando hay presi√≥n, miedo al juicio o conflicto.",
      risks: [
        "Podr√≠as postergar verdades dif√≠ciles o suavizar hechos importantes.",
        "En contextos tensos, podr√≠as comunicar con ambig√ºedad."
      ],
      actions: [
        "Comunica con estructura: situaci√≥n ‚Üí hecho ‚Üí impacto ‚Üí propuesta.",
        "Asegura comprensi√≥n: pide que te repitan lo esencial o resume al final.",
        "Practica transparencia gradual: lo importante temprano evita crisis despu√©s."
      ]
    },
    high: {
      idea: "Tu resultado sugiere veracidad s√≥lida: tiendes a comunicar con precisi√≥n y consistencia, favoreciendo confianza y claridad en tus relaciones.",
      risks: [
        "Cuidar el tono: la verdad es m√°s efectiva cuando se comunica con respeto."
      ],
      actions: [
        "Modela claridad: comparte hechos y criterios, no rumores.",
        "Cierra bucles: cuando prometes informar, cumple el seguimiento.",
        "Ayuda a otros a expresarse: preguntas abiertas y escucha sin juicio."
      ]
    }
  }
};

function buildInterpHTML(skillName, bandKey){
  const s = INTERP_CONTENT[String(skillName)] || null;
  const b = s ? s[bandKey] : null;
  if (!b) return `<div class="muted">Informaci√≥n no disponible.</div>`;

  const ul = (arr) => `<ul>${arr.map(x => `<li>${x}</li>`).join("")}</ul>`;

  return `
    <div><strong>Lectura:</strong> ${b.idea}</div>
    <h4>Posibles riesgos si no se gestiona</h4>
    ${ul(b.risks)}
    <h4>Recomendaciones pr√°cticas</h4>
    ${ul(b.actions)}
  `;
}

function setInterp(pct, badgeId, bodyId, skillName){
  const p = Number(pct);
  const v = Number.isFinite(p) ? p : 0;

  const band = interpBandSkill(skillName, v);

  const badgeEl = document.getElementById(badgeId);
  const bodyEl  = document.getElementById(bodyId);
  if (!badgeEl || !bodyEl) return;

  badgeEl.innerHTML = `<span class="pill">${band.label}</span> <span class="pct">${v}%</span>`;
  bodyEl.innerHTML  = buildInterpHTML(skillName, band.key);

  // abrir por defecto si est√° "Requiere acompa√±amiento"
  if (band.key === "low") {
    bodyEl.style.display = "block";
    const btn = document.querySelector(`.interpToggle[data-target="${bodyId}"]`);
    if (btn) btn.textContent = "‚àí";
  }
}

function wireInterpToggles(){
  document.querySelectorAll(".interpToggle").forEach(btn => {
    btn.addEventListener("click", () => {
      const target = btn.getAttribute("data-target");
      const el = document.getElementById(target);
      if (!el) return;
      const open = el.style.display !== "none";
      el.style.display = open ? "none" : "block";
      btn.textContent = open ? "+" : "‚àí";
    });
  });
}
function interpGlobal(ivi, sellos){
  const b = interpBand(ivi);
  const sTxt = sellos === 4 ? "Alta consistencia de respuestas."
  : (sellos === 3 ? "Consistencia aceptable de respuestas." : "");
  return `${b.txt} Nivel global: ${b.tag}. ${sTxt}`.trim();
}


  async function cargarReporte(codigo){
    document.getElementById("msg").textContent = "Buscando...";
    document.getElementById("msg").className = "msg";
    document.getElementById("reporteContainer").style.display = "none";
    try{
      const r = await fetch(`/api/report?codigo=${encodeURIComponent(codigo)}`);
      const data = await r.json();
      if(!r.ok || data.error){
        document.getElementById("msg").textContent = data.error || "No encontrado";
        document.getElementById("msg").className = "msg err";
        return;
      }
      if (!data || !data.attempt) {
        document.getElementById("msg").textContent = "No se encontr√≥ un intento registrado para este c√≥digo.";
        document.getElementById("msg").className = "msg err";
        return;
      }
      if (data.puede_ver_resultado !== true) {
        document.getElementById("msg").textContent = "Este c√≥digo no est√° habilitado para ver su reporte. Contacta a la coordinaci√≥n.";
        document.getElementById("msg").className = "msg err";
        return;
      }
      document.getElementById("msg").textContent = "Reporte cargado.";
      document.getElementById("msg").className = "msg ok";
      renderAll(data);
      window.scrollTo({top:0,behavior:"smooth"});
    }catch(e){
      console.error(e);
      document.getElementById("msg").textContent="Error de conexi√≥n";
      document.getElementById("msg").className="msg err";
    }
  }

  
  const btnVer = document.getElementById("btnVer");
  if (btnVer) {
    btnVer.addEventListener("click", () => {
      const c = (document.getElementById("codigoInput").value || "").trim().toUpperCase();
      if (!c) return;
      cargarReporte(c);
    });
  }
function exportJSON(){
    const payload = window.__LAST_REPORT__ || {};
    const blob = new Blob([JSON.stringify(payload,null,2)],{type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "reporte-integridad.json";
    a.click();
  }

  (()=>{const __el=document.getElementById("btnImprimir"); if(__el) __el.addEventListener("click", ()=>window.print());})();
  (()=>{const __el=document.getElementById("btnExportJSON"); if(__el) __el.addEventListener("click", exportJSON);})();
  (()=>{const __el=document.getElementById("btnPDF"); if(__el) __el.addEventListener("click", ()=>window.print());})();
  (()=>{const __el=document.getElementById("btnJSON"); if(__el) __el.addEventListener("click", exportJSON);})();

  (function init(){
    const qp = new URLSearchParams(location.search);
    const c = (qp.get("codigo")||"").trim().toUpperCase();
    if(c){
      document.getElementById("codigoInput").value=c;
      cargarReporte(c);
    }
  })();
  // === FIX PDF: Chrome a veces NO imprime SVG con filtros (feDropShadow) ===
(function fixCurveForPrint(){
  const fill = document.getElementById("curveFill");
  if (!fill) return;

  let prevFilterAttr = null;

  window.addEventListener("beforeprint", () => {
    prevFilterAttr = fill.getAttribute("filter");
    fill.removeAttribute("filter"); // quita url(#softShadow)
  });

  window.addEventListener("afterprint", () => {
    if (prevFilterAttr) fill.setAttribute("filter", prevFilterAttr);
  });
})();
// === FIX PDF: Chrome a veces NO imprime SVG con filtros (feDropShadow) ===
(function fixCurveForPrint(){
  const fill = document.getElementById("curveFill");
  if (!fill) return;

  let prevFilterAttr = null;

  window.addEventListener("beforeprint", () => {
    prevFilterAttr = fill.getAttribute("filter");
    fill.removeAttribute("filter"); // quita url(#softShadow)
  });

  window.addEventListener("afterprint", () => {
    if (prevFilterAttr) fill.setAttribute("filter", prevFilterAttr);
  });
})();

</script>
</body>
</html>
