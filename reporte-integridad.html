<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>BBCXIntegridad - Reporte (AFINADO)</title>
  <style>
    :root{
      --ink:#111; --muted:#666; --line:#ddd;
      --yellow:#ffe36a; --green:#2e9b4f; --orange:#f4a338; --red:#e45757;
    }
    html,body{margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:#fff;color:#0f172a;min-height:100vh;}
    .wrap{max-width:900px;margin:18px auto 48px;padding:0 12px}
    h1,h2,h3{margin:0 0 8px 0}
    .muted{color:var(--muted)}
    .topbar{display:flex;gap:12px;align-items:center;margin-bottom:8px}
    .topbar input{flex:0 0 180px;padding:8px 10px;border:1px solid #bbb;border-radius:8px;font-size:16px;text-transform:uppercase}
    .btn{padding:9px 14px;border-radius:999px;border:0;background:#1a8f3b;color:#fff;font-weight:700;font-size:16px;cursor:pointer}
    .msg{margin-left:8px;font-weight:700}
    .msg.ok{color:#0a8}
    .msg.err{color:#c00}
    .hint{font-size:12px;color:var(--muted);margin-bottom:8px}

    .rep-top{border-bottom:1px solid var(--line);padding-bottom:6px;margin-bottom:6px;}
    .rep-top-row1{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;font-size:12px;margin-bottom:6px;}
    .rep-date{justify-self:flex-start;}
    .rep-top-center{text-align:center;font-weight:700;text-transform:uppercase;}
    .rep-top-logo{justify-self:flex-end;}
    .mhp-logo{height:56px !important;width:auto !important;object-fit:contain;display:block;}
    .rep-top-row2{display:flex;justify-content:center;align-items:center;gap:12px;font-size:26px;font-weight:800;margin-bottom:2px;text-transform:uppercase;}
    .rep-top-row3{text-align:center;font-size:18px;font-weight:800;}

    .iv-table td.hl{background:var(--yellow)}
    .iv-key{font-weight:900;color:#000;}
    .iv-legend{display:flex;gap:14px;justify-content:flex-start;margin-top:6px;font-size:11px;color:#111;flex-wrap:wrap}
    .iv-legend span b{font-weight:900}

    .page{margin-top:10px}
    .page-break{break-after:page;page-break-after:always;margin-bottom:18px;}
    @media print{
      .page-break{margin-bottom:0;}

      @page{ size:A4; margin:8mm 8mm }
      .topbar,.hint{display:none !important}
      body{zoom:0.92;}
      .wrap{max-width:none;margin:0 auto;padding:0 6px}
      .page{margin-top:0;break-inside:auto}
      .page-break{break-after:page;page-break-after:always;margin-bottom:18px;}
      /* Mantener la PARTE 1 en una sola hoja */
      #page1{zoom:0.90;}
      .rep-top{margin-bottom:4px;padding-bottom:4px}
      .rep-ids{margin-top:4px !important}
      .rep-mid{margin-top:4px !important}
      .mhp-logo{height:56px !important;width:auto !important;object-fit:contain;display:block;}
      .rep-top-row2{font-size:22px !important;margin-bottom:0 !important}
      .rep-top-row3{font-size:16px !important}
      .bloque-title{margin:8px 0 4px !important}
      .scale-section{margin-top:8px !important}
      /* Compactación para confirmar que la Página 1 quede completa */
      #page1{page-break-after:always; break-after:page;}
      #page1 *{break-inside:avoid;}
      .rep-top{padding-bottom:4px;margin-bottom:4px}
      .rep-top-row2{font-size:22px;margin-bottom:0}
      .rep-top-row3{font-size:16px}
      .mhp-logo{height:56px !important;width:auto !important;object-fit:contain;display:block;}
      #repHeaderBox{padding:4px !important}
      .rep-mid{margin-top:6px !important}
      .bloque-title{margin:8px 0 4px}
      .iie-row{margin:8px 0 4px}
      .scale-section{margin-top:8px}
      .bars-row{margin:6px 0}
      .bars-slot{height:18px}
      .bars-slot .tick-label{top:15px}
      .scale-note-inline{margin-top:2px}

    }


    .bloque-title{font-weight:800;margin:12px 0 6px;display:flex;align-items:center;justify-content:space-between;gap:8px;}
    .bloque-left{display:flex;align-items:center;gap:6px;}
    .bloque-bullet{width:10px;height:10px;border-radius:999px;background:#f4a338;flex:0 0 auto;}
    .ih-badge{background:var(--yellow);padding:2px 10px;border-radius:2px;min-width:36px;text-align:center;font-weight:800;}
    .iie-row{display:flex;justify-content:flex-end;align-items:center;margin:12px 0 6px;font-weight:800;gap:8px;}
    .iie-badge{background:#1d4ed8;color:#fff;padding:3px 12px;border-radius:2px;min-width:40px;text-align:center;}

    .scale-section{margin-top:14px;}
    .section-title{display:flex;align-items:center;gap:6px;font-weight:800;margin-bottom:2px;}
    .section-dot{width:10px;height:10px;border-radius:999px;background:#f4a338;flex:0 0 auto;}
    .scale-range-header{display:grid;grid-template-columns:220px 1fr 1fr 1fr;font-size:11px;font-weight:700;margin:0 0 2px;align-items:flex-end;}
    .scale-range-header span{text-align:center;}
.scale-note-inline{
  font-size:11px;
  color:var(--muted);
  margin-top:4px;
  text-align:center;
  position: relative;
  left: 4cm;
}

    .bars-wrap{margin:8px 0}
    .bars-row{display:grid;grid-template-columns:220px 1fr;align-items:center;gap:8px;margin:10px 0;}
    .bars-row .label{font-weight:700;font-size:12px}
    .bars-slot{position:relative;height:22px;border:1px solid #9ca3af;border-radius:4px;background:#f3f4f6}
    .bars-slot .tick{position:absolute;top:-6px;width:1px;height:24px;background:#9ca3af}
    .bars-slot .tick-label{position:absolute;top:19px;font-size:10px;transform:translateX(-50%)}
    .bars-slot .marker{position:absolute;top:-2px;width:10px;height:16px;background:#111;border-radius:2px;transform:translateX(-50%);display:none}

    /* Interpretación larga */
    .interp-title{margin-top:8px;font-size:18px;font-weight:800;}
    .interp-legend{font-size:12px;color:var(--muted);margin-top:4px;margin-bottom:4px;}
    .interp-legend-row{margin-top:3px;margin-bottom:3px;}
    .interp-bloque{border:1px solid var(--line);border-radius:10px;padding:10px;margin-top:8px;font-size:12px;background:#fff;}
    .interp-bloque-header{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:4px;}
    .interp-bloque-nombre{font-weight:800;text-transform:uppercase;}
    .interp-bloque-indice{font-weight:800;font-size:12px;}
    .interp-bloque-indice span{background:var(--yellow);padding:2px 8px;border-radius:2px;min-width:36px;text-align:center;display:inline-block;}
    .interp-bloque-desc{font-size:12px;color:var(--muted);margin-bottom:6px;}
    .skill-row{margin:6px 0 10px;}
    .skill-row-title{font-weight:700;font-size:12px;margin-bottom:2px;}
    .skill-row-desc{font-size:11px;color:var(--muted);margin-bottom:4px;}
    .skill-row-alert{color: var(--red);font-weight:600;}
    .skill-bar{display:flex;align-items:center;gap:6px;}
    .skill-bar-track{position:relative;flex:1;height:12px;border-radius:999px;overflow:hidden;background:linear-gradient(to right,var(--red) 0%, var(--red) 40%,var(--orange) 40%, var(--orange) 70%,var(--green) 70%, var(--green) 100%);}
    .skill-bar-marker{position:absolute;top:0;bottom:0;width:2px;background:#111;transform:translateX(-50%);}
    .skill-bar-value{font-size:11px;font-weight:700;min-width:48px;text-align:right;}

    .recom-subtitle{font-size:12px;color:var(--muted);margin-bottom:4px;}
    .recom-list{margin:4px 0 0 14px;padding:0;font-size:12px;color:#374151;}
    .recom-list li{margin-bottom:3px;}
    .plan-section-title{font-weight:700;font-size:12px;margin-top:4px;margin-bottom:2px;}
    /* ===== Prioridades (Top 3) ===== */
    .plan-focus-box{border:1px solid var(--line);border-radius:12px;padding:10px 12px;margin:10px 0 12px;background:#fff;}
    .plan-focus-item{border-top:1px dashed #e5e7eb;padding-top:10px;margin-top:10px;}
    .plan-focus-item:first-child{border-top:0;padding-top:0;margin-top:0;}
    .plan-focus-head{font-size:12px;margin-bottom:6px;}
    .plan-focus-obj{font-size:12px;margin-bottom:6px;color:#111827;}
    .plan-focus-meta{font-size:12px;color:#374151;margin-top:4px;}


    .p2-title{display:flex;justify-content:space-between;align-items:center;margin-top:6px}
    .p2-title h2{font-size:18px;font-weight:800}
    .card{border:1px solid var(--line);border-radius:10px;padding:10px;margin-top:8px}
    .result-table th,.result-table td{border-bottom:1px solid #e5e5e5;padding:6px 8px;font-size:13px;text-align:left}
    .result-table th{font-weight:800}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-weight:800;font-size:12px;color:#fff}
    .b-red{background:var(--red)}
    .b-orange{background:var(--orange)}
    .b-green{background:var(--green)}
  
    .complementarias{
      margin-top:14px;
      border-top:1px solid var(--line);
      padding-top:10px;
    }
    .esc-comp-header{
      text-align:center;
      margin-bottom:8px;
    }
    .esc-comp-title{
      font-weight:900;
      font-size:14px;
      text-transform:uppercase;
    }
    .esc-comp-subtitle{
      font-weight:800;
      font-size:12px;
      text-transform:uppercase;
      margin-top:2px;
    }
    @media print{
      .page-1{page-break-after:always}

      .complementarias{ page-break-before: always; break-before: page; border-top:0; padding-top:0; }
    }

  
    /* ===== Integridad layout ===== */
    .rep-head{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
    .rep-brand{display:flex;align-items:center;gap:12px}
    .rep-brand img{width:64px;height:64px;object-fit:contain}
    .rep-title{font-size:20px;font-weight:900;letter-spacing:.2px}
    .rep-subtitle{font-size:13px}
    .rep-meta{font-size:12px;white-space:nowrap}
    .rep-box{border:1px solid var(--line);border-radius:10px;padding:10px 12px;display:grid;grid-template-columns:1fr 1fr;gap:6px 14px;margin:10px 0 8px}
    .row2{display:grid;grid-template-columns:1.2fr .8fr;gap:14px;margin:6px 0 10px}
    .mini{border:1px solid var(--line);border-radius:10px;padding:10px 12px}
    .mini-title{font-weight:900;margin-bottom:8px}
    .curve{position:relative}
    .curve-band{height:14px;border-radius:999px;background:linear-gradient(90deg,#e45757 0%, #f4a338 35%, #2e9b4f 65%, #2e9b4f 100%);opacity:.9}
    .curve-marker{position:absolute;top:-6px;width:0;height:0;border-left:8px solid transparent;border-right:8px solid transparent;border-bottom:12px solid #111;transform:translateX(-8px)}
    .curve-axis{display:flex;justify-content:space-between;font-size:11px;color:var(--muted);margin-top:6px}
    .ivline{font-size:14px;margin:4px 0}
    .cards2x2{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
    .cards2x2 .card{border-radius:12px;background:#bdebf0;display:flex;align-items:center;justify-content:space-between;padding:16px 18px}
    .cards2x2 .card-label{font-weight:900;font-size:18px}
    .cards2x2 .card-score{width:56px;height:44px;border-radius:8px;background:#fff;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:22px}
    .iviRow{display:flex;align-items:center;justify-content:center;gap:22px;margin:18px 0 8px}
    .iviBox{display:flex;align-items:stretch;border:1px solid #222}
    .iviTag{padding:10px 12px;font-weight:900;display:flex;align-items:center}
    .iviVal{padding:10px 16px;background:var(--yellow);font-weight:900;font-size:20px;display:flex;align-items:center}
    .stars{font-size:30px;letter-spacing:3px}
    .star{color:#e5e7eb}
    .star.on{color:#f59e0b}
    .iviLegend{margin-top:6px;font-size:14px}
    .interpGrid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
    .interpCard{border:1px solid var(--line);border-radius:12px;padding:12px 14px}
    .interpHead{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .interpTitle{font-weight:900}
    .interpBadge{border-radius:999px;padding:6px 10px;font-weight:900;background:#eef2ff}
    .interpTxt{color:#111;font-size:14px;line-height:1.35}
    .overall{border:1px solid var(--line);border-radius:12px;padding:12px 14px;margin-top:14px}
    .overallRow{display:flex;gap:12px;align-items:flex-start}
    .overallBadge{border-radius:10px;padding:10px 12px;font-weight:900;background:#111;color:#fff;min-width:56px;text-align:center}
    .overallTxt{font-size:14px;line-height:1.35}
    @media (max-width:720px){
      .rep-box{grid-template-columns:1fr}
      .row2{grid-template-columns:1fr}
      .cards2x2{grid-template-columns:1fr}
      .interpGrid{grid-template-columns:1fr}
    }

  
    .rep-brand img{width:56px;height:56px;object-fit:contain;}
    .rep-title{line-height:1.1}


/* === AFINADOS (overrides) === */
:root{
  --page-max-width: 980px;
  --page-pad-x: 28px;
  --page-pad-y: 22px;
}

/* Jerarquía tipográfica */
h1{ margin:0 0 6px 0; line-height:1.08; letter-spacing:-.2px; }
.subtitle, .subtitulo, .report-subtitle{ margin-top:2px; }

/* Header: logo a la derecha más grande */
.header, .report-header, .topbar, #header, .encabezado{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:18px;
}
.mhp-logo{
  height:82px !important;
  width:auto !important;
  object-fit:contain;
  display:block;
  margin-left:auto;
}

/* Contenedor de página: más aire */
.page, .pagina{
  max-width: var(--page-max-width);
  margin-left:auto;
  margin-right:auto;
  padding: var(--page-pad-y) var(--page-pad-x);
}

/* Separación visual Parte 1 / Parte 2 en pantalla */
@media screen{
  body{ background:#f3f5f8; }
  .page, .pagina{
    background:#fff;
    border:1px solid #e6e8ee;
    border-radius:14px;
    box-shadow:0 10px 30px rgba(0,0,0,.06);
  }
  .page + .page, .pagina + .pagina{ margin-top:34px; }

  /* Evitar colapso del salto en pantalla */
  .page-break{
    height:auto !important;
    margin:0 !important;
    border:0 !important;
    break-after: page;
    page-break-after: always;
  }
}

/* Aire y anti-encimado interno */
.section-title, .titulo-seccion{ margin:10px 0 8px; }
.card, .mini-box, .box{ overflow:hidden; }
.grid2, .two-col, .row2{ gap:18px; }


/* Logo (arriba a la derecha) */
.rep-brand{display:flex;align-items:center;gap:14px;}
.rep-brand > img{order:2;margin-left:18px;}
.rep-brand > div{order:1;}
.mhp-logo{height:175px !important;width:auto !important;object-fit:contain;display:block;margin-left:auto;}

.starNote{margin-top:10px;font-size:12.5px;line-height:1.35;}

.curve{position:relative;}
.curve-svg{position:absolute;inset:6px 8px 22px 8px; width:calc(100% - 16px); height:calc(100% - 28px); pointer-events:none;}
.curve-line{fill:none;stroke:rgba(0,0,0,.45);stroke-width:1.4;}
.curve-fill{fill:rgba(0,0,0,.06);stroke:none;}
.curve-marker{position:absolute;top:6px;bottom:22px;width:2px;background:rgba(0,0,0,.65);}
.curve-marker::after{content:"";position:absolute;top:2px;left:50%;transform:translateX(-50%);width:10px;height:10px;border-radius:999px;background:#111;opacity:.85;}



/* === LOGO a la derecha (sin tocar colores ni cards) === */
.rep-head .rep-brand{
  display:flex !important;
  align-items:center !important;
  gap:14px !important;
  width:100% !important;
}
.rep-head .rep-brand > div{
  flex: 1 1 auto !important;
  text-align:center !important; /* como te gustó */
}
.rep-head .rep-brand #brandLogo{
  margin-left:auto !important;
}


/* === Interpretación (acordeón) === */
.interpGrid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:10px}
@media (max-width: 860px){.interpGrid{grid-template-columns:1fr}}
.interpCard{background:#fff;border:1px solid rgba(0,0,0,.08);border-radius:16px;padding:16px}
.interpHead{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
.interpTitle{font-weight:800;font-size:18px;margin:0 0 6px 0}
.interpBadge{display:inline-flex;align-items:center;gap:8px;font-size:13px;color:#1f2937}
.interpBadge .pill{display:inline-block;padding:4px 10px;border-radius:999px;font-weight:700;font-size:12px;background:rgba(59,130,246,.12);color:#1d4ed8}
.interpBadge .pct{color:#6b7280;font-weight:600}
.interpToggle{width:42px;height:42px;border-radius:999px;border:none;background:rgba(59,130,246,.12);color:#1d4ed8;font-weight:900;font-size:22px;cursor:pointer;flex:0 0 auto}
.interpToggle:hover{filter:brightness(.98)}
.interpBody{margin-top:12px;font-size:14px;line-height:1.55;color:#111827}
.interpBody h4{margin:10px 0 6px 0;font-size:14px}
.interpBody ul{margin:6px 0 10px 18px}
.interpBody li{margin:4px 0}

</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <input id="codigoInput" placeholder="COD001" maxlength="12"/>
    <button class="btn" id="btnVer">Ver reporte</button>
    <span id="msg" class="msg"></span>
  </div>
  <div class="hint">Tip: también puedes abrir ?codigo=COD001</div>

  <div id="reporteContainer" style="display:none">
  <!-- ===== PAGE 1 ===== -->
  <section id="page1" class="page page-break">
    <div class="rep-top">
      <div class="rep-head">
        <div class="rep-brand">
          <img id="brandLogo" alt="ADALAM" src="assets/logo_adalam.png" onerror="this.style.display='none'" class="mhp-logo"/>
          <div>
            <div class="rep-title">Valores de Integridad</div>
            <div class="rep-subtitle muted">Reporte individual</div>
          </div>
        </div>
        <div class="rep-meta muted" id="repDateLine">—</div>
      </div>

      <div class="rep-box" id="repHeaderBox"></div>

      <div class="row2">
        <div class="mini">
          <div class="mini-title">Curva de distribución</div>
          <div class="curve">

            <svg id="curveSvg" class="curve-svg" viewBox="0 0 100 32" preserveAspectRatio="none" aria-hidden="true">
              <path id="curveFill" d="" class="curve-fill"></path>
              <path id="curveLine" d="" class="curve-line"></path>
            </svg>
            <div class="curve-band"></div>
            <div class="curve-marker" id="curveMarker" style="left:0%"></div>
            <div class="curve-axis">
              <span>0</span><span>40</span><span>60</span><span>100</span>
            </div>
          </div>
        </div>

        <div class="mini">
          <div class="mini-title">Índices de validación</div>
          <div class="ivline"><b>Incoherencia</b>: <span id="repIncoh">0%</span></div>
          <div class="ivline"><b>Contradicción</b>: <span id="repContra">0%</span></div>
          <div class="ivline"><b>Tiempo (PT)</b>: <span id="repTiempo">—</span></div>

          <div class="muted" id="ivNote" style="display:none;font-size:12px;margin-top:6px">* Índices calculados automáticamente según patrón de respuesta.</div>
        </div>
      </div>
    </div>

    <div class="cards2x2">
      <div class="card">
        <div class="card-label">Rectitud</div>
        <div class="card-score" id="pctRectitud">—</div>
      </div>
      <div class="card">
        <div class="card-label">Honestidad</div>
        <div class="card-score" id="pctHonestidad">—</div>
      </div>
      <div class="card">
        <div class="card-label">Justicia</div>
        <div class="card-score" id="pctJusticia">—</div>
      </div>
      <div class="card">
        <div class="card-label">Veracidad</div>
        <div class="card-score" id="pctVeracidad">—</div>
      </div>
    </div>

    <div class="iviRow">
      <div class="iviBox">
        <div class="iviTag">IVI</div>
        <div class="iviVal" id="repIVI">—</div>
      </div>
      <div class="stars" id="repStars" aria-label="estrellas">
        <span class="star" data-i="1">★</span>
        <span class="star" data-i="2">★</span>
        <span class="star" data-i="3">★</span>
        <span class="star" data-i="4">★</span>
      </div>
    </div>

    <div class="iviLegend muted" id="iviLegend">Los valores de integridad de esta persona son:</div>

    <div class="starNote muted" id="starNote">
      <b>Estrellas:</b> reflejan el nivel global (IVI) y la consistencia general de las respuestas. 
      A mayor número de estrellas, mayor solidez y coherencia en el perfil observado.
    </div>

  </section>

  <!-- ===== PAGE 2+ (Interpretación) ===== -->
  <section id="page2" class="page">
  <h2 style="margin-top:10px">Interpretación</h2>
  <p class="muted" style="margin-top:0">
    Esta sección describe tus resultados en Valores de Integridad a partir de tus percentiles por subprueba y el IVI (promedio de las cuatro subpruebas).
  </p>

  <div class="interpGrid">
    <!-- Honestidad -->
    <div class="interpCard" data-skill="Honestidad">
      <div class="interpHead">
        <div>
          <div class="interpTitle">Honestidad</div>
          <div id="interpHonBadge" class="interpBadge">—</div>
        </div>
        <button class="interpToggle" type="button" aria-label="Expandir" data-target="interpHonBody">+</button>
      </div>
      <div id="interpHonBody" class="interpBody" style="display:none"></div>
    </div>

    <!-- Rectitud -->
    <div class="interpCard" data-skill="Rectitud">
      <div class="interpHead">
        <div>
          <div class="interpTitle">Rectitud</div>
          <div id="interpRecBadge" class="interpBadge">—</div>
        </div>
        <button class="interpToggle" type="button" aria-label="Expandir" data-target="interpRecBody">+</button>
      </div>
      <div id="interpRecBody" class="interpBody" style="display:none"></div>
    </div>

    <!-- Justicia -->
    <div class="interpCard" data-skill="Justicia">
      <div class="interpHead">
        <div>
          <div class="interpTitle">Justicia</div>
          <div id="interpJusBadge" class="interpBadge">—</div>
        </div>
        <button class="interpToggle" type="button" aria-label="Expandir" data-target="interpJusBody">+</button>
      </div>
      <div id="interpJusBody" class="interpBody" style="display:none"></div>
    </div>

    <!-- Veracidad -->
    <div class="interpCard" data-skill="Veracidad">
      <div class="interpHead">
        <div>
          <div class="interpTitle">Veracidad</div>
          <div id="interpVerBadge" class="interpBadge">—</div>
        </div>
        <button class="interpToggle" type="button" aria-label="Expandir" data-target="interpVerBody">+</button>
      </div>
      <div id="interpVerBody" class="interpBody" style="display:none"></div>
    </div>
  </div>

  <div class="iviBox" id="iviBox2" style="margin-top:14px">
    <div class="iviHead">
      <div class="iviTitle">Lectura global (IVI)</div>
    </div>
    <div class="iviRow">
      <div class="iviScore" id="iviScore2">—</div>
      <div class="iviText" id="iviText2"></div>
    </div>
    <div class="muted" style="font-size:12px;margin-top:10px">
      Nota: Si los índices de validación no están disponibles, el reporte calcula las estrellas solo con el IVI.
    </div>
  </div>

  <!-- ===== PARTE 2 (robusta) ===== -->
  <div id="perfilGlobal" class="interp-bloque" style="margin-top:14px"></div>
  <div id="recomendaciones" class="interp-bloque"></div>
  <div id="planAccion" class="interp-bloque"></div>
</section>
</div>

<script>
  const $ = sel => document.querySelector(sel);
  function clamp(n,min,max){ return Math.max(min,Math.min(max,n)); }
  function normalizeName(name){ return (name||"").replace(/\s+/g," ").trim().toLowerCase(); }

  // Alias de nombres de bloques: permite que el reporte muestre los NUEVOS títulos,
  // pero siga encontrando los datos aunque vengan con nombres anteriores en la BD/API.
  const BLOQUE_ALIAS = {
    // Nuevos -> antiguos (normalizados)
    "desarrollo personal": "habilidades intrapersonales",
    "vínculos interpersonales": "habilidades interpersonales",
    "vinculos interpersonales": "habilidades interpersonales",
    "competencias para la vida": "habilidades para la vida",
    "comunicación interpersonal": "estilos de comunicación interpersonal",
    "comunicacion interpersonal": "estilos de comunicación interpersonal",
    "adaptación al cambio": "propensión al cambio",
    "adaptacion al cambio": "propensión al cambio"
  };

  function canonBloque(name){
    const n = normalizeName(name);
    return BLOQUE_ALIAS[n] || n;
  }


  const DISPLAY = {
    bloque: {
      "desarrollo personal": "DESARROLLO PERSONAL",
      "vínculos interpersonales": "VINCULOS INTERPERSONALES",
      "competencias para la vida": "HABILIDADES PARA LA VIDA",
      "estilos de comunicación interpersonal": "COMUNICACIÓN INTERPERSONAL",
      "propensión al cambio": "ADAPTACIÓN AL CAMBIO",

      "habilidades intrapersonales": "DESARROLLO PERSONAL",
    "habilidades interpersonales": "VINCULOS INTERPERSONALES",
    "habilidades para la vida": "HABILIDADES PARA LA VIDA"
    },
    sub: {}
  };
  // sub mapping (normalizado, sin tildes) construido en runtime:
  (function(){
    const src = {"autoestima": "Autoestima", "manejo de la tension": "Manejo de Estrés", "manejo de la tensión": "Manejo de Estrés", "bienestar fisico": "Hábitos Saludables", "bienestar físico": "Hábitos Saludables", "asertividad": "Expresión Asertiva", "conciencia de los demas": "Percepción de los Demás", "conciencia de los demás": "Percepción de los Demás", "empatia": "Sensibilidad Empática", "empatía": "Sensibilidad Empática", "motivacion": "Motivación Interna", "motivación": "Motivación Interna", "compromiso": "Nivel de Compromiso", "administracion del tiempo": "Organización del Tiempo", "administración del tiempo": "Organización del Tiempo", "toma de decisiones": "Toma de Decisiones", "toma de desiciones": "Toma de Decisiones", "liderazgo": "Liderazgo", "propensión al cambio": "Adaptación al cambio", "propension al cambio": "Adaptación al cambio"};
    const strip = s => (s||"").normalize("NFD").replace(/\p{Diacritic}/gu,"");
    for (const [k,v] of Object.entries(src)) {
      DISPLAY.sub[k] = v;
    }
    DISPLAY._strip = strip;
  })();
function dispBloque(name){
  const canon = canonBloque(name);      // convierte lo que venga a nombre canónico (BD)
  return DISPLAY.bloque[canon] || name; // devuelve el nombre NUEVO si existe
}

  function dispSub(name){
    const strip = DISPLAY._strip;
    const k = strip(normalizeName(name));
    return DISPLAY.sub[k] || name;
  }

  /* Ajuste visual -10 (solo visual, no BD) */
  const SCORE_ADJUST = { ENABLED:true, OFFSET:10, APPLY_TO_RISK:true };
  function isRiskScale(bloqueNorm, subNorm){
    const b = canonBloque(bloqueNorm || "");
    const s = normalizeName(subNorm || "");
    return (b === normalizeName("estilos de comunicación interpersonal") && (s === "agresión" || s === "timidez"));
  }
  function adjScore(v, {bloqueNorm=null, subNorm=null}={}){
    const n = Number(v);
    if(!Number.isFinite(n)) return v;
    if(n<=0) return n;
    if(!SCORE_ADJUST.ENABLED) return Math.round(n);
    if(isRiskScale(bloqueNorm||"", subNorm||"") && !SCORE_ADJUST.APPLY_TO_RISK){
      return clamp(Math.round(n),1,100);
    }
    return clamp(Math.round(n - SCORE_ADJUST.OFFSET),1,100);
  }

  function rangoBadge(p){
    if (p<=40) return {txt:"1–40 Por desarrollar", cls:"b-red"};
    if (p<=70) return {txt:"41–70 Por fortalecer", cls:"b-orange"};
    return {txt:"71–100 Por enriquecer", cls:"b-green"};
  }
  function rangoBadgeRiesgo(p){
    if (p<=40) return {txt:"1–40 Bajo riesgo", cls:"b-green"};
    if (p<=70) return {txt:"41–70 Riesgo medio", cls:"b-orange"};
    return {txt:"71–100 Riesgo alto", cls:"b-red"};
  }

  function highlightIV(rowId, colIndex){
    const row = document.getElementById(rowId);
    if(!row) return;
    [...row.children].forEach(td=>td.classList.remove("hl"));
    const idx = Math.max(1, Math.min(3, colIndex|0));
    const td = row.children[idx];
    if(td) td.classList.add("hl");
  }

  function ivToCol(v){
    if (v === null || v === undefined) return 2;
    const n = Number(v);
    if (!Number.isNaN(n)){
      if (n === 0 || n === 1 || n === 2) return n + 1;
      if (Number.isInteger(n) && n>=1 && n<=3) return n;
      if (n >= 0 && n <= 100){
        if (n >= 71) return 1;
        if (n >= 41) return 2;
        return 3;
      }
    }
    const s = String(v).toLowerCase();
    if (s.includes("no se contradice") || s.includes("tomó el tiempo adecuado") || s.includes("tiempo adecuado")) return 1;
    if (s.includes("se contradice frecuentemente") || s.includes("demasiado lento")) return 3;
    return 2;
  }

  function drawBellCurve(){
    const path = document.getElementById("bellPath");
    const fill = document.getElementById("bellFill");
    if(!path || !fill) return;
    const left=10, right=510, baseY=100, topY=18;
    const mid=(left+right)/2, sigma=90;
    const pts=[];
    for(let x=left; x<=right; x+=5){
      const z=(x-mid)/sigma;
      const y = baseY - Math.exp(-0.5*z*z)*(baseY-topY);
      pts.push([x,y]);
    }
    let d=`M${pts[0][0].toFixed(1)} ${pts[0][1].toFixed(1)}`;
    for(let i=1;i<pts.length;i++) d += ` L${pts[i][0].toFixed(1)} ${pts[i][1].toFixed(1)}`;
    path.setAttribute("d", d);
    const df = d + ` L${right} ${baseY} L${left} ${baseY} Z`;
    fill.setAttribute("d", df);
  }

  function setCurveMarker(iie){
    drawBellCurve();
    const left=10, right=510, baseY=100, topY=18, mid=260, sigma=90;
    const score = clamp(Number(iie)||0,1,100);
    const x = left + (score-1)/99*(right-left);
    const z=(x-mid)/sigma;
    const y = baseY - Math.exp(-0.5*z*z)*(baseY-topY);
    const dot = document.getElementById("curveMarker");
    if(dot){ dot.setAttribute("cx", x); dot.setAttribute("cy", y); }
  }

  function addRow(container, name, pct){
    const row=document.createElement('div');
    row.style.display='grid';
    row.style.gridTemplateColumns='220px 1fr 1fr 1fr';
    row.style.alignItems='center';
    row.style.gap='6px';
    row.style.margin='2px 0';

    const nameCell=document.createElement('div');
    nameCell.textContent=dispSub(name);
    nameCell.style.fontWeight='700';
    nameCell.style.fontSize='12px';
    row.appendChild(nameCell);

    for(let i=0;i<3;i++){ 
      const track=document.createElement('div');
      track.style.position='relative';
      track.style.height='14px';
      track.style.border='1px solid #aab';
      track.style.borderRadius='4px';
      track.style.background='#f3f5f8';
      track.style.overflow='hidden';

      const fill=document.createElement('div');
      fill.style.position='absolute';
      fill.style.left='0';
      fill.style.top='0';
      fill.style.bottom='0';
      fill.style.background='#6b7280';

      let w=0;
      if(i===0 && pct<=40)  w = Math.max(2, Math.round((pct/40)*100));
      if(i===1 && pct>40 && pct<=70) w = Math.max(2, Math.round(((pct-40)/30)*100));
      if(i===2 && pct>70)  w = Math.max(2, Math.round(((pct-70)/30)*100));
      fill.style.width = w + '%';
      track.appendChild(fill);
      row.appendChild(track);
    }
    container.appendChild(row);
  }

  function buildBloque(containerId, subRows, bloqueNombre){
    const cont = document.getElementById(containerId);
    if(!cont) return;
    cont.innerHTML = '';

    const cols = document.createElement('div');
    cols.style.display='grid';
    cols.style.gridTemplateColumns='220px 1fr 1fr 1fr';
    cols.style.gap='6px';
    cols.style.marginBottom='6px';

    const blank=document.createElement('div');
    cols.appendChild(blank);

    ['POR DESARROLLAR','POR FORTALECER','POR ENRIQUECER'].forEach(t=>{
      const d=document.createElement('div');
      d.style.fontSize='11px';
      d.style.textAlign='center';
      d.style.color='#374151';
      d.textContent=t;
      cols.appendChild(d);
    });
    cont.appendChild(cols);

    const bloqueKey = canonBloque(bloqueNombre);
    const ordenes = {
      "desarrollo personal": ["Autoestima","Manejo de Estrés","Hábitos Saludables"],
      "vínculos interpersonales": ["Expresión Asertiva","Percepción de los Demás","Sensibilidad Empática"],
      "competencias para la vida": ["Motivación Interna","Nivel de Compromiso","Organización del Tiempo","Toma de Decisiones","Liderazgo"]
    };

    let rowsFiltradas = (subRows||[]).filter(r=> canonBloque(r.bloque||r.block||"")===bloqueKey);

    const orden = ordenes[bloqueKey];
    if (orden){
      rowsFiltradas.sort((a,b)=>{
        const nameA = (a.subhabilidad || a.sub || a.nombre || "").toLowerCase();
        const nameB = (b.subhabilidad || b.sub || b.nombre || "").toLowerCase();
        const ia = orden.findIndex(x=> x.toLowerCase()===nameA);
        const ib = orden.findIndex(x=> x.toLowerCase()===nameB);
        if (ia===-1 && ib===-1) return nameA.localeCompare(nameB);
        if (ia===-1) return 1;
        if (ib===-1) return -1;
        return ia-ib;
      });
    }

    rowsFiltradas.forEach(r=>{
      const sub = r.subhabilidad || r.sub || r.nombre || "";
      const pctRaw = Math.round(r.percent ?? r.pct ?? r.porcentaje ?? 0);
      const pct = adjScore(pctRaw, {bloqueNorm: bloqueKey, subNorm: normalizeName(sub)});
      addRow(cont, sub, pct);
    });
  }

  function renderBars(containerId, items, showNote){
    const host = document.getElementById(containerId);
    if (!host) return;
    host.innerHTML = "";
    const wrap = document.createElement("div");
    wrap.className = "bars-wrap";

    items.forEach(it => {
      const row = document.createElement("div");
      row.className = "bars-row";

      // Separación visual entre Agresión y Timidez
      if (it.label === "TIMIDEZ") {
        row.style.marginTop = "20px";
      }

      const label = document.createElement("div");
      label.className = "label";
      label.textContent = it.label + " (10–100)";
      row.appendChild(label);

      const slot = document.createElement("div");
      slot.className = "bars-slot";

      [10,40,70,100].forEach(v => {
        const pct = (v - 10) / 90 * 100;
        const tick = document.createElement("div");
        tick.className = "tick";
        tick.style.left = pct + "%";
        slot.appendChild(tick);

        const tLabel = document.createElement("div");
        tLabel.className = "tick-label";
        tLabel.style.left = pct + "%";
        tLabel.textContent = v;
        slot.appendChild(tLabel);
      });

      const marker = document.createElement("div");
      marker.className = "marker";
      marker.id = it.id;
      marker.style.display = "none";
      slot.appendChild(marker);

      row.appendChild(slot);
      wrap.appendChild(row);
    });

    host.appendChild(wrap);

    // Nota SOLO para la Página 1 (no alertas rojas aquí)
    if (showNote) {
      const note = document.createElement("div");
      note.className = "scale-note-inline";
      note.textContent = "Un puntaje bajo indica mejor manejo en estas áreas.";
      host.appendChild(note);
    }
  }

  function setMarker(id, val){
    const el = document.getElementById(id);
    if(!el) return;
    if(val==null || isNaN(val)) { el.style.display="none"; return; }
    const pct = (clamp(val,10,100)-10)/90*100;
    el.style.left = pct + "%";
    el.style.display="block";
  }

  function renderPage2(subRows){
    const subT = document.querySelector("#subTable tbody");
    subT.innerHTML = "";
    (subRows||[]).forEach(r=>{
      const bloque = r.bloque || r.block || "";
      const sub = r.subhabilidad || r.sub || "";
      const items = r.items ?? r.n_items ?? "";
      const puntos = r.puntos ?? r.points ?? r.pts ?? "";
      const pctRaw = Math.round(r.percent ?? r.pct ?? 0);

      const bloqueNorm = canonBloque(bloque);
      const subNorm = normalizeName(sub);

      const pct = adjScore(pctRaw, {bloqueNorm, subNorm});

      let badge;
      if (isRiskScale(bloqueNorm, subNorm)) badge = rangoBadgeRiesgo(pct);
      else badge = rangoBadge(pct);

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${dispBloque(bloque)}</td>
        <td>${dispSub(sub)}</td>
        <td>${items}</td>
        <td>${puntos}</td>
        <td><b>${pct}%</b></td>
        <td><span class="badge ${badge.cls}">${badge.txt}</span></td>
      `;
      subT.appendChild(tr);
    });
  }

  function findSubPct(subRows, bloqueNombre, subNombre){
    const bloqueKey = canonBloque(bloqueNombre);
    const subKey = normalizeName(subNombre);
    const row = (subRows || []).find(r =>
      canonBloque(r.bloque || r.block || "") === bloqueKey &&
      normalizeName(r.subhabilidad || r.sub || r.nombre || "") === subKey
    );
    if(!row) return null;
    const vRaw = Number(row.percent ?? row.pct ?? row.porcentaje ?? row.value);
    if(Number.isNaN(vRaw)) return null;
    return adjScore(vRaw, {bloqueNorm: bloqueKey, subNorm: subKey});
  }

  const BLOQUE_DESCS = {
    desarrollo: "El desarrollo personal reúne capacidades para comprenderse, regularse y cuidarse. Incluye la forma en que la persona se percibe (autoestima), maneja el estrés y sostiene hábitos de hábitos saludables.",
    vinculos: "Los vínculos interpersonales agrupan habilidades para relacionarse de manera respetuosa y efectiva. Incluye la capacidad de vincularse, percibir a los demás y responder con sensibilidad empática.",
    competencias: "Las competencias para la vida son destrezas que favorecen el funcionamiento cotidiano y el logro de metas. Incluye motivación interna, compromiso, organización del tiempo, toma de decisiones y liderazgo.",
    comunicacion: "La comunicación interpersonal describe estilos de interacción. En Agresión y Timidez la interpretación es inversa: puntajes bajos sugieren mejor manejo, mientras que puntajes altos indican mayor riesgo y requieren observación y apoyo.",
    adaptacion: "La adaptación al cambio refleja la apertura y flexibilidad para ajustarse a situaciones nuevas, aceptar transformaciones y promover cambios positivos en el entorno."
  };

  const HABILIDAD_DESCS = {
    "Autoestima": "Es la percepción que una persona tiene de sí misma: cómo se describe, qué cree que puede lograr y cómo interpreta sus propias capacidades.",
    "Manejo del Estrés": "Capacidad para reconocer señales de tensión, regular la respuesta emocional y utilizar estrategias saludables para afrontar presión, frustración o incertidumbre.",
    "Manejo de Estrés": "Capacidad para reconocer señales de tensión, regular la respuesta emocional y utilizar estrategias saludables para afrontar presión, frustración o incertidumbre.",
    "Hábitos Saludables": "Conjunto de hábitos y decisiones orientadas a cuidar el bienestar físico y mental (sueño, alimentación, movimiento, higiene, descanso y límites saludables).",

    "Expresión Asertiva": "Habilidad para construir relaciones positivas, cooperar, resolver desacuerdos y mantener una convivencia respetuosa.",
    "Percepción de los Demás": "Capacidad de observar y comprender señales sociales y emocionales en otras personas (gestos, tono, intención) para relacionarse con mayor ajuste.",
    "Sensibilidad Empática": "Capacidad de ponerse en el lugar del otro, comprender cómo se siente y responder con consideración y apoyo cuando corresponde.",

    "Motivación Interna": "Impulso personal para iniciar y sostener acciones hacia metas, incluso cuando hay dificultad, manteniendo interés y esfuerzo.",
    "Nivel de Compromiso": "Grado en que la persona asume responsabilidades, cumple acuerdos y mantiene constancia con lo que decide o promete.",
    "Organización del Tiempo": "Capacidad de planificar, priorizar y distribuir el tiempo para cumplir tareas y objetivos, evitando la postergación excesiva.",
    "Toma de Decisiones": "Proceso de analizar alternativas, evaluar consecuencias y elegir la opción más adecuada para resolver problemas o alcanzar objetivos.",
    "Liderazgo": "Capacidad de influir de manera positiva, coordinar esfuerzos, motivar a otros y tomar iniciativa para lograr metas comunes.",

    "Agresión": "Tendencia a responder de forma hostil o impulsiva (verbal, física o emocional) ante conflictos o frustración.",
    "Timidez": "Tendencia a inhibirse o evitar interacción social por inseguridad, temor a la evaluación o dificultad para expresarse.",
    "Adaptación al cambio": "Apertura para adaptarse a nuevas condiciones, ideas o rutinas, ajustando conductas y estrategias cuando el contexto lo requiere."
  };

  const DATA_BLOQUE_POR_TITULO = {
    "DESARROLLO PERSONAL": "Habilidades intrapersonales",
    "VINCULOS INTERPERSONALES": "Habilidades interpersonales",
    "HABILIDADES PARA LA VIDA": "Habilidades para la vida",
    "COMUNICACIÓN INTERPERSONAL": "Estilos de comunicación interpersonal",
    "ADAPTACIÓN AL CAMBIO": "Propensión al cambio"
  };

  const SUB_DISPLAY = {
    "Autoestima": "Autoestima",
    "Asertividad": "Expresión Asertiva",
    "Conciencia de los demás": "Percepción de los Demás",
    "Empatía": "Sensibilidad Empática",
    "Compromiso": "Nivel de Compromiso",
    "Motivación": "Motivación Interna",
    "Liderazgo": "Liderazgo",
    "Manejo de la Tensión": "Manejo del Estrés",
    "Manejo de la tensión": "Manejo del Estrés",
    "Administración del tiempo": "Organización del Tiempo",
    "Toma de Decisiones": "Decisión y Elección",
    "Toma de decisiones": "Decisión y Elección",
    "Bienestar físico": "Hábitos Saludables",
    "Propensión al cambio": "Adaptación al cambio",
    "Agresión": "Agresión",
    "Timidez": "Timidez"
  };

  function dispSub(n){
    const key = (n||"").trim();
    return SUB_DISPLAY[key] || key;
  }

  function renderSkillRow(parent, nombre, pct){
    const row = document.createElement("div");
    row.className = "skill-row";

    const title = document.createElement("div");
    title.className = "skill-row-title";
    const numeric = (pct != null && !Number.isNaN(Number(pct))) ? Math.round(pct) : null;
    const nombreDisp = dispSub(nombre);
    title.textContent = numeric != null ? `${nombreDisp} (Puntaje: ${numeric}/100)` : nombreDisp;
    row.appendChild(title);

    const descTxt =
  HABILIDAD_DESCS[nombreDisp] ||
  HABILIDAD_DESCS[nombre] ||
  HABILIDAD_DESCS[Object.keys(SUB_DISPLAY).find(k => SUB_DISPLAY[k] === nombre)] ||
  "";

    if(descTxt){
      const desc = document.createElement("div");
      desc.className = "skill-row-desc";
      desc.textContent = descTxt;
      row.appendChild(desc);
    }

    const bar = document.createElement("div");
    bar.className = "skill-bar";

    const track = document.createElement("div");
    track.className = "skill-bar-track";

    const isAggOrTim = (nombre === "Agresión" || nombre === "Timidez");
    if (isAggOrTim){
      track.style.background =
        "linear-gradient(to right,var(--green) 0%, var(--green) 40%,var(--orange) 40%, var(--orange) 70%,var(--red) 70%, var(--red) 100%)";
    }

    const marker = document.createElement("div");
    marker.className = "skill-bar-marker";
    if(numeric == null) marker.style.display = "none";
    else marker.style.left = clamp(numeric,1,100) + "%";
    track.appendChild(marker);

    const value = document.createElement("div");
    value.className = "skill-bar-value";
    value.textContent = numeric != null ? `${numeric} / 100` : "—";

    bar.appendChild(track);
    bar.appendChild(value);
    row.appendChild(bar);

    parent.appendChild(row);
  }

  function nivelFromPct(p){
    if(p == null || Number.isNaN(p)) return "medio";
    if(p <= 40) return "bajo";
    if(p <= 70) return "medio";
    return "alto";
  }

  const RECOM_BLOQUES = {
    intra: {
      bajo: ["Fortalecer rutinas de hábitos saludables y autoconfianza.","Practicar técnicas breves de regulación emocional (respiración, pausas)."],
      medio: ["Consolidar hábitos de hábitos saludables y reconocer logros alcanzados.","Aplicar estrategias de manejo del estrés en momentos demandantes."],
      alto: ["Proponer metas personales desafiantes y realistas.","Modelar hábitos positivos de hábitos saludables y regulación emocional."]
    },
    inter: {
      bajo: ["Practicar comunicación asertiva con mensajes en primera persona.","Realizar dinámicas guiadas para desarrollar conciencia social y empatía."],
      medio: ["Reforzar escucha activa y respeto por turnos de palabra.","Reconocer conductas prosociales y cooperación."],
      alto: ["Asignar roles de mediación o apoyo entre pares.","Participar en actividades de convivencia y liderazgo positivo."]
    },
    vida: {
      bajo: ["Apoyar planificación diaria con pasos simples y recordatorios.","Acompañar toma de decisiones con análisis de consecuencias."],
      medio: ["Estimular organización del tiempo y cumplimiento de tareas.","Ofrecer roles pequeños de iniciativa y liderazgo con supervisión."],
      alto: ["Asignar responsabilidades estables para potenciar liderazgo.","Involucrar en proyectos donde organice y coordine acciones."]
    }
  };

  function renderRecomendaciones(extras){
    const cont = document.getElementById("recomendaciones");
    if(!cont) return;
    cont.innerHTML = "";

    const header = document.createElement("div");
    header.className = "interp-bloque-header";
    header.innerHTML = `<div class="interp-bloque-nombre">4.- Recomendaciones y plan de acción</div>`;
    cont.appendChild(header);

    const sub = document.createElement("div");
    sub.className = "recom-subtitle";
    sub.textContent = "Las siguientes recomendaciones se generan a partir de los puntajes obtenidos y pueden usarse como guía inicial de acompañamiento.";
    cont.appendChild(sub);

    const lista = document.createElement("ul");
    lista.className = "recom-list";

    const nIntra = nivelFromPct(extras.bIntra);
    const nInter = nivelFromPct(extras.bInter);
    const nPV    = nivelFromPct(extras.bPV);

    (RECOM_BLOQUES.intra[nIntra] || []).forEach(t=>{ const li=document.createElement("li"); li.textContent = "DESARROLLO PERSONAL: " + t; lista.appendChild(li); });
    (RECOM_BLOQUES.inter[nInter] || []).forEach(t=>{ const li=document.createElement("li"); li.textContent = "VINCULOS INTERPERSONALES: " + t; lista.appendChild(li); });
    (RECOM_BLOQUES.vida[nPV] || []).forEach(t=>{ const li=document.createElement("li"); li.textContent = "HABILIDADES PARA LA VIDA: " + t; lista.appendChild(li); });

    if(extras.agresionVal != null && extras.agresionVal > 70){
      const li=document.createElement("li");
      li.textContent = "COMUNICACIÓN INTERPERSONAL (Agresión): trabajar control de impulsos y alternativas para expresar enojo sin dañar a otros.";
      lista.appendChild(li);
    }
    if(extras.timidezVal != null && extras.timidezVal > 70){
      const li=document.createElement("li");
      li.textContent = "COMUNICACIÓN INTERPERSONAL (Timidez): favorecer participación gradual en actividades grupales con apoyo de un adulto.";
      lista.appendChild(li);
    }
    if(extras.propCambioVal != null){
      if(extras.propCambioVal <= 40){
        const li=document.createElement("li");
        li.textContent = "ADAPTACIÓN AL CAMBIO: acompañar procesos de cambio con anticipación y tiempos de adaptación.";
        lista.appendChild(li);
      } else if(extras.propCambioVal >= 71){
        const li=document.createElement("li");
        li.textContent = "ADAPTACIÓN AL CAMBIO: aprovechar apertura para proyectos innovadores e iniciativas de mejora.";
        lista.appendChild(li);
      }
    }

    cont.appendChild(lista);
  }

  function renderPlanAccion(extras){
    const cont = document.getElementById("planAccion");
    if(!cont) return;
    cont.innerHTML = "";

    const header=document.createElement("div");
    header.className="interp-bloque-header";
    header.innerHTML = `<div class="interp-bloque-nombre">Plan de acción sugerido</div>`;
    cont.appendChild(header);

    const sub=document.createElement("div");
    sub.className="recom-subtitle";
    sub.textContent="Orientaciones generales para acompañar el desarrollo socioemocional. No reemplaza valoración clínica.";
    cont.appendChild(sub);

    const mkList=(title, items)=>{
      const t=document.createElement("div"); t.className="plan-section-title"; t.textContent=title; cont.appendChild(t);
      const ul=document.createElement("ul"); ul.className="recom-list";
      items.forEach(x=>{ const li=document.createElement("li"); li.textContent=x; ul.appendChild(li); });
      cont.appendChild(ul);
    };

    mkList("En el hogar / familia:", [
      "Conversar diariamente sobre emociones y experiencias del día (validación).",
      "Reconocer esfuerzos y avances con mensajes concretos.",
      "Mantener rutinas claras de estudio, descanso y ocio."
    ]);

    mkList("En el aula / institución educativa:", [
      "Promover respeto, colaboración y expresión emocional adecuada.",
      "Observar conductas socioemocionales relevantes y coordinar con la familia.",
      "Incluir actividades breves de educación emocional."
    ]);

    mkList("Con apoyo del orientador / psicólogo:", [
      "Si las dificultades se sostienen o son intensas, considerar evaluación más profunda y acompañamiento especializado.",
      "Mantener comunicación periódica entre familia y escuela para alinear estrategias."
    ]);

    const foot=document.createElement("div");
    foot.style.textAlign="right";
    foot.style.fontSize="10px";
    foot.style.color="var(--muted)";
    foot.style.marginTop="8px";
    foot.textContent="IPLAED CORP 2025";
    cont.appendChild(foot);
  }

  function renderPerfilGlobal(extras){
    const cont = document.getElementById("perfilGlobal");
    if(!cont) return;
    cont.innerHTML = "";

    const header = document.createElement("div");
    header.className = "interp-bloque-header";
    header.innerHTML = `<div class="interp-bloque-nombre">3.- Perfil cuantitativo global</div>`;
    cont.appendChild(header);

    const p = document.createElement("div");
    p.className = "interp-bloque-desc";
    const nombre = extras.nombre || "el participante";
    p.textContent = `Del reporte individual de ${nombre} se desprenden los siguientes índices:`;
    cont.appendChild(p);

    const ul = document.createElement("ul");
    ul.className = "recom-list";

    const fmt = v => (v != null && !Number.isNaN(v)) ? Math.round(v) : "—";

    [
      `Índice de Desarrollo Personal: ${fmt(extras.bIntra)}`,
      `Índice de Vínculos Interpersonales: ${fmt(extras.bInter)}`,
      `Índice de Habilidades para la Vida: ${fmt(extras.bPV)}`,
      `Índice Global de Inteligencia Emocional (IIE): ${fmt(extras.iieFinal)}`
    ].forEach(t=>{
      const li = document.createElement("li");
      li.textContent = t;
      ul.appendChild(li);
    });

    cont.appendChild(ul);

    const subt = document.createElement("div");
    subt.className = "plan-section-title";
    subt.textContent = "Comunicación interpersonal (en estas escalas puntajes bajos indican mejor manejo):";
    cont.appendChild(subt);

    const ul2 = document.createElement("ul");
    ul2.className = "recom-list";

    const liA = document.createElement("li");
    liA.textContent = "Agresión: " + fmt(extras.agresionVal);
    if (extras.agresionVal != null && !Number.isNaN(extras.agresionVal) && extras.agresionVal > 70){
      liA.classList.add("skill-row-alert");
      liA.textContent += " (rango alto, requiere atención y acompañamiento).";
    }
    ul2.appendChild(liA);

    const liT = document.createElement("li");
    liT.textContent = "Timidez: " + fmt(extras.timidezVal);
    if (extras.timidezVal != null && !Number.isNaN(extras.timidezVal) && extras.timidezVal > 70){
      liT.classList.add("skill-row-alert");
      liT.textContent += " (rango alto, sugiere inhibición social significativa).";
    }
    ul2.appendChild(liT);

    cont.appendChild(ul2);

    const subt2 = document.createElement("div");
    subt2.className = "plan-section-title";
    subt2.textContent = "Adaptación al cambio:";
    cont.appendChild(subt2);

    const ul3 = document.createElement("ul");
    ul3.className = "recom-list";
    const liC = document.createElement("li");
    liC.textContent = "Adaptación al cambio: " + fmt(extras.propCambioVal) + " (a mayor puntaje, mayor apertura al cambio).";
    ul3.appendChild(liC);
    cont.appendChild(ul3);
  }

  function renderBloqueInterpretacion(containerId, tituloDisplay, bloqueKeyOriginal, bloqueDescKey, subRows, pctBloqueVal){
    const cont=document.getElementById(containerId);
    if(!cont) return;
    cont.innerHTML="";

    const idxText=(pctBloqueVal!=null && !Number.isNaN(pctBloqueVal)) ? pctBloqueVal : "—";
    const header=document.createElement("div");
    header.className="interp-bloque-header";
    header.innerHTML=`<div class="interp-bloque-nombre">${tituloDisplay}</div><div class="interp-bloque-indice">Índice: <span>${idxText}</span></div>`;
    cont.appendChild(header);

    const desc=document.createElement("div");
    desc.className="interp-bloque-desc";
    desc.textContent=BLOQUE_DESCS[bloqueDescKey] || "";
    cont.appendChild(desc);

    const bloqueKey = canonBloque(bloqueKeyOriginal);
    let rows=(subRows||[]).filter(r=> canonBloque(r.bloque||r.block||"")===bloqueKey);

    rows.forEach(r=>{
      const sub=r.subhabilidad || r.sub || r.nombre || "";
      const pctRaw=Number(r.percent ?? r.pct ?? r.porcentaje ?? r.value ?? null);
      const pct=(pctRaw!=null && !Number.isNaN(pctRaw)) ? adjScore(pctRaw, {bloqueNorm: bloqueKey, subNorm: normalizeName(sub)}) : null;
      renderSkillRow(cont, dispSub(sub), pct);
    });
  }

  function renderInterpretacion(subRows, extras){
    const date1=document.getElementById("repDateLine");
    const date2=document.getElementById("repDateLine2");
    const dateEsc=document.getElementById("repDateLineEsc");
    if(date1 && date2) date2.textContent = date1.textContent;
    if(date1 && dateEsc) dateEsc.textContent = date1.textContent;

    const h1=document.getElementById("repHeaderBox");
    const h2=document.getElementById("repHeaderBox2");
    if(h1 && h2) h2.innerHTML = h1.innerHTML;

    renderBloqueInterpretacion("interpIntra","DESARROLLO PERSONAL","Desarrollo Personal","desarrollo", subRows, extras.bIntra);
    renderBloqueInterpretacion("interpInter","VINCULOS INTERPERSONALES","Vínculos Interpersonales","vinculos", subRows, extras.bInter);
    renderBloqueInterpretacion("interpPV","HABILIDADES PARA LA VIDA","Competencias Para la Vida","competencias", subRows, extras.bPV);

    const estCont=document.getElementById("interpEstilos");
    if(estCont){
      estCont.innerHTML="";
      const header=document.createElement("div");
      header.className="interp-bloque-header";
      header.innerHTML=`<div class="interp-bloque-nombre">COMUNICACIÓN INTERPERSONAL</div>`;
      estCont.appendChild(header);

      const desc=document.createElement("div");
      desc.className="interp-bloque-desc";
      desc.textContent=BLOQUE_DESCS.estilos;
      estCont.appendChild(desc);

      renderSkillRow(estCont, "Agresión", extras.agresionVal);
      renderSkillRow(estCont, "Timidez", extras.timidezVal);
    }

    const cambCont=document.getElementById("interpCambio");
    if(cambCont){
      cambCont.innerHTML="";
      const header=document.createElement("div");
      header.className="interp-bloque-header";
      header.innerHTML=`<div class="interp-bloque-nombre">ADAPTACIÓN AL CAMBIO</div>`;
      cambCont.appendChild(header);

      const desc=document.createElement("div");
      desc.className="interp-bloque-desc";
      desc.textContent=BLOQUE_DESCS.cambio;
      cambCont.appendChild(desc);

      renderSkillRow(cambCont, "Adaptación al cambio", extras.propCambioVal);
    }

    renderPerfilGlobal(extras);
    renderRecomendaciones(extras);
    renderPlanAccion(extras);
  }

  

  // ================================
  // PARTE 2 (INTEGRIDAD) - robusta
  // ================================

  function escapeHtml(s){
    return String(s ?? "")
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#39;");
  }

  const INTEGRIDAD_SKILLS = [
    {key:"Honestidad", idBadge:"interpHonBadge", idBody:"interpHonBody"},
    {key:"Rectitud",   idBadge:"interpRecBadge", idBody:"interpRecBody"},
    {key:"Justicia",   idBadge:"interpJusBadge", idBody:"interpJusBody"},
    {key:"Veracidad",  idBadge:"interpVerBadge", idBody:"interpVerBody"},
  ];

  const INTEGRIDAD_DESC = {
    "Honestidad": "Se refiere a actuar con transparencia, reconocer errores y evitar beneficios injustos. Implica coherencia entre lo que se piensa, se dice y se hace.",
    "Rectitud": "Capacidad de sostener principios éticos aun cuando hay presión externa. Incluye autocontrol, respeto por normas y consistencia conductual.",
    "Justicia": "Tendencia a decidir y actuar considerando equidad, reglas claras y trato imparcial. Incluye sensibilidad ante privilegios y favoritismos.",
    "Veracidad": "Compromiso con la verdad en la comunicación: precisión, evitar exageración u omisiones relevantes, y cuidar la confianza que se genera."
  };

  // Recomendaciones por nivel (1-40 / 41-70 / 71-100)
  const INTEGRIDAD_RECOM = {
    "Honestidad": {
      bajo: [
        "Establecer un acuerdo personal de transparencia: decir la verdad incluso en situaciones pequeñas (1–2 semanas).",
        "Registrar 3 momentos diarios donde se eligió la opción correcta (refuerzo de conducta)."
      ],
      medio: [
        "Consolidar hábitos de claridad: explicar decisiones y reconocer errores sin justificarse en exceso.",
        "Practicar “reparación”: si hubo una omisión o error, corregirlo en menos de 24 horas."
      ],
      alto: [
        "Modelar integridad: compartir buenas prácticas con pares (sin señalar a otros).",
        "Sostener consistencia bajo presión: anticipar dilemas y preparar respuestas (plan de 2 pasos)."
      ]
    },
    "Rectitud": {
      bajo: [
        "Definir 3 reglas no negociables (por ejemplo: no copiar, no tomar lo ajeno, no mentir) y revisarlas semanalmente.",
        "Entrenar autocontrol con pausas de 10 segundos antes de responder en conflictos."
      ],
      medio: [
        "Reforzar límites y autocontrol: usar “pausa + alternativa” ante tentaciones o presión.",
        "Mantener rutinas de responsabilidad (cumplir acuerdos y horarios) 4 días/semana."
      ],
      alto: [
        "Asumir responsabilidades estables (encargos, seguimiento de tareas, cumplimiento de normas).",
        "Apoyar clima ético: proponer mejoras simples a reglas/procesos cuando sea necesario."
      ]
    },
    "Justicia": {
      bajo: [
        "Practicar decisiones imparciales: aplicar la misma regla para todos (lista de criterios).",
        "Hacer un ejercicio semanal de ‘perspectiva’: ¿cómo se sentiría la otra persona?"
      ],
      medio: [
        "Consolidar trato equitativo: turnos, reparto de tareas, y reconocimiento sin favoritismos.",
        "Resolver desacuerdos con criterios claros (hechos → regla → consecuencia)."
      ],
      alto: [
        "Promover cooperación y mediación: ayudar a resolver conflictos con neutralidad.",
        "Participar en roles de organización donde se cuide la equidad (equipo, aula, trabajo)."
      ]
    },
    "Veracidad": {
      bajo: [
        "Entrenar precisión: describir hechos sin exagerar (qué pasó, cuándo, quién, evidencia).",
        "Evitar omisiones: antes de comunicar, revisar 3 preguntas (¿es cierto? ¿es completo? ¿es respetuoso?)."
      ],
      medio: [
        "Reforzar comunicación confiable: aclarar dudas y corregir información si fue imprecisa.",
        "Practicar mensajes breves y directos (sin adornos) en situaciones relevantes."
      ],
      alto: [
        "Modelar confianza: mantener coherencia entre lo que se promete y lo que se entrega.",
        "Promover cultura de evidencia: respaldar afirmaciones con datos o hechos verificables."
      ]
    }
  };

  // Pack accionable para “Prioridades según puntaje”
  const PLAN_FOCO = {
    "Honestidad": {
      bajo:{objetivo:"Fortalecer transparencia en decisiones y comunicación.", acciones:[
        "Registro diario: 1 decisión honesta + por qué fue importante (5 días/sem).",
        "Reparación en <24h si hubo omisión o error (si aplica).",
        "Compromiso visible: definir 1 regla personal y cumplirla (semanal)."
      ], indicador:"≥5 registros/sem + 1 reparación o aclaración cuando corresponda.", revision:"Revisión semanal (5 min) con adulto/mentor."},
      medio:{objetivo:"Consolidar consistencia y reparación oportuna.", acciones:[
        "Revisar acuerdos y cumplirlos (4 días/sem).",
        "Comunicación clara: explicar decisiones relevantes (2 veces/sem).",
        "Corrección inmediata de imprecisiones (cuando ocurra)."
      ], indicador:"Cumplimiento 4 días/sem + 2 comunicaciones claras/sem.", revision:"Revisión quincenal."},
      alto:{objetivo:"Sostener modelaje y coherencia bajo presión.", acciones:[
        "Anticipar dilemas: plan de respuesta (1 vez/sem).",
        "Modelar buenas prácticas con pares (1 vez/sem).",
        "Mantener coherencia promesa–entrega (seguimiento semanal)."
      ], indicador:"1 plan/sem + 1 modelaje/sem.", revision:"Revisión mensual."}
    },
    "Rectitud": {
      bajo:{objetivo:"Reducir impulsividad y fortalecer autocontrol ético.", acciones:[
        "Pausa de 10 segundos antes de responder en tensión (diario).",
        "Lista de 3 reglas no negociables (revisión semanal).",
        "Elegir alternativa segura ante presión de pares (2 situaciones/sem)."
      ], indicador:"Aplicación de pausa ≥5 días/sem + 2 situaciones/sem con alternativa.", revision:"Revisión semanal."},
      medio:{objetivo:"Sostener límites y hábitos responsables.", acciones:[
        "Rutina de responsabilidad (4 días/sem).",
        "Pausa + alternativa ante tentación (2 veces/sem).",
        "Autoevaluación breve: ¿qué hice bien? (semanal)."
      ], indicador:"Rutina 4 días/sem + 2 pausas/sem.", revision:"Revisión quincenal."},
      alto:{objetivo:"Potenciar responsabilidades y mejora de normas/procesos.", acciones:[
        "Asumir 1 responsabilidad estable (semanal).",
        "Proponer 1 mejora simple a normas/procesos (mensual).",
        "Acompañar cumplimiento de acuerdos del grupo (semanal)."
      ], indicador:"1 responsabilidad/sem + 1 mejora/mes.", revision:"Revisión mensual."}
    },
    "Justicia": {
      bajo:{objetivo:"Fortalecer decisiones imparciales y empatía.", acciones:[
        "Criterios claros antes de decidir (2 veces/sem).",
        "Ejercicio de perspectiva (semanal).",
        "Reparto equitativo de tareas (cuando aplique)."
      ], indicador:"2 decisiones/sem con criterios + 1 perspectiva/sem.", revision:"Revisión quincenal."},
      medio:{objetivo:"Consolidar trato equitativo y resolución objetiva de conflictos.", acciones:[
        "Turnos y reglas claras (semanal).",
        "Resolver desacuerdos con hechos→regla→consecuencia (2 situaciones/sem).",
        "Reconocer cooperación sin favoritismos (semanal)."
      ], indicador:"2 situaciones/sem resueltas con criterio + 1 reconocimiento/sem.", revision:"Revisión quincenal."},
      alto:{objetivo:"Promover mediación y equidad en el grupo.", acciones:[
        "Rol de apoyo/mediación (semanal).",
        "Actividad grupal con reglas equitativas (semanal).",
        "Revisión de decisiones sensibles (mensual)."
      ], indicador:"1 rol/sem + 1 actividad/sem.", revision:"Revisión mensual."}
    },
    "Veracidad": {
      bajo:{objetivo:"Mejorar precisión y completitud al comunicar.", acciones:[
        "Antes de comunicar: 3 preguntas (cierto/completo/respetuoso) (diario).",
        "Resumen de hechos sin exagerar (2 veces/sem).",
        "Corregir información imprecisa (cuando ocurra)."
      ], indicador:"Uso de checklist ≥5 días/sem + 2 resúmenes/sem.", revision:"Revisión semanal."},
      medio:{objetivo:"Consolidar comunicación confiable y corrección oportuna.", acciones:[
        "Mensajes breves y directos (2 veces/sem).",
        "Aclarar dudas cuando haya ambigüedad (semanal).",
        "Corregir imprecisiones en <24h (si aplica)."
      ], indicador:"2 mensajes directos/sem + 1 aclaración/sem.", revision:"Revisión quincenal."},
      alto:{objetivo:"Sostener confianza y cultura de evidencia.", acciones:[
        "Respaldar afirmaciones relevantes con hechos/datos (semanal).",
        "Cuidar coherencia promesa–entrega (semanal).",
        "Modelar prácticas de transparencia (mensual)."
      ], indicador:"1 respaldo/sem + coherencia semanal.", revision:"Revisión mensual."}
    }
  };

  function nivelLabel(p){
    const n = nivelFromPct(p);
    if(n==="bajo") return {nivel:"bajo", label:"1–40 Por desarrollar"};
    if(n==="medio") return {nivel:"medio", label:"41–70 Por fortalecer"};
    return {nivel:"alto", label:"71–100 Por enriquecer"};
  }

  function setInterpCard(skill, pct){
    const badgeEl = document.getElementById(INTEGRIDAD_SKILLS.find(x=>x.key===skill)?.idBadge || "");
    const bodyEl  = document.getElementById(INTEGRIDAD_SKILLS.find(x=>x.key===skill)?.idBody  || "");
    if(!badgeEl || !bodyEl) return;

    const p = (pct==null || Number.isNaN(pct)) ? null : Math.round(Number(pct));
    const lvl = p==null ? {nivel:"medio", label:"—"} : nivelLabel(p);

    badgeEl.innerHTML = `<span class="pill">${lvl.label}</span> <span class="pct">${p==null ? "—" : (p + "/100")}</span>`;

    const desc = INTEGRIDAD_DESC[skill] || "";
    const recs = (INTEGRIDAD_RECOM[skill] && INTEGRIDAD_RECOM[skill][lvl.nivel]) ? INTEGRIDAD_RECOM[skill][lvl.nivel] : [];

    bodyEl.innerHTML = `
      <div class="muted" style="margin-bottom:8px">${escapeHtml(desc)}</div>
      <h4>Enfoque práctico (2–3 semanas)</h4>
      <ul>
        ${recs.map(r=>`<li>${escapeHtml(r)}</li>`).join("")}
      </ul>
      <h4>Indicador de avance</h4>
      <div class="muted">Evidencias simples: cumplimiento de acuerdos, coherencia en decisiones, y calidad de comunicación (precisa y completa).</div>
    `;
  }

  function renderPerfilGlobalIntegridad(extras){
    const cont = document.getElementById("perfilGlobal");
    if(!cont) return;
    cont.innerHTML = "";

    const header = document.createElement("div");
    header.className = "interp-bloque-header";
    header.innerHTML = `<div class="interp-bloque-nombre">3.- Perfil cuantitativo global</div>`;
    cont.appendChild(header);

    const p = document.createElement("div");
    p.className = "interp-bloque-desc";
    p.textContent = `Del reporte individual se desprenden los siguientes índices:`;
    cont.appendChild(p);

    const ul = document.createElement("ul");
    ul.className = "recom-list";
    const fmt = v => (v!=null && !Number.isNaN(v)) ? Math.round(v) : "—";

    [
      `Honestidad: ${fmt(extras.honestidad)}/100`,
      `Rectitud: ${fmt(extras.rectitud)}/100`,
      `Justicia: ${fmt(extras.justicia)}/100`,
      `Veracidad: ${fmt(extras.veracidad)}/100`,
      `Índice de Valores de Integridad (IVI): ${fmt(extras.ivi)}/100`
    ].forEach(t=>{
      const li=document.createElement("li"); li.textContent=t; ul.appendChild(li);
    });

    // Validación
    const liV = document.createElement("li");
    liV.textContent = `Validación: Incoherencia ${fmt(extras.incoh)}% · Contradicción ${fmt(extras.nc)} pts · Tiempo (PT): ${extras.ptLabel || "—"}`;
    ul.appendChild(liV);

    cont.appendChild(ul);
  }

  function renderRecomendacionesIntegridad(extras){
    const cont = document.getElementById("recomendaciones");
    if(!cont) return;
    cont.innerHTML = "";

    const header = document.createElement("div");
    header.className = "interp-bloque-header";
    header.innerHTML = `<div class="interp-bloque-nombre">4.- Recomendaciones y plan de acción</div>`;
    cont.appendChild(header);

    const sub = document.createElement("div");
    sub.className = "recom-subtitle";
    sub.textContent = "Las siguientes recomendaciones se generan a partir de los puntajes obtenidos y pueden usarse como guía inicial de acompañamiento.";
    cont.appendChild(sub);

    const lista = document.createElement("ul");
    lista.className = "recom-list";

    const items = [
      {k:"Honestidad", v: extras.honestidad},
      {k:"Rectitud", v: extras.rectitud},
      {k:"Justicia", v: extras.justicia},
      {k:"Veracidad", v: extras.veracidad},
    ];

    items.forEach(it=>{
      const p = (it.v==null || Number.isNaN(it.v)) ? null : Math.round(Number(it.v));
      const n = nivelFromPct(p);
      const recs = (INTEGRIDAD_RECOM[it.k] && INTEGRIDAD_RECOM[it.k][n]) ? INTEGRIDAD_RECOM[it.k][n] : [];
      recs.slice(0,2).forEach(t=>{
        const li=document.createElement("li");
        li.textContent = `${it.k.toUpperCase()}: ${t}`;
        lista.appendChild(li);
      });
    });

    cont.appendChild(lista);
  }

  function renderPlanAccionIntegridad(extras){
    const cont = document.getElementById("planAccion");
    if(!cont) return;
    cont.innerHTML = "";

    const header=document.createElement("div");
    header.className="interp-bloque-header";
    header.innerHTML = `<div class="interp-bloque-nombre">Plan de acción sugerido</div>`;
    cont.appendChild(header);

    const sub=document.createElement("div");
    sub.className="recom-subtitle";
    sub.textContent="Orientaciones generales y prioridades accionables. No reemplaza valoración clínica.";
    cont.appendChild(sub);

    // ===== Prioridades según puntaje (Top 3) =====
    const items = [
      { key:"Honestidad",  pct: extras.honestidad },
      { key:"Rectitud",    pct: extras.rectitud },
      { key:"Justicia",    pct: extras.justicia },
      { key:"Veracidad",   pct: extras.veracidad },
    ];
    items.forEach(it => it.nivel = nivelFromPct(it.pct));
    const ord = { bajo: 0, medio: 1, alto: 2 };
    items.sort((a,b)=> (ord[a.nivel]??9) - (ord[b.nivel]??9));

    const candidatos = items.filter(x => x.nivel !== "alto");
    const focos = (candidatos.length ? candidatos : items).slice(0,3);

    const box = document.createElement("div");
    box.className = "plan-focus-box";
    box.innerHTML = `<div class="plan-section-title">Prioridades según puntaje (Top 3)</div>`;

    focos.forEach(f=>{
      const pack = PLAN_FOCO[f.key]?.[f.nivel];
      if(!pack) return;

      const sec = document.createElement("div");
      sec.className = "plan-focus-item";
      sec.innerHTML = `
        <div class="plan-focus-head"><b>${escapeHtml(f.key)}</b> — ${escapeHtml(f.nivel)} (${Math.round(Number(f.pct)||0)}/100)</div>
        <div class="plan-focus-obj"><b>Objetivo (2–3 semanas):</b> ${escapeHtml(pack.objetivo)}</div>
        <ul class="recom-list">${pack.acciones.map(a=>`<li>${escapeHtml(a)}</li>`).join("")}</ul>
        <div class="plan-focus-meta"><b>Indicador:</b> ${escapeHtml(pack.indicador)}</div>
        <div class="plan-focus-meta"><b>Revisión:</b> ${escapeHtml(pack.revision)}</div>
      `;
      box.appendChild(sec);
    });
    cont.appendChild(box);
    // ===== Fin prioridades =====

    // Acciones generales (se mantienen)
    const mkList=(title, items)=>{
      const t=document.createElement("div"); t.className="plan-section-title"; t.textContent=title; cont.appendChild(t);
      const ul=document.createElement("ul"); ul.className="recom-list";
      items.forEach(x=>{ const li=document.createElement("li"); li.textContent=x; ul.appendChild(li); });
      cont.appendChild(ul);
    };

    mkList("En el hogar / familia:", [
      "Modelar conductas de integridad: cumplir acuerdos y reconocer errores sin castigo excesivo.",
      "Establecer reglas claras y consecuencias consistentes (no impulsivas).",
      "Revisar semanalmente situaciones donde fue difícil actuar con integridad."
    ]);

    mkList("En el aula / institución educativa / equipo:", [
      "Promover reglas explícitas de convivencia y ética (claridad sobre lo permitido/no permitido).",
      "Reconocer conductas de honestidad y reparación (refuerzo positivo).",
      "Usar criterios transparentes en decisiones y evaluaciones (equidad)."
    ]);

    mkList("Con apoyo del orientador / psicólogo / HR:", [
      "Si los índices de validación son altos o hay señales de riesgo, profundizar con entrevista y seguimiento.",
      "Alinear familia–escuela/trabajo en estrategias (metas y evidencias observables)."
    ]);

    const foot=document.createElement("div");
    foot.style.textAlign="right";
    foot.style.fontSize="10px";
    foot.style.color="var(--muted)";
    foot.style.marginTop="8px";
    foot.textContent="IPLAED CORP 2025";
    cont.appendChild(foot);
  }

  function renderParte2Integridad(extras){
    // tarjetas (acordeón)
    setInterpCard("Honestidad", extras.honestidad);
    setInterpCard("Rectitud",   extras.rectitud);
    setInterpCard("Justicia",   extras.justicia);
    setInterpCard("Veracidad",  extras.veracidad);

    // global IVI (parte superior de página 2)
    const s2 = document.getElementById("iviScore2");
    const t2 = document.getElementById("iviText2");
    if (s2) s2.textContent = extras.ivi != null ? Math.round(extras.ivi) : "—";
    if (t2) t2.textContent = interpGlobal(extras.ivi, extras.stars);

    // bloques 3 y 4 + plan
    renderPerfilGlobalIntegridad(extras);
    renderRecomendacionesIntegridad(extras);
    renderPlanAccionIntegridad(extras);
  }
function renderAll(data){
  window.__LAST_REPORT__ = data;
  const attempt = data.attempt || data;
  const snap = attempt.snapshot || attempt.snap || attempt;

  const resultados = attempt.resultados || attempt.resultados_json || attempt.result || {};
  const subRows = attempt.subhabilidades || resultados.subhabilidades || attempt.subRows || attempt.sub || [];
  const fechaRaw = attempt.created_at || attempt.creado_en || attempt.fecha_intento;
  const fechaObj = fechaRaw ? new Date(fechaRaw) : null;
  const ahora = new Date();
  document.getElementById("repDateLine").textContent = ahora.toLocaleString("es-EC", { dateStyle:"short", timeStyle:"short" });

  const fechaTexto = fechaObj ? fechaObj.toLocaleDateString("es-EC", { year:"numeric", month:"long", day:"2-digit" }) : "—";
  const nombre = snap.nombre || attempt.nombre || "—";
  document.getElementById("repHeaderBox").innerHTML = `
    <div><b>Nombre:</b> ${nombre}</div>
    <div><b>Curso/Grado:</b> ${snap.curso || attempt.curso || "—"}</div>
    <div><b>Grupo:</b> ${snap.grupo || attempt.grupo || "—"}</div>
    <div><b>Institución:</b> ${snap.institucion || attempt.institucion || "—"}</div>
    <div><b>Fecha:</b> ${fechaTexto}</div>
  `;

  function normalizeName(s){ return (s||"").toString().trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,""); }

  function pctSub(nombreSub){
    const target = normalizeName(nombreSub);
    let raw = null;
    if(Array.isArray(subRows)){
      const f = subRows.find(r => normalizeName(r.sub || r.subhabilidad || r.nombre || "") === target);
      if (f) raw = (f.pct ?? f.percent ?? f.porcentaje ?? null);
    }
    if (raw == null && resultados && resultados.subhabilidades && Array.isArray(resultados.subhabilidades)){
      const f = resultados.subhabilidades.find(r => normalizeName(r.sub || r.subhabilidad || r.nombre || "") === target);
      if (f) raw = (f.pct ?? f.percent ?? f.porcentaje ?? null);
    }
    if (raw == null) return 0;
    return Math.round(Number(raw) || 0);
  }

  const pHon = pctSub("Honestidad");
  const pRec = pctSub("Rectitud");
  const pJus = pctSub("Justicia");
  const pVer = pctSub("Veracidad");

  document.getElementById("pctHonestidad").textContent = pHon || "—";
  document.getElementById("pctRectitud").textContent = pRec || "—";
  document.getElementById("pctJusticia").textContent = pJus || "—";
  document.getElementById("pctVeracidad").textContent = pVer || "—";

  const vals = [pHon,pRec,pJus,pVer].filter(v => typeof v === "number" && v > 0);
  const ivi = vals.length ? Math.round(vals.reduce((a,b)=>a+b,0)/vals.length) : 0;
  document.getElementById("repIVI").textContent = ivi || "—";
  buildCurveSvg();
  setCurveMarker(ivi || 0);

  
  const incoh = attempt.incoherencia ?? attempt.incoherencia_pct ?? attempt.incoherenciaPct ?? (resultados.validacion && (resultados.validacion.incoherencia ?? resultados.validacion.incoherencia_pct));
  const contra = attempt.contradiccion ?? attempt.contradiccion_pct ?? attempt.contradiccionPct ?? (resultados.validacion && (resultados.validacion.contradiccion ?? resultados.validacion.contradiccion_pct));

  let incohN = (incoh == null || incoh === "") ? null : Math.round(Number(incoh));
  let contraN = (contra == null || contra === "") ? null : Math.round(Number(contra));

  if ((incohN == null || Number.isNaN(incohN)) && (contraN == null || Number.isNaN(contraN))) {
    const est = estimateValidation(attempt);
    if (est){
      incohN = est.incoh;
      contraN = est.contra;
      const note = document.getElementById("ivNote");
      if (note) note.style.display = "block";
    }
  }


  // No dejamos N/D: si no hay datos suficientes, mostramos 0% como estimación conservadora.
  const incohSafe = (incohN == null || Number.isNaN(incohN)) ? 0 : incohN;
  const contraSafe = (contraN == null || Number.isNaN(contraN)) ? 0 : contraN;
  document.getElementById("repIncoh").textContent = `${incohSafe}%`;
 // document.getElementById("repContra").textContent = `${contraSafe}%`;
const g = (resultados && resultados.globales) ? resultados.globales : {};
const nc = (g.IV2 == null ? null : Math.round(Number(g.IV2) || 0));
document.getElementById("repContra").textContent = (nc == null ? "—" : `${nc} pts`);
// Tiempo (PT) desde BD: resultados.globales.IV3 (0/1/2) con rango 20–30 min
const pt = (g.IV3 == null || g.IV3 === "") ? null : Math.round(Number(g.IV3) || 0);

const PT_LABEL = {
  2: "Tiempo adecuado (20–30 min)",
  1: "Demasiado breve (<20 min)",
  0: "Demasiado lento (>30 min)"
};

const elPT = document.getElementById("repTiempo");
if (elPT) elPT.textContent = (pt == null ? "—" : `${pt} pts — ${PT_LABEL[pt] || ""}`);

  const validIdx = (incohN == null || Number.isNaN(incohN)) && (contraN == null || Number.isNaN(contraN))
    ? null
    : Math.max(incohN || 0, contraN || 0);

  const stars = calcStars(ivi, validIdx);
  paintStars(stars);

  setInterp(pHon, "interpHonBadge", "interpHonBody", "Honestidad");
  setInterp(pRec, "interpRecBadge", "interpRecBody", "Rectitud");
  setInterp(pJus, "interpJusBadge", "interpJusBody", "Justicia");
  setInterp(pVer, "interpVerBadge", "interpVerBody", "Veracidad");
  wireInterpToggles();

  const elBIVI = document.getElementById("bIVI") || document.getElementById("repIVI") || document.getElementById("iviScore2"); if (elBIVI) elBIVI.textContent = ivi || "—";
  const elTIVI = document.getElementById("tIVI") || document.getElementById("iviText2"); if (elTIVI) elTIVI.textContent = interpGlobal(ivi, stars);
  const s2 = document.getElementById("iviScore2");
  const t2 = document.getElementById("iviText2");
  if (s2) s2.textContent = ivi || "—";
  if (t2) t2.textContent = interpGlobal(ivi, stars);

  // ===== PARTE 2 robusta (perfil + recomendaciones + plan) =====
  const ptLabel = (pt == null) ? "—" : `${pt} pts — ${PT_LABEL[pt] || ""}`.trim();
  renderParte2Integridad({
    honestidad: pHon,
    rectitud: pRec,
    justicia: pJus,
    veracidad: pVer,
    ivi: ivi,
    stars: stars,
    incoh: incohSafe,
    nc: nc,
    ptLabel: ptLabel
  });




  document.getElementById("reporteContainer").style.display = "block";
}


function buildCurveSvg(){
  const svg = document.getElementById("curveSvg");
  const line = document.getElementById("curveLine");
  const fill = document.getElementById("curveFill");
  if (!svg || !line || !fill) return;

  // simple gaussian curve in viewBox 0..100 x 0..32
  const pts = [];
  const mu = 50, sigma = 16;
  for (let x=0; x<=100; x+=2){
    const y = Math.exp(-0.5*Math.pow((x-mu)/sigma,2)); // 0..1
    const yy = 30 - y*24; // top padding
    pts.push([x, yy]);
  }
  const dLine = "M " + pts.map(p=>p[0].toFixed(1)+" "+p[1].toFixed(1)).join(" L ");
  const dFill = dLine + " L 100 30 L 0 30 Z";
  line.setAttribute("d", dLine);
  fill.setAttribute("d", dFill);
}

function setCurveMarker(pct){
  const el = document.getElementById("curveMarker");
  const p = Math.max(0, Math.min(100, Number(pct)||0));
  if (el) el.style.left = p + "%";
}

function extractAnswers(attempt){
  const cand = attempt.answers ?? attempt.respuestas ?? attempt.respuestas_json ?? attempt.payload?.answers ?? attempt.data?.answers;
  if (!cand) return null;
  try{
    if (Array.isArray(cand)) return cand;
    if (typeof cand === "string") return JSON.parse(cand);
    if (typeof cand === "object") return cand;
  }catch(e){ return null; }
  return null;
}

// Estimación automática (proxy) cuando no existen pares de incoherencia/contradicción.
// - Incoherencia: variabilidad global de respuestas (más variabilidad -> más incoherencia).
// - Contradicción: alternancia entre respuestas consecutivas (más cambios bruscos -> más contradicción).
function estimateValidation(attempt){
  const a = extractAnswers(attempt);
  // esperamos 96 respuestas en escala 1-3
  //const arr = Array.isArray(a) ? a : (a && Array.isArray(a.items) ? a.items : null);
  let arr = null;

// Caso 1: array directo
if (Array.isArray(a)) {
  arr = a;
}
// Caso 2: {items:[...]}
else if (a && Array.isArray(a.items)) {
  arr = a.items;
}
// Caso 3: {"1":3,"2":2,...}  (objeto con llaves numéricas)
else if (a && typeof a === "object") {
  const keys = Object.keys(a).filter(k => /^\d+$/.test(k));
  if (keys.length) {
    keys.sort((x,y)=>Number(x)-Number(y));
    arr = keys.map(k => a[k]);
  }
}

  
  if (!arr || !arr.length) return null;

const vals = [];
for (const it of arr){
  let n;

  // Si viene como número o string ("1","2","3")
  if (typeof it === "number" || typeof it === "string") {
    n = Number(it);
  } else {
    // Si viene como objeto {value:...} o {respuesta:...}
    n = Number(it?.value ?? it?.v ?? it?.respuesta ?? it?.answer);
  }

  if (n >= 1 && n <= 3) vals.push(n);
}

  if (vals.length < 20) return null;

  const mean = vals.reduce((s,x)=>s+x,0)/vals.length;
  const varr = vals.reduce((s,x)=>s+Math.pow(x-mean,2),0)/vals.length;
  const sd = Math.sqrt(varr);

  // max sd for {1,3} split is 1.0; but in 1-3 with middle, practical max ~1.0
  const incoh = Math.round(Math.max(0, Math.min(100, (sd/1.0)*100)));

  let switches = 0;
  for (let i=1;i<vals.length;i++){
    if (vals[i] !== vals[i-1]) switches++;
  }
  const contra = Math.round(Math.max(0, Math.min(100, (switches/Math.max(1, vals.length-1))*100)));

  return { incoh, contra };
}


function calcStars(ivi, validIdx){
  const v = Number(ivi)||0;
  if (v <= 39) return 1;
  if (v <= 60) return 2;
  if (validIdx == null) return 3;
  const vi = Number(validIdx)||0;
  if (vi <= 10) return 4;
  return 3;
}

function paintStars(n){
  const root = document.getElementById("repStars");
  if (!root) return;
  const stars = root.querySelectorAll(".star");
  stars.forEach((s, idx) => {
    if (idx < n) s.classList.add("on");
    else s.classList.remove("on");
  });
}

function interpBand(pct){
  const p = Number(pct)||0;
  if (p <= 39) return {tag:"Requiere acompañamiento", txt:"Este resultado sugiere que el valor está poco consolidado. Puede beneficiar trabajar hábitos concretos y recibir acompañamiento para fortalecerlo de forma consistente."};
  if (p <= 60) return {tag:"En formación", txt:"Este resultado sugiere avances, pero con espacios de mejora. Es útil reforzar decisiones y acciones alineadas al valor en situaciones cotidianas."};
  return {tag:"Íntegro", txt:"Este resultado sugiere una vivencia consistente del valor. Mantén prácticas que lo sostengan y busca retos donde puedas modelarlo y fortalecerlo aún más."};
}

// Interpretación por subprueba (rangos solicitados: <=40, <=70, >70)
function interpBandSkill(skillName, pct){
  const p = Number(pct);
  const v = Number.isFinite(p) ? p : 0;

  if (v <= 40) return { key: "low",  label: "Por desarrollar" };
  if (v <= 70) return { key: "mid",  label: "Por fortalecer" };
  return { key: "high", label: "Por enriquecer" };
}

const INTERP_CONTENT = {
  "Honestidad": {
    low: {
      idea: "Tu resultado sugiere que, en situaciones cotidianas, podría haber inconsistencias al actuar con transparencia o al sostener la verdad cuando resulta incómodo.",
      risks: [
        "Dificultad para reconocer errores o asumir responsabilidades.",
        "Tendencia a justificar omisiones, medias verdades o «ajustes» a la realidad para evitar consecuencias.",
        "Riesgo de pérdida de confianza en equipos, familia o entorno cercano."
      ],
      actions: [
        "Practica el «hecho vs. interpretación»: describe lo ocurrido sin adjetivos ni suposiciones.",
        "Si te equivocas, nómbralo y propone una reparación concreta (qué harás y cuándo).",
        "Antes de hablar, revisa: ¿lo que diré es exacto, completo y necesario?"
      ]
    },
    mid: {
      idea: "Tu resultado refleja una base adecuada de transparencia, con margen para sostenerla con mayor constancia en contextos de presión, conflicto o estrés.",
      risks: [
        "En escenarios tensos, podrías suavizar información relevante o postergar conversaciones difíciles.",
        "Podrías ser selectivo con la verdad para cuidar tu imagen o evitar discusiones."
      ],
      actions: [
        "Establece un hábito de claridad: comunica lo esencial primero y luego el detalle.",
        "Acuerda expectativas: qué información es importante compartir y con qué frecuencia.",
        "Entrena conversaciones difíciles: prepara 3 puntos clave y una propuesta de solución."
      ]
    },
    high: {
      idea: "Tu resultado sugiere una vivencia consistente de honestidad: tiendes a comunicar con claridad, reconocer errores y sostener la verdad incluso cuando requiere valentía.",
      risks: [
        "Cuidar el equilibrio entre franqueza y tacto para no sonar rígido o confrontativo."
      ],
      actions: [
        "Modela con el ejemplo: reconoce logros y errores con la misma naturalidad.",
        "Ofrece feedback con empatía: qué ocurrió, impacto, expectativa y acuerdo.",
        "Mantén tu estándar incluso en pequeños detalles: ahí se consolida la confianza."
      ]
    }
  },

  "Rectitud": {
    low: {
      idea: "Tu resultado sugiere que puedes flexibilizar reglas o principios cuando sientes que te limitan, o cuando «nadie está mirando».",
      risks: [
        "Inconsistencia entre lo que se considera correcto y lo que se hace.",
        "Mayor vulnerabilidad a presiones externas o a decisiones impulsivas.",
        "Señales de doble estándar (para ti vs. para otros)."
      ],
      actions: [
        "Define 3 principios no negociables y tradúcelos a conductas observables.",
        "Cuando estés por «ceder», pregúntate: ¿lo haría si esto fuese público?",
        "Crea recordatorios: reglas personales simples para decisiones repetidas."
      ]
    },
    mid: {
      idea: "Tu resultado refleja un criterio ético funcional, con variaciones cuando hay urgencia, conveniencia o presión social.",
      risks: [
        "En momentos de prisa, podrías priorizar resultados por encima del proceso.",
        "Podrías normalizar pequeñas excepciones que luego se vuelven hábito."
      ],
      actions: [
        "Usa un «check» rápido: legal, justo, coherente con mis valores, sostenible.",
        "Estandariza decisiones: si la situación se repite, define una regla general.",
        "Busca un «aliado de integridad» para validar decisiones complejas."
      ]
    },
    high: {
      idea: "Tu resultado sugiere rectitud sólida: actúas con coherencia entre valores, reglas y decisiones, incluso si implica esfuerzo.",
      risks: [
        "Evitar caer en rigidez: la rectitud también incluye escuchar y ajustar sin traicionar principios."
      ],
      actions: [
        "Comparte tus criterios: muestran transparencia y ayudan a alinear al equipo.",
        "Distingue principio vs. preferencia: así negocias sin perder tu centro.",
        "Reconoce mejoras: refuerza una cultura de coherencia."
      ]
    }
  },

  "Justicia": {
    low: {
      idea: "Tu resultado sugiere que podrías percibir el trato justo como relativo, o priorizar beneficios personales por encima de la equidad en algunas decisiones.",
      risks: [
        "Conflictos por favoritismos o por decisiones percibidas como desbalanceadas.",
        "Dificultad para asumir responsabilidad cuando refleja errores propios.",
        "Resistencia a reglas comunes cuando no favorecen."
      ],
      actions: [
        "Antes de decidir, pregunta: ¿esto es igual para todos en la misma situación?",
        "Separa persona de conducta: evalúa hechos y criterios, no simpatías.",
        "Si alguien se ve afectado, explica el criterio y ofrece alternativas."
      ]
    },
    mid: {
      idea: "Tu resultado refleja una orientación razonable hacia la equidad, con margen para fortalecer consistencia y transparencia en decisiones.",
      risks: [
        "En situaciones ambiguas, podrías usar criterios distintos sin notarlo.",
        "Tendencia a «compensar» con tratos especiales en lugar de corregir el sistema."
      ],
      actions: [
        "Define criterios por escrito para decisiones recurrentes (asignaciones, turnos, apoyos).",
        "Practica la escucha activa antes de concluir: resume lo que entendiste y valida.",
        "Revisa consecuencias: ¿la decisión genera resentimiento o claridad?"
      ]
    },
    high: {
      idea: "Tu resultado sugiere un sentido de justicia consistente: tiendes a evaluar con imparcialidad, explicar criterios y cuidar la equidad en el trato.",
      risks: [
        "Evitar sobrecargarte intentando «ser justo con todos» sin límites claros."
      ],
      actions: [
        "Facilita acuerdos: establece reglas claras y medibles para el grupo.",
        "Promueve reparación: cuando hay error, enfócate en corregir y aprender.",
        "Refuerza lo justo: reconocerlo hace que se repita."
      ]
    }
  },

  "Veracidad": {
    low: {
      idea: "Tu resultado sugiere que, en ocasiones, podrías omitir, distorsionar o ajustar información para evitar consecuencias, quedar bien o reducir conflicto.",
      risks: [
        "Pérdida de credibilidad cuando se detectan inconsistencias.",
        "Confusión y errores por información incompleta.",
        "Mayor tensión interpersonal por desconfianza."
      ],
      actions: [
        "Entrena precisión: responde con datos concretos (qué, cuándo, cuánto).",
        "Si no sabes algo, dilo y comprométete con un seguimiento.",
        "Evita suposiciones: pregunta antes de afirmar."
      ]
    },
    mid: {
      idea: "Tu resultado refleja veracidad adecuada, con espacio para fortalecer consistencia cuando hay presión, miedo al juicio o conflicto.",
      risks: [
        "Podrías postergar verdades difíciles o suavizar hechos importantes.",
        "En contextos tensos, podrías comunicar con ambigüedad."
      ],
      actions: [
        "Comunica con estructura: situación → hecho → impacto → propuesta.",
        "Asegura comprensión: pide que te repitan lo esencial o resume al final.",
        "Practica transparencia gradual: lo importante temprano evita crisis después."
      ]
    },
    high: {
      idea: "Tu resultado sugiere veracidad sólida: tiendes a comunicar con precisión y consistencia, favoreciendo confianza y claridad en tus relaciones.",
      risks: [
        "Cuidar el tono: la verdad es más efectiva cuando se comunica con respeto."
      ],
      actions: [
        "Modela claridad: comparte hechos y criterios, no rumores.",
        "Cierra bucles: cuando prometes informar, cumple el seguimiento.",
        "Ayuda a otros a expresarse: preguntas abiertas y escucha sin juicio."
      ]
    }
  }
};

function buildInterpHTML(skillName, bandKey){
  const s = INTERP_CONTENT[String(skillName)] || null;
  const b = s ? s[bandKey] : null;
  if (!b) return `<div class="muted">Información no disponible.</div>`;

  const ul = (arr) => `<ul>${arr.map(x => `<li>${x}</li>`).join("")}</ul>`;

  return `
    <div><strong>Lectura:</strong> ${b.idea}</div>
    <h4>Posibles riesgos si no se gestiona</h4>
    ${ul(b.risks)}
    <h4>Recomendaciones prácticas</h4>
    ${ul(b.actions)}
  `;
}

function setInterp(pct, badgeId, bodyId, skillName){
  const p = Number(pct);
  const v = Number.isFinite(p) ? p : 0;

  const band = interpBandSkill(skillName, v);

  const badgeEl = document.getElementById(badgeId);
  const bodyEl  = document.getElementById(bodyId);
  if (!badgeEl || !bodyEl) return;

  badgeEl.innerHTML = `<span class="pill">${band.label}</span> <span class="pct">${v}%</span>`;
  bodyEl.innerHTML  = buildInterpHTML(skillName, band.key);

  // abrir por defecto si está "Por desarrollar"
  if (band.key === "low") {
    bodyEl.style.display = "block";
    const btn = document.querySelector(`.interpToggle[data-target="${bodyId}"]`);
    if (btn) btn.textContent = "−";
  }
}

function wireInterpToggles(){
  document.querySelectorAll(".interpToggle").forEach(btn => {
    btn.addEventListener("click", () => {
      const target = btn.getAttribute("data-target");
      const el = document.getElementById(target);
      if (!el) return;
      const open = el.style.display !== "none";
      el.style.display = open ? "none" : "block";
      btn.textContent = open ? "+" : "−";
    });
  });
}

function interpGlobal(ivi, stars){
  const b = interpBand(ivi);
  const sTxt = stars === 4 ? "Alta consistencia de respuestas." : (stars === 3 ? "Consistencia aceptable de respuestas." : "");
  return `${b.txt} Nivel global: ${b.tag}. ${sTxt}`.trim();
}


  async function cargarReporte(codigo){
    document.getElementById("msg").textContent = "Buscando...";
    document.getElementById("msg").className = "msg";
    document.getElementById("reporteContainer").style.display = "none";
    try{
      const r = await fetch(`/api/report?codigo=${encodeURIComponent(codigo)}`);
      const data = await r.json();
      if(!r.ok || data.error){
        document.getElementById("msg").textContent = data.error || "No encontrado";
        document.getElementById("msg").className = "msg err";
        return;
      }
      if (!data || !data.attempt) {
        document.getElementById("msg").textContent = "No se encontró un intento registrado para este código.";
        document.getElementById("msg").className = "msg err";
        return;
      }
      if (data.puede_ver_resultado !== true) {
        document.getElementById("msg").textContent = "Este código no está habilitado para ver su reporte. Contacta a la coordinación.";
        document.getElementById("msg").className = "msg err";
        return;
      }
      document.getElementById("msg").textContent = "Reporte cargado.";
      document.getElementById("msg").className = "msg ok";
      renderAll(data);
      window.scrollTo({top:0,behavior:"smooth"});
    }catch(e){
      console.error(e);
      document.getElementById("msg").textContent="Error de conexión";
      document.getElementById("msg").className="msg err";
    }
  }

  
  const btnVer = document.getElementById("btnVer");
  if (btnVer) {
    btnVer.addEventListener("click", () => {
      const c = (document.getElementById("codigoInput").value || "").trim().toUpperCase();
      if (!c) return;
      cargarReporte(c);
    });
  }
function exportJSON(){
    const payload = window.__LAST_REPORT__ || {};
    const blob = new Blob([JSON.stringify(payload,null,2)],{type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "reporte-integridad.json";
    a.click();
  }

  (()=>{const __el=document.getElementById("btnImprimir"); if(__el) __el.addEventListener("click", ()=>window.print());})();
  (()=>{const __el=document.getElementById("btnExportJSON"); if(__el) __el.addEventListener("click", exportJSON);})();
  (()=>{const __el=document.getElementById("btnPDF"); if(__el) __el.addEventListener("click", ()=>window.print());})();
  (()=>{const __el=document.getElementById("btnJSON"); if(__el) __el.addEventListener("click", exportJSON);})();

  (function init(){
    const qp = new URLSearchParams(location.search);
    const c = (qp.get("codigo")||"").trim().toUpperCase();
    if(c){
      document.getElementById("codigoInput").value=c;
      cargarReporte(c);
    }
  })();
</script>
</body>
</html>
