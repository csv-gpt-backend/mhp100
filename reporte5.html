<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>REP 5 MHP100 — Reporte (match PDF)</title>
<style>
  :root{
    --txt:#1e1e1e; --mut:#666; --line:#e6e6e6;
    --red:#e74c3c; --amber:#f1c40f; --green:#2ecc71;
    --brand:#aa0d0d;
  }
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--txt); margin:0; background:#fff}
  .wrap{max-width:1080px; margin:0 auto; padding:18px 22px 32px}
  header{display:flex; align-items:center; justify-content:space-between; margin-bottom:8px}
  .brand{display:flex; align-items:center; gap:12px}
  .brand .logo{width:54px; height:54px; background:#c81e2a; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:800}
  .title{font-size:22px; font-weight:800}
  .card{border:1px solid var(--line); border-radius:10px; padding:12px 14px; background:#fff}
  .topbar{display:flex; gap:12px; align-items:center; margin-bottom:12px}
  .topbar input[type=text]{border:1px solid var(--line); border-radius:8px; padding:8px 10px; font-size:14px; width:180px}
  .topbar button{border:1px solid var(--line); border-radius:8px; padding:8px 12px; background:#fafafa; cursor:pointer}
  .info{display:grid; grid-template-columns:repeat(6,1fr); gap:10px; align-items:center}
  .info div{padding:6px 8px; border:1px solid var(--line); border-radius:8px; font-size:13px}
  .row{display:flex; gap:18px; align-items:flex-start}
  .colL{flex:1.4}
  .colR{flex:0.9}
  h3{font-size:14px; margin:18px 0 8px; letter-spacing:.2px}
  .iieLine{display:flex; align-items:center; justify-content:space-between; font-weight:800; border-top:1px solid var(--line); border-bottom:1px solid var(--line); padding:8px 0}
  /* Bars */
  .bar{position:relative; height:18px; border-radius:9px; overflow:hidden; background:#eee}
  .bar .seg{position:absolute; top:0; bottom:0}
  .seg.r{left:0; width:40%; background:var(--red)}
  .seg.a{left:40%; width:30%; background:var(--amber)}
  .seg.g{left:70%; width:30%; background:var(--green)}
  .tickRow{display:flex; justify-content:space-between; font-size:11px; color:#777}
  .marker{position:absolute; top:-4px; width:6px; height:26px; background:#111; border-radius:3px}
  .note{font-size:11px; color:#777}
  table{width:100%; border-collapse:collapse; font-size:12.5px}
  th,td{border:1px solid var(--line); padding:6px 8px; text-align:left}
  th{background:#fafafa}
  .small{font-size:12px; color:#777}
  /* curve */
  .curve{position:relative; height:180px; border:1px solid var(--line); border-radius:10px; padding:8px 10px; background:#fff}
  .curve canvas{width:100%; height:120px}
  .legend{display:flex; gap:8px; align-items:center; justify-content:flex-end; font-size:11px; margin-top:4px}
  .chip{width:26px; height:8px; border-radius:4px; display:inline-block}
  /* IV grid */
  .ivcard{border:1px solid var(--line); border-radius:10px; padding:8px 8px; margin-top:10px}
  .ivgrid{display:grid; grid-template-columns:120px 1fr 1fr 1fr}
  .ivgrid div{border:1px solid var(--line); padding:8px; font-size:12px}
  .ivgrid .h{background:#fafafa; font-weight:700}
  .sel{background:#fff4bf}
  /* print */
  @media print{
    .topbar{display:none}
    .wrap{padding:6mm 8mm}
    .row{gap:14px}
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo">❤</div>
      <div class="title">GRÁFICA INDIVIDUAL — MHP100</div>
    </div>
    <img src="img_sello.png" alt="Sello" style="height:32px"/>
  </header>

  <div class="topbar card">
    <input id="code" type="text" placeholder="Código (p.ej. LEX001)" />
    <button id="btn">Buscar</button>
    <span id="msg" class="small"></span>
  </div>

  <div id="report" class="card" style="padding:14px 14px 18px">
    <div class="info" id="hdr">
      <div><b>Nombre:</b> —</div>
      <div><b>Edad:</b> —</div>
      <div><b>Curso/Grado:</b> —</div>
      <div><b>Institución:</b> —</div>
      <div><b>Grupo:</b> —</div>
      <div><b>Fecha:</b> —</div>
    </div>

    <div class="iieLine">ÍNDICE DE INTELIGENCIA EMOCIONAL <span style="font-weight:400">IIE:</span> <span id="iie" style="min-width:36px; text-align:right">—</span></div>

    <div class="row">
      <div class="colL">
        <h3>ESTILOS DE COMUNICACIÓN INTERPERSONAL</h3>
        <div style="margin-bottom:8px"><b>AGRESIÓN</b>
          <div class="bar" style="margin-top:6px" id="barAg">
            <span class="seg r"></span><span class="seg a"></span><span class="seg g"></span>
            <span class="marker" id="mkAg"></span>
          </div>
          <div class="tickRow"><span>10</span><span>40</span><span>70</span><span>100</span></div>
        </div>
        <div style="margin-bottom:2px"><b>TIMIDEZ</b>
          <div class="bar" style="margin-top:6px" id="barTi">
            <span class="seg r"></span><span class="seg a"></span><span class="seg g"></span>
            <span class="marker" id="mkTi"></span>
          </div>
          <div class="tickRow"><span>10</span><span>40</span><span>70</span><span>100</span></div>
        </div>
        <div class="note">* Un puntaje bajo indica mejor manejo en estas áreas.</div>

        <h3 style="margin-top:18px">PROPENSIÓN AL CAMBIO</h3>
        <div><b>PROPENSIÓN AL CAMBIO</b>
          <div class="bar" style="margin-top:6px" id="barPc">
            <span class="seg r"></span><span class="seg a"></span><span class="seg g"></span>
            <span class="marker" id="mkPc"></span>
          </div>
          <div class="tickRow"><span>10</span><span>40</span><span>70</span><span>100</span></div>
        </div>

        <h3 style="margin-top:18px">Por sub-habilidad</h3>
        <table id="tblSubs">
          <thead><tr><th>Bloque</th><th>Sub-habilidad</th><th>Ítems</th><th>Puntos</th><th>%</th><th>Rango</th></tr></thead>
          <tbody></tbody>
        </table>

        <h3 style="margin-top:18px">Por bloque</h3>
        <table id="tblBloques">
          <thead><tr><th>Bloque</th><th>Promedio %</th><th>Rango</th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="small" style="margin-top:8px">Rangos: <span class="chip" style="background:var(--red)"></span> 1–40 · <span class="chip" style="background:var(--amber)"></span> 41–70 · <span class="chip" style="background:var(--green)"></span> 71–100</div>
      </div>

      <div class="colR">
        <div class="curve">
          <div class="small" style="font-weight:700; margin-bottom:4px">Curva de distribución de frecuencias</div>
          <canvas id="cv"></canvas>
          <div class="legend">
            <span class="chip" style="background:var(--red)"></span>1–40
            <span class="chip" style="background:var(--amber)"></span>41–70
            <span class="chip" style="background:var(--green)"></span>71–100
          </div>
        </div>

        <div class="ivcard">
          <div class="small" style="font-weight:700; margin-bottom:6px">IV1 – IV2 – IV3</div>
          <div class="ivgrid" id="ivgrid">
            <div class="h"></div>
            <div class="h">Se conoce o se compromete</div>
            <div class="h">Se conoce o se compromete poco</div>
            <div class="h">Se requiere mayor autoconocimiento o auto compromiso</div>

            <div class="h">IV1</div><div></div><div></div><div></div>
            <div class="h">IV2</div><div></div><div></div><div></div>
            <div class="h">IV3</div>
            <div>Entre 30 y 90 minutos<br/><span class="small">Tomó el tiempo adecuado</span></div>
            <div>Entre 10 y 20 minutos<br/><span class="small">Demasiado breve</span></div>
            <div>Más de 90 minutos<br/><span class="small">Demasiado lento</span></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const $ = (s)=>document.querySelector(s);
const fmt = v => (v===undefined||v===null||v==='')?'—':v;

function placeMarker(id, val){
  const mk = $(id); if(!mk) return;
  if(val==null || isNaN(val)){ mk.style.display='none'; return; }
  const x = Math.max(10, Math.min(100, Number(val)));
  const pct = ((x-10)/(100-10))*100;
  mk.style.left = pct + '%';
  mk.style.display='block';
}

function drawCurve(score){
  const cv = $('#cv'), ctx = cv.getContext('2d');
  const w = cv.width = cv.clientWidth, h = cv.height = cv.clientHeight;
  ctx.clearRect(0,0,w,h);
  const y = h-16;
  const rW = w*0.35, aW = w*0.25, gW = w*0.30;
  ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--red');  ctx.fillRect(0,y,rW,6);
  ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--amber');ctx.fillRect(rW,y,aW,6);
  ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--green');ctx.fillRect(rW+aW,y,gW,6);
  ctx.strokeStyle = '#222'; ctx.lineWidth = 2; ctx.beginPath();
  const cx = w*0.78, amp = h*0.55, spread = w*0.65;
  for(let i=0;i<w;i++){
    const t = (i - (w*0.1)) / spread;
    const yv = y - amp * Math.exp(-t*t);
    if(i===0) ctx.moveTo(i,yv); else ctx.lineTo(i,yv);
  }
  ctx.stroke();
  if(score!=null && !isNaN(score)){
    const sx = Math.max(0, Math.min(w, (score/100)*w));
    ctx.fillStyle = '#111'; ctx.beginPath(); ctx.arc(sx, y-8, 4, 0, Math.PI*2); ctx.fill();
  }
}

function rangeBadge(p){
  if(p==null || isNaN(p)) return '—';
  const n = Number(p);
  if(n<=40) return '<span style="background:#e74c3c;color:#fff;padding:2px 8px;border-radius:12px;font-size:11px">1–40</span>';
  if(n<=70) return '<span style="background:#f1c40f;color:#000;padding:2px 8px;border-radius:12px;font-size:11px">41–70</span>';
  return '<span style="background:#2ecc71;color:#fff;padding:2px 8px;border-radius:12px;font-size:11px">71–100</span>';
}

function selectIV(row, col){
  const grid = $('#ivgrid'); if(!grid) return;
  grid.querySelectorAll('.sel').forEach(el=>el.classList.remove('sel'));
  const base = 4;
  const idx = base + (row-1)*4 + col;
  const cell = grid.children[idx];
  if(cell) cell.classList.add('sel');
}

async function fetchReport(code){
  const res = await fetch('/api/report?codigo='+encodeURIComponent(code));
  if(!res.ok) throw new Error('No encontrado');
  return await res.json();
}

function mapData(data){
  const P = data.participante || data.participant || {};
  const A = data.attempt || data.intento || data || {};
  const R = A.resultados || data.resultados || {};

  const nombre = A.nombre || P.nombre || '';
  const edad = A.edad_anios || P.edad_anios || '';
  const institucion = A.institucion || P.institucion || '';
  const grupo = A.grupo || P.grupo || '';
  const curso = A.curso || P.curso || '';
  const fecha = (A.created_at || A.fecha || '').toString().slice(0,10);

  $('#hdr').innerHTML = `
    <div><b>Nombre:</b> ${fmt(nombre)}</div>
    <div><b>Edad:</b> ${fmt(edad)}</div>
    <div><b>Curso/Grado:</b> ${fmt(curso)}</div>
    <div><b>Institución:</b> ${fmt(institucion)}</div>
    <div><b>Grupo:</b> ${fmt(grupo)}</div>
    <div><b>Fecha:</b> ${fmt(fecha)}</div>
  `;

  const iie = A.iie ?? (R.globales && R.globales.IIE);
  $('#iie').textContent = fmt(iie);

  const subs = R.subhabilidades || [];
  const findPct = key => {
    for(const s of subs){
      const nm = (s.sub||'').toLowerCase();
      if(key==='agresion' && (nm==='agresión'||nm==='agresion')) return Number(s.pct);
      if(key==='timidez' && nm==='timidez') return Number(s.pct);
      if(key==='prop' && (nm==='propensión al cambio'||nm==='propension al cambio')) return Number(s.pct);
    }
    if(key==='prop' && R.bloques && R.bloques.propension_cambio!=null) return Number(R.bloques.propension_cambio);
    return null;
  };
  placeMarker('#mkAg', findPct('agresion'));
  placeMarker('#mkTi', findPct('timidez'));
  placeMarker('#mkPc', findPct('prop'));

  drawCurve(Number(iie));

  const iv1 = A.iv1 ?? (R.globales && R.globales.IV1);
  const iv2 = A.iv2 ?? (R.globales && R.globales.IV2);
  const iv3 = A.iv3 ?? (R.globales && R.globales.IV3);
  const mapIV1 = v => (v===0||v==='Se conoce o se compromete')?1:(v===1||v==='Se conoce o se compromete poco')?2:3;
  const mapIV2 = v => (v===0||v==='No se contradice')?1:(v===1||v==='Se contradice')?2:3;
  const mapIV3 = v => (v===0||/30\s*y\s*90/.test(v))?1:(v===1||/10\s*y\s*20/.test(v))?2:3;
  selectIV(1, mapIV1(iv1));
  selectIV(2, mapIV2(iv2));
  selectIV(3, mapIV3(iv3));

  // tablas
  const tbodyS = $('#tblSubs tbody'); tbodyS.innerHTML='';
  for(const s of subs){
    const rango = rangeBadge(s.pct);
    tbodyS.innerHTML += `<tr>
      <td>${fmt(s.bloque||s.block)}</td>
      <td>${fmt(s.sub||s.subhabilidad)}</td>
      <td>${fmt(s.items||s.items_count||'')}</td>
      <td>${fmt(s.puntos||s.points||'')}</td>
      <td>${fmt(s.pct)}</td>
      <td>${rango}</td>
    </tr>`;
  }

  const tbodyB = $('#tblBloques tbody'); tbodyB.innerHTML='';
  const addB = (label, val)=>{
    if(val==null) return;
    tbodyB.innerHTML += `<tr><td>${label}</td><td>${fmt(val)}</td><td>${rangeBadge(val)}</td></tr>`;
  };
  const b = R.bloques || {};
  addB('Estilos de comunicación interpersonal', b.estilos_comunicacion);
  addB('Habilidades interpersonales', b.interpersonales);
  addB('Habilidades intrapersonales', b.intrapersonales);
  addB('Habilidades para la vida', b.para_la_vida);
  addB('Propensión al cambio', b.propension_cambio);
}

async function run(){
  const code = $('#code').value.trim();
  const msg = $('#msg'); msg.textContent='';
  if(!code){ msg.textContent = 'Ingresa un código'; return; }
  try{
    const data = await fetchReport(code);
    mapData(data);
  }catch(e){
    console.error(e); msg.textContent='No encontrado / error del servidor';
  }
}
document.getElementById('btn').addEventListener('click', run);
document.getElementById('code').addEventListener('keydown', e=>{ if(e.key==='Enter') run(); });

drawCurve(null);
</script>
</body>
</html>
