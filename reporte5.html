<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>REP 555 GRÁFICA INDIVIDUAL — MHP100</title>
<style>
  :root{
    --txt:#111; --mut:#666; --line:#d8d8d8; --bg:#fff;
    --red:#d34a3a; --amber:#f0b429; --green:#2aa56b;
    --rail:#efefef; --badge:#f5f5f5;
  }
  *{box-sizing:border-box} html,body{background:var(--bg); color:var(--txt); margin:0; font:14px/1.25 "Segoe UI",system-ui,Arial}
  .wrap{max-width:950px; margin:18px auto 48px; padding:0 12px}
  header{display:flex; align-items:center; gap:16px}
  .brand{display:flex; align-items:center; gap:14px}
  .brand img{height:30px}
  h1{font-size:18px; font-weight:800; margin:0}
  .panel{border:1px solid var(--line); border-radius:6px; padding:10px 12px; background:#fff}
  .row{display:flex; gap:8px; align-items:center}
  .codebox input{height:30px; padding:4px 10px; border:1px solid var(--line); border-radius:5px}
  .btn{height:30px; padding:0 12px; border:1px solid var(--line); background:#fafafa; border-radius:6px; cursor:pointer}
  .idgrid{display:grid; grid-template-columns:repeat(6,1fr); gap:8px; font-size:13px}
  .idgrid b{font-weight:700}
  .barTitle{font-weight:800; margin:18px 0 8px}
  .divider{height:1px; background:var(--line); margin:8px 0 10px}
  .iie{display:flex; justify-content:space-between; align-items:center; font-weight:800; padding:8px 10px; border:1px solid var(--line); border-radius:6px}
  .scale{position:relative; height:12px; background:var(--rail); border-radius:6px; overflow:hidden}
  .chunk{position:absolute; top:0; bottom:0}
  .c-red{background:var(--red)} .c-am{background:var(--amber)} .c-gr{background:var(--green)}
  .ticks{display:flex; justify-content:space-between; font-size:11px; color:var(--mut); margin-top:2px}
  .marker{position:absolute; top:-4px; width:2px; height:20px; background:#111}
  .note{font-size:12px; color:var(--mut)}
  .cols{display:grid; grid-template-columns: 1fr 310px; gap:12px}
  .card{border:1px solid var(--line); border-radius:6px; padding:10px 12px; background:#fff}
  .table{width:100%; border-collapse:collapse}
  .table th,.table td{border:1px solid var(--line); padding:6px 8px}
  .table th{background:#fafafa; text-align:left}
  .badge{display:inline-block; min-width:38px; text-align:center; font-weight:800; padding:3px 8px; border-radius:20px; background:var(--badge); border:1px solid var(--line)}
  .badge.red{background:#ffe8e5; border-color:#f3c2bc} .badge.am{background:#fff2d9; border-color:#f7dca4}
  .badge.gr{background:#e7fbef; border-color:#bfe8cf}
  .gauge{height:190px; position:relative}
  .g-semi{position:absolute; inset:12px 12px auto 12px; height:150px}
  .g-rail{position:absolute; left:0; right:0; bottom:0; height:10px; border-radius:5px; overflow:hidden}
  .g-rail .c-red{left:0; width:39%} .g-rail .c-am{left:39%; width:31%} .g-rail .c-gr{left:70%; width:30%}
  canvas{width:100%; height:110px}
  .dot{position:absolute; width:9px; height:9px; border-radius:50%; background:#111; transform:translate(-50%,-50%)}
  .matrix{width:100%; border-collapse:collapse; margin-top:6px}
  .matrix th,.matrix td{border:1px solid var(--line); padding:8px; font-size:13px}
  .matrix th{background:#fafafa; text-align:center}
  .hl{background:#fff6c2}
  .mut{color:var(--mut)}
  .right{float:right}
  .headbar{display:flex; justify-content:space-between; align-items:center}
  .logos{display:flex; gap:14px; align-items:center}
  @media print{ .codebox{display:none} body{zoom:0.96} .wrap{margin:10mm auto} }
</style>
</head>
<body>
<div class="wrap">

  <div class="headbar">
    <div class="brand">
      <img src="assets/img_ident.jpg" alt="MHP100">
      <h1>GRÁFICA INDIVIDUAL — MHP100</h1>
    </div>
    <div class="logos">
      <img src="assets/img_sello.png" alt="Lexium" style="height:32px">
    </div>
  </div>

  <!-- Buscador -->
  <div class="panel codebox" style="margin-top:10px; display:flex; gap:10px; align-items:center">
    <label><b>Código</b></label>
    <input id="code" placeholder="Ej. LEX004" value="">
    <button class="btn" id="btn">Buscar</button>
    <span id="msg" class="mut"></span>
  </div>

  <!-- Encabezado -->
  <div class="panel" id="hdr" style="margin-top:10px">
    <div class="idgrid">
      <div><b>Nombre:</b> <span id="hNombre">—</span></div>
      <div><b>Edad:</b> <span id="hEdad">—</span></div>
      <div><b>Curso/Grado:</b> <span id="hCurso">—</span></div>
      <div><b>Institución:</b> <span id="hInst">—</span></div>
      <div><b>Grupo:</b> <span id="hGrupo">—</span></div>
      <div><b>Fecha:</b> <span id="hFecha">—</span></div>
    </div>
  </div>

  <!-- IIE -->
  <div class="iie" style="margin:10px 0 12px">
    <span>ÍNDICE DE INTELIGENCIA EMOCIONAL IIE:</span>
    <span id="hIIE" class="right">—</span>
  </div>

  <!-- Barras -->
  <div class="panel">
    <div class="barTitle">ESTILOS DE COMUNICACIÓN INTERPERSONAL</div>

    <div class="mut" style="margin:2px 0 6px">AGRESIÓN</div>
    <div class="scale" id="barAg">
      <div class="chunk c-red" style="left:0; width:39%"></div>
      <div class="chunk c-am"  style="left:39%; width:31%"></div>
      <div class="chunk c-gr"  style="left:70%; width:30%"></div>
      <span class="marker" id="mkAg" style="left:0%"></span>
    </div>
    <div class="ticks"><span>10</span><span>40</span><span>70</span><span>100</span></div>

    <div class="mut" style="margin:10px 0 6px">TIMIDEZ</div>
    <div class="scale" id="barTi">
      <div class="chunk c-red" style="left:0; width:39%"></div>
      <div class="chunk c-am"  style="left:39%; width:31%"></div>
      <div class="chunk c-gr"  style="left:70%; width:30%"></div>
      <span class="marker" id="mkTi" style="left:0%"></span>
    </div>
    <div class="ticks"><span>10</span><span>40</span><span>70</span><span>100</span></div>

    <div class="note" style="margin:10px 0 14px">* Un puntaje bajo indica mejor manejo en estas áreas.</div>

    <div class="barTitle">PROPENSIÓN AL CAMBIO</div>
    <div class="scale" id="barPr">
      <div class="chunk c-red" style="left:0; width:39%"></div>
      <div class="chunk c-am"  style="left:39%; width:31%"></div>
      <div class="chunk c-gr"  style="left:70%; width:30%"></div>
      <span class="marker" id="mkPr" style="left:0%"></span>
    </div>
    <div class="ticks"><span>10</span><span>40</span><span>70</span><span>100</span></div>
  </div>

  <div class="cols" style="margin-top:12px">
    <!-- Tabla sub-habilidades -->
    <div class="card">
      <div class="barTitle" style="margin:0 0 8px">Por sub-habilidad</div>
      <table class="table" id="tblSub">
        <thead>
          <tr><th>Bloque</th><th>Sub-habilidad</th><th>Ítems</th><th>Puntos</th><th>%</th><th>Rango</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Curva + IV -->
    <div class="card">
      <div class="barTitle" style="margin:0 0 8px">Curva de distribución de frecuencias</div>
      <div class="gauge">
        <div class="g-semi">
          <canvas id="gCanvas"></canvas>
          <div class="g-rail">
            <div class="chunk c-red"></div>
            <div class="chunk c-am"></div>
            <div class="chunk c-gr"></div>
          </div>
          <div id="gDot" class="dot" style="left:85%; top:78%"></div>
        </div>
      </div>

      <div class="barTitle" style="margin:8px 0 6px">IV1 – IV2 – IV3</div>
      <table class="matrix" id="matIV">
        <thead>
          <tr>
            <th></th>
            <th>Se conoce o se<br>compromete</th>
            <th>Se conoce o se<br>compromete poco</th>
            <th>Se requiere mayor<br>autoconocimiento o auto<br>compromiso</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <th>IV1</th>
            <td data-k="IV1:0"></td>
            <td data-k="IV1:1"></td>
            <td data-k="IV1:2"></td>
          </tr>
          <tr>
            <th>IV2</th>
            <td data-k="IV2:0">No se contradice</td>
            <td data-k="IV2:1">Se contradice</td>
            <td data-k="IV2:2">Se contradice<br>frecuentemente</td>
          </tr>
          <tr>
            <th>IV3</th>
            <td data-k="IV3:1">Entre 30 y 90 minutos<br><span class="mut">Tomó el tiempo adecuado</span></td>
            <td data-k="IV3:0">Entre 10 y 20 minutos<br><span class="mut">Demasiado breve</span></td>
            <td data-k="IV3:2">Más de 90 minutos<br><span class="mut">Demasiado lento</span></td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Por bloque -->
  <div class="card" style="margin-top:12px">
    <div class="barTitle" style="margin:0 0 8px">Por bloque</div>
    <table class="table" id="tblBloq">
      <thead><tr><th>Bloque</th><th>Promedio %</th><th>Rango</th></tr></thead>
      <tbody></tbody>
    </table>
    <div class="mut" style="margin-top:8px">Rangos:
      <span class="badge red">1–40</span> ·
      <span class="badge am">41–70</span> ·
      <span class="badge gr">71–100</span>
    </div>
  </div>
</div>

<script>
const $ = (s, r=document) => r.querySelector(s);
const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
const fmt = v => (v===undefined||v===null||v==='') ? '—' : v;

function badge(v){
  if(v==null || isNaN(v)) return '<span class="badge">—</span>';
  v = Math.round(Number(v));
  const cls = v<=40 ? 'red' : (v<=70 ? 'am' : 'gr');
  return `<span class="badge ${cls}">${v}</span>`;
}

function setMarker(e, val){
  if(val==null || isNaN(val)) { e.style.display='none'; return; }
  const x = Math.max(10, Math.min(100, Number(val))); // escala 10–100
  const pct = (x-10)/(100-10)*100;
  e.style.left = pct+'%';
  e.style.display='block';
}

function drawGauge(pct){ // 1–100 sobre el arco
  const cv = $('#gCanvas'); const ctx = cv.getContext('2d');
  const w = cv.width = cv.offsetWidth, h = cv.height = cv.offsetHeight;
  const cx=w/2, cy=h*1.0; const r=Math.min(w, h*1.8)*0.9;
  ctx.clearRect(0,0,w,h);
  ctx.strokeStyle = '#111'; ctx.lineWidth = 2;
  ctx.beginPath(); ctx.arc(cx, cy, r, Math.PI, Math.PI*2); ctx.stroke();

  // punto
  if(pct!=null){
    const t = Math.PI + (pct/100)*Math.PI; // 0..1 sobre PI..2PI
    const x = cx + r*Math.cos(t), y = cy + r*Math.sin(t);
    const dot = $('#gDot'); dot.style.left = (x/cv.offsetWidth*100)+'%'; dot.style.top = (y/cv.offsetHeight*100)+'%';
  }
}

// pinta matriz IV (amarillo)
function paintIV(iv1, iv2, iv3){
  $$('.matrix td').forEach(td=>td.classList.remove('hl'));
  const map = { 'IV1':iv1, 'IV2':iv2, 'IV3':iv3 };
  Object.entries(map).forEach(([k,v])=>{
    if(v==null || isNaN(v)) return;
    const td = $(`[data-k="${k}:${v}"]`);
    if(td) td.classList.add('hl');
  });
}

async function loadByCode(){
  const code = $('#code').value.trim();
  const msg = $('#msg'); msg.textContent = '';
  if(!code){ msg.textContent='Ingresa un código'; return; }

  try{
    const res = await fetch('/api/report?codigo=' + encodeURIComponent(code));
    if(!res.ok) throw new Error('No se encontró el código');
    const d = await res.json();

    const P = d.participante || d.participant || {};
    const A = d.attempt || d.intento || d || {};
    const R = A.resultados || d.resultados || {};

    // Encabezado
    $('#hNombre').textContent = fmt(A.nombre || P.nombre);
    $('#hEdad').textContent   = fmt(A.edad_anios || P.edad_anios);
    $('#hCurso').textContent  = fmt(A.curso || P.curso);
    $('#hInst').textContent   = fmt(A.institucion || P.institucion);
    $('#hGrupo').textContent  = fmt(A.grupo || P.grupo);
    const f = (A.created_at || A.fecha || '').toString().slice(0,10);
    $('#hFecha').textContent  = fmt(f);

    // IIE
    const iie = A.iie ?? (R.globales && R.globales.IIE) ?? null;
    $('#hIIE').textContent = fmt(iie);

    // Barras (10–100)
    let ag=null, ti=null, pr=null;
    const subs = R.subhabilidades || [];
    for(const s of subs){
      const k = (s.sub||'').toLowerCase();
      const v = Number(s.pct);
      if(k.includes('agresión')||k.includes('agresion')) ag=v;
      if(k==='timidez') ti=v;
      if(k.includes('propensión')||k.includes('propension')) pr=v;
    }
    setMarker($('#mkAg'), ag);
    setMarker($('#mkTi'), ti);
    setMarker($('#mkPr'), pr);

    // Curva
    const pGlobal = Number(iie);
    drawGauge(isFinite(pGlobal) ? Math.max(1, Math.min(100, pGlobal)) : null);

    // IV1/IV2/IV3 (0/1/2)
    const iv1 = Number(A.iv1 ?? (R.globales && R.globales.IV1));
    const iv2 = Number(A.iv2 ?? (R.globales && R.globales.IV2));
    const iv3 = Number(A.iv3 ?? (R.globales && R.globales.IV3));
    paintIV(iv1, iv2, iv3);

    // Tabla sub-habilidades
    const tbody = $('#tblSub tbody'); tbody.innerHTML='';
    subs.forEach(s=>{
      const v = Number(s.pct); let tag = 'am';
      if(v<=40) tag='red'; else if(v>=71) tag='gr';
      const b = s.bloque || s.block || '';
      const it = s.items ?? s.items_count ?? s.itemsTotal ?? '—';
      const pts = s.puntos ?? '—';
      tbody.insertAdjacentHTML('beforeend', `
        <tr>
          <td>${fmt(b)}</td>
          <td>${fmt(s.sub)}</td>
          <td style="text-align:center">${fmt(it)}</td>
          <td style="text-align:center">${fmt(pts)}</td>
          <td style="text-align:center">${fmt(isFinite(v)?Math.round(v):'—')}</td>
          <td style="text-align:center">${badge(v)}</td>
        </tr>`);
    });

    // Por bloque
    const TB = $('#tblBloq tbody'); TB.innerHTML='';
    const bIntra = A.b_intra ?? (R.bloques && R.bloques.intrapersonales);
    const bInter = A.b_inter ?? (R.bloques && R.bloques.interpersonales);
    const bPV    = A.b_pv    ?? (R.bloques && R.bloques.para_la_vida);
    [
      ['Estilos de comunicación interpersonal', A.b_eci ?? (R.bloques && R.bloques.eci)],
      ['Habilidades interpersonales', bInter],
      ['Habilidades intrapersonales', bIntra],
      ['Habilidades para la vida', bPV],
      ['Propensión al cambio', A.b_prop ?? (R.bloques && R.bloques.propension_cambio)]
    ].forEach(([name,val])=>{
      if(val==null) return;
      TB.insertAdjacentHTML('beforeend', `
        <tr>
          <td>${name}</td>
          <td style="text-align:center">${fmt(Math.round(val))}</td>
          <td style="text-align:center">${badge(val)}</td>
        </tr>`);
    });

  }catch(e){
    console.error(e);
    $('#msg').textContent = 'No se pudo generar el reporte para el código ingresado.';
  }
}

$('#btn').addEventListener('click', loadByCode);
$('#code').addEventListener('keydown', (e)=>{ if(e.key==='Enter') loadByCode(); });

// dibujo inicial del arco
drawGauge(null);
</script>
</body>
</html>
