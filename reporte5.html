<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>rep 5 GRÁFICA INDIVIDUAL — MHP100</title>
<style>
  :root{
    --ink:#111;--mut:#60646c;--line:#e5e7eb;
    --red:#e74c3c;--amber:#f1c40f;--green:#27ae60;
  }
  @page { size:A4; margin:16mm; }
  @media print { .noprint{display:none!important} }
  *{box-sizing:border-box}
  html,body{background:#fff;color:var(--ink);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
  .wrap{max-width:980px;margin:24px auto 48px;padding:0 12px}
  header{display:grid;grid-template-columns:1fr auto;align-items:center;gap:12px}
  .brand{display:flex;gap:12px;align-items:center}
  .brand img{height:58px;width:58px;object-fit:cover;border-radius:999px}
  .seal{height:50px}
  h1{margin:0;font-size:20px;font-weight:800;letter-spacing:.2px}
  .controls{display:flex;gap:8px;align-items:center;margin:10px 0 12px}
  .controls input{padding:8px 10px;border:1px solid var(--line);border-radius:8px;width:220px}
  .controls button{padding:8px 12px;border:1px solid var(--line);border-radius:8px;background:#111;color:#fff;font-weight:700;cursor:pointer}
  .idgrid{display:grid;grid-template-columns:repeat(6,1fr);gap:12px;border:1px solid var(--line);border-radius:10px;padding:10px 12px;margin-top:10px}
  .idgrid div b{color:#333}
  .section{font-weight:800;margin:18px 0 8px}
  .bar{position:relative;height:26px;border-radius:6px;overflow:hidden;background:linear-gradient(90deg,var(--red) 0 40%,var(--amber) 40% 70%,var(--green) 70% 100%);border:1px solid #d8d8d8}
  .marker{position:absolute;top:-6px;width:10px;height:38px;background:#111;border-radius:3px;transform:translateX(-50%)}
  .ticks{display:flex;justify-content:space-between;font-size:11px;color:#555;margin-top:4px}
  .note{font-size:12px;color:var(--mut);margin-top:4px}
  .grid{display:grid;grid-template-columns:1fr 360px;gap:22px;align-items:start}
  .card{border:1px solid var(--line);border-radius:10px;overflow:hidden}
  .card h3{margin:0;padding:10px 12px;border-bottom:1px solid var(--line);background:#fafafa;font-size:14px;font-weight:800}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--line);padding:8px 10px;font-size:13px;text-align:left}
  .chips{display:flex;gap:8px;align-items:center;font-size:12px;padding:10px 12px}
  .chip{padding:4px 10px;border-radius:999px;font-weight:800;color:#fff}
  .chip.red{background:var(--red)} .chip.amber{background:var(--amber);color:#222} .chip.green{background:var(--green)}
  .curve{width:100%;height:210px;border:1px solid var(--line);border-radius:10px;padding:8px;background:#fff}
  .curve svg{width:100%;height:100%}
  .ivgrid{display:grid;grid-template-columns:140px 1fr 1fr 1fr;border:1px solid var(--line);border-radius:10px;overflow:hidden}
  .ivgrid div{border-right:1px solid var(--line);border-bottom:1px solid var(--line);padding:10px}
  .ivgrid .head{background:#fafafa;font-weight:800}
  .hit{background:#fff6cc;font-weight:800}
  .mini{font-size:12px;color:#666}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <!-- pon tus logos reales si quieres -->
      <img src="" alt="Logo"/>
      <div>
        <h1>GRÁFICA INDIVIDUAL — MHP100</h1>
        <div class="controls noprint">
          <input id="code" placeholder="Ingresar código (ej. LEX004)" />
          <button id="btn">Buscar</button>
          <span id="msg" class="mini"></span>
        </div>
      </div>
    </div>
    <img class="seal" src="" alt="Sello"/>
  </header>

  <div class="idgrid">
    <div><b>Nombre:</b> <span id="nombre">—</span></div>
    <div><b>Edad:</b> <span id="edad">—</span></div>
    <div><b>Curso/Grado:</b> <span id="curso">—</span></div>
    <div><b>Institución:</b> <span id="institucion">—</span></div>
    <div><b>Grupo:</b> <span id="grupo">—</span></div>
    <div style="display:flex;justify-content:flex-end;gap:8px">
      <span style="font-weight:800">ÍNDICE DE INTELIGENCIA EMOCIONAL IIE:</span>
      <span id="iie" style="font-weight:800">—</span>
    </div>
  </div>

  <div class="section">ESTILOS DE COMUNICACIÓN INTERPERSONAL</div>
  <div style="font-weight:800;margin-bottom:6px">AGRESIÓN</div>
  <div class="bar"><span id="mk_agresion" class="marker" style="left:10%"></span></div>
  <div class="ticks"><span>10</span><span>20</span><span>30</span><span>40</span><span>50</span><span>60</span><span>70</span><span>80</span><span>90</span><span>100</span></div>

  <div style="height:10px"></div>
  <div style="font-weight:800;margin-bottom:6px">TIMIDEZ</div>
  <div class="bar"><span id="mk_timidez" class="marker" style="left:10%"></span></div>
  <div class="ticks"><span>10</span><span>20</span><span>30</span><span>40</span><span>50</span><span>60</span><span>70</span><span>80</span><span>90</span><span>100</span></div>
  <div class="note">* Un puntaje bajo indica mejor manejo en estas áreas.</div>

  <div class="section">PROPENSIÓN AL CAMBIO</div>
  <div style="font-weight:800;margin-bottom:6px">PROPENSIÓN AL CAMBIO</div>
  <div class="bar"><span id="mk_cambio" class="marker" style="left:10%"></span></div>
  <div class="ticks"><span>10</span><span>20</span><span>30</span><span>40</span><span>50</span><span>60</span><span>70</span><span>80</span><span>90</span><span>100</span></div>

  <div class="grid" style="margin-top:16px">
    <div>
      <div class="card" style="margin-bottom:14px">
        <h3>Por sub-habilidad</h3>
        <table id="tblSubs"><thead><tr><th>Bloque</th><th>Sub-habilidad</th><th>Ítems</th><th>Puntos</th><th>%</th><th>Rango</th></tr></thead><tbody></tbody></table>
      </div>
      <div class="card">
        <h3>Por bloque</h3>
        <table id="tblBlocks"><thead><tr><th>Bloque</th><th>Promedio %</th><th>Rango</th></tr></thead><tbody></tbody></table>
        <div class="chips">
          <span>Rangos: </span>
          <span class="chip red">1–40</span>
          <span class="chip amber">41–70</span>
          <span class="chip green">71–100</span>
        </div>
      </div>
    </div>
    <div>
      <div class="card" style="margin-bottom:14px">
        <h3>Curva de distribución de frecuencias</h3>
        <div class="curve">
          <svg viewBox="0 0 400 210" role="img" aria-label="Curva">
            <path d="M10,170 C120,30 280,30 390,170" stroke="#111" stroke-width="2" fill="none"/>
            <path d="M10,170 C40,150 70,140 100,135" stroke="var(--red)" stroke-width="6" fill="none"/>
            <path d="M100,135 C160,115 220,115 280,135" stroke="var(--amber)" stroke-width="6" fill="none"/>
            <path d="M280,135 C320,150 360,160 390,170" stroke="var(--green)" stroke-width="6" fill="none"/>
            <line x1="10" y1="175" x2="10" y2="180" stroke="#333"/><text x="8" y="195" font-size="10">1</text>
            <line x1="145" y1="175" x2="145" y2="180" stroke="#333"/><text x="140" y="195" font-size="10">40</text>
            <line x1="280" y1="175" x2="280" y2="180" stroke="#333"/><text x="275" y="195" font-size="10">70</text>
            <line x1="390" y1="175" x2="390" y2="180" stroke="#333"/><text x="385" y="195" font-size="10">100</text>
            <circle id="dot" cx="390" cy="170" r="4" fill="#111"/>
          </svg>
        </div>
      </div>
      <div class="card">
        <h3>IV1 – IV2 – IV3</h3>
        <div class="ivgrid" id="iv">
          <div class="head"></div>
          <div class="head">Se conoce o se compromete</div>
          <div class="head">Se conoce o se compromete poco</div>
          <div class="head">Se requiere mayor autoconocimiento o auto compromiso</div>

          <div class="head">IV1</div>
          <div id="iv1c1"></div><div id="iv1c2"></div><div id="iv1c3"></div>

          <div class="head">IV2</div>
          <div id="iv2c1">No se contradice</div><div id="iv2c2">Se contradice</div><div id="iv2c3">Se contradice frecuentemente</div>

          <div class="head">IV3</div>
          <div id="iv3c1">Entre 30 y 90 minutos<br><span class="mini">Tomó el tiempo adecuado</span></div>
          <div id="iv3c2">Entre 10 y 20 minutos<br><span class="mini">Demasiado breve</span></div>
          <div id="iv3c3">Más de 90 minutos<br><span class="mini">Demasiado lento</span></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const API = '/api/report?codigo='; // respeta tu endpoint actual

function safe(v){ return (v===undefined||v===null||v==='') ? '—' : v; }
function setMarker(id, val){
  const el = document.getElementById(id);
  if(!el){return}
  let v = Number(val); if(!Number.isFinite(v)) v = 10;
  v = Math.max(10, Math.min(100, v));
  el.style.left = (v - 10) / 90 * 100 + '%';
}
function placeDot(iie){
  const t = Math.max(1, Math.min(100, Number(iie)||1));
  const x = 10 + (t-1)/99 * (390-10);
  const y = 170 - (1 - Math.abs((t-1)/99 - 0.5)*2) * 40;
  const dot = document.getElementById('dot');
  dot.setAttribute('cx', x); dot.setAttribute('cy', y);
}
function rangoChip(p){
  if(p<=40) return '<span class="chip red">1–40</span>';
  if(p<=70) return '<span class="chip amber">41–70</span>';
  return '<span class="chip green">71–100</span>';
}
function mark(id){
  document.querySelectorAll('#iv div').forEach(d=>d.classList.remove('hit'));
  const el = document.getElementById(id); if(el) el.classList.add('hit');
}
function paintIV1(iie){
  if(iie>=71) mark('iv1c1'); else if(iie>=41) mark('iv1c2'); else mark('iv1c3');
}
function paintIV2(blocks){
  const core = blocks.filter(b=>['Habilidades intrapersonales','Habilidades interpersonales','Habilidades para la vida'].includes(b.bloque));
  const vals = core.map(b=>Number(b.p||0)).filter(Number.isFinite);
  if(vals.length<2) return;
  const mx = Math.max(...vals), mn = Math.min(...vals), spread = mx - mn;
  if(spread<=10) mark('iv2c1'); else if(spread<=25) mark('iv2c2'); else mark('iv2c3');
}
function paintIV3(mins){
  const m = Number(mins);
  if(!Number.isFinite(m)) return;
  if(m>=30 && m<=90) mark('iv3c1'); else if(m<30) mark('iv3c2'); else mark('iv3c3');
}
function fillTables(subs, blocks){
  const tb = document.querySelector('#tblSubs tbody'); tb.innerHTML='';
  (subs||[]).forEach(s=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${safe(s.bloque||s.block)}</td>
                    <td>${safe(s.sub||s.subhabilidad)}</td>
                    <td>${safe(s.items)}</td>
                    <td>${safe(s.puntos)}</td>
                    <td>${safe(s.p)}</td>
                    <td>${rangoChip(Number(s.p||0))}</td>`;
    tb.appendChild(tr);
  });
  const tb2 = document.querySelector('#tblBlocks tbody'); tb2.innerHTML='';
  (blocks||[]).forEach(b=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${safe(b.bloque)}</td>
                    <td>${safe(b.p)}</td>
                    <td>${rangoChip(Number(b.p||0))}</td>`;
    tb2.appendChild(tr);
  });
}

async function go(){
  const code = document.getElementById('code').value.trim();
  const msg = document.getElementById('msg');
  msg.textContent='';
  if(!code){ msg.textContent='Ingresa un código'; return; }
  try{
    const res = await fetch(API + encodeURIComponent(code));
    if(!res.ok) throw new Error('HTTP '+res.status);
    const data = await res.json();

    const P = data.participante || data.participant || {};
    const A = data.attempt || data.intento || data || {};
    const R = A.resultados || data.resultados || {};

    const nombre = A.nombre || P.nombre;
    const edad = A.edad_anios || P.edad_anios;
    const curso = A.curso || P.curso;
    const institucion = A.institucion || P.institucion;
    const grupo = A.grupo || P.grupo;
    const fecha = (A.created_at || A.fecha || '').toString().slice(0,10);

    document.getElementById('nombre').textContent = safe(nombre);
    document.getElementById('edad').textContent = safe(edad);
    document.getElementById('curso').textContent = safe(curso);
    document.getElementById('institucion').textContent = safe(institucion);
    document.getElementById('grupo').textContent = safe(grupo);

    const iie = Number(A.iie ?? (R.globales && R.globales.IIE) ?? 0);
    document.getElementById('iie').textContent = (iie ? iie : '—');

    // Estilos + cambio
    let agresion=null, timidez=null, cambio=null;
    const subs = (R.subhabilidades || []);
    for(const s of subs){
      const sub = (s.sub||s.subhabilidad||'').toLowerCase();
      const val = Number(s.pct ?? s.p);
      if(sub==='agresión' || sub==='agresion') agresion = val;
      if(sub==='timidez') timidez = val;
      if(sub==='propensión al cambio' || sub==='propension al cambio') cambio = val;
    }
    if(cambio==null && R.bloques && (R.bloques.propension_cambio!=null)) cambio = Number(R.bloques.propension_cambio);

    setMarker('mk_agresion', agresion);
    setMarker('mk_timidez', timidez);
    setMarker('mk_cambio', cambio);
    placeDot(iie);

    // tablas
    const blocks = [];
    if(R.bloques){
      if(R.bloques.intrapersonales!=null) blocks.push({bloque:'Habilidades intrapersonales', p:Number(R.bloques.intrapersonales)});
      if(R.bloques.interpersonales!=null) blocks.push({bloque:'Habilidades interpersonales', p:Number(R.bloques.interpersonales)});
      if(R.bloques.para_la_vida!=null)     blocks.push({bloque:'Habilidades para la vida', p:Number(R.bloques.para_la_vida)});
      if(R.bloques.propension_cambio!=null) blocks.push({bloque:'Propensión al cambio', p:Number(R.bloques.propension_cambio)});
    }
    const subsRows = subs.map(s=>({bloque:s.bloque||s.block, sub:s.sub||s.subhabilidad, items:s.items, puntos:s.puntos, p:Number(s.pct ?? s.p)}));

    fillTables(subsRows, blocks);

    // IVs
    paintIV1(iie);
    paintIV2(blocks);
    const minutos = Number(A.minutos || R.minutos);
    paintIV3(minutos);

    // desplazamiento al reporte
    window.scrollTo(0, document.body.scrollHeight);
  }catch(e){
    console.error(e);
    msg.textContent = 'No se pudo consultar /api/report?codigo=…';
  }
}

document.getElementById('btn').addEventListener('click', go);
document.getElementById('code').addEventListener('keydown', e=>{ if(e.key==='Enter') go(); });
</script>
</body>
</html>
