<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>5555GRÁFICA INDIVIDUAL — MHP100</title>
<style>
/* --- Paleta y tipografía (similar al PDF) --- */
:root{
  --txt:#0f1720; --mut:#6b7280; --line:#e5e7eb;
  --rojo:#e64a45; --amar:#f6c544; --ver:#26b36a; --mark:#111;
  --head:#101828;
}
html,body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,sans-serif;color:var(--txt);background:#fff}
.wrap{max-width:1060px;margin:24px auto;padding:0 16px}
h1{font-size:22px;margin:0 0 12px;font-weight:800; letter-spacing:.2px}

/* --- Cabecera con logos y ficha --- */
.header{display:grid;grid-template-columns:160px 1fr 160px;align-items:center;gap:16px;margin-bottom:6px}
.header .brand{display:flex;gap:10px;align-items:center}
.header .brand img{height:52px}
.header .right img{height:32px;margin-left:auto;display:block}
.ficha{border:1px solid var(--line);border-radius:12px;padding:10px 12px;display:grid;grid-template-columns:repeat(6,1fr);gap:8px 12px;align-items:center}
.ficha div{font-size:13.5px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ficha b{font-weight:700}

/* --- IIE línea única con valor a la derecha --- */
.iieLine{display:flex;align-items:center;justify-content:space-between;border:1px solid var(--line);border-radius:12px;padding:10px 14px;margin:14px 0 10px}
.iieLine .lbl{font-weight:800}
.iieLine .val{font-weight:900}

/* --- Títulos de secciones --- */
h2{font-size:15px;margin:14px 0 10px;font-weight:800;letter-spacing:.2px}
.subnote{font-size:12px;color:var(--mut)}

/* --- Barras 1–40 / 41–70 / 71–100 --- */
.bar{position:relative;height:16px;border-radius:10px;overflow:hidden;border:1px solid var(--line)}
.segR{position:absolute;left:0;top:0;bottom:0;width:40%;background:var(--rojo)}
.segA{position:absolute;left:40%;top:0;bottom:0;width:30%;background:var(--amar)}
.segV{position:absolute;left:70%;top:0;bottom:0;width:30%;background:var(--ver)}
.mark{position:absolute;top:-4px;width:2px;height:24px;background:var(--mark);border-radius:2px}
.scale{display:flex;justify-content:space-between;font-size:12px;color:#4b5563;margin-top:4px}
.rowBar{margin-bottom:12px}

/* --- Grid principal (tabla y gráficos a la derecha) --- */
.mainGrid{display:grid;grid-template-columns:1fr 340px;gap:16px;margin-top:4px}

/* --- Tarjetas con borde --- */
.card{border:1px solid var(--line);border-radius:12px;padding:10px 12px}

/* --- Tablas --- */
table{width:100%;border-collapse:collapse;font-size:13.5px}
th,td{border-top:1px solid var(--line);padding:8px 8px;text-align:left;vertical-align:middle}
th{font-weight:800;background:#fafafa}
tr:first-child th,tr:first-child td{border-top:0}
.badge{display:inline-flex;align-items:center;gap:4px;background:#111;color:#fff;border-radius:999px;padding:2px 8px;font-size:12px}
.badge.r{background:var(--rojo)} .badge.a{background:var(--amar); color:#111} .badge.v{background:var(--ver)}

/* --- Curva --- */
.canvasBox{height:220px}

/* --- Matriz IV1/IV2/IV3 --- */
.matrix th, .matrix td{border:1px solid var(--line)}
.matrix th{background:#fafafa}
.hit{background:#fff3c4} /* amarillo suave */

/* --- Buscador --- */
.search{display:flex;gap:8px;align-items:center;margin:8px 0 14px}
.search input{padding:8px 10px;border:1px solid var(--line);border-radius:10px;width:240px}
.search button{padding:8px 14px;border:1px solid var(--line);border-radius:10px;background:#f8fafc;cursor:pointer}

/* --- Impresión A4 --- */
@media print{
  .search{display:none}
  .wrap{max-width:100%;margin:0;padding:0}
  .header{margin-top:4mm}
  body{margin:8mm}
}
</style>
</head>
<body>
<div class="wrap">

  <div class="header">
    <div class="brand"><img src="assets/img_ident.jpg" alt="MHP100" /></div>
    <h1>GRÁFICA INDIVIDUAL — MHP100</h1>
    <div class="right"><img src="assets/img_sello.png" alt="Lexium" /></div>
  </div>

  <!-- Buscador por código -->
  <div class="search">
    <label for="code"><b>Código</b></label>
    <input id="code" type="text" placeholder="Ej. LEX001" />
    <button id="btnLoad">Buscar</button>
    <span id="msg" style="color:#b42318;font-size:12px"></span>
  </div>

  <!-- Ficha -->
  <div class="ficha" id="ficha">
    <div><b>Nombre:</b> —</div>
    <div><b>Edad:</b> —</div>
    <div><b>Curso/Grado:</b> —</div>
    <div><b>Institución:</b> —</div>
    <div><b>Grupo:</b> —</div>
    <div><b>Fecha:</b> —</div>
  </div>

  <!-- IIE en una sola línea -->
  <div class="iieLine">
    <div class="lbl">ÍNDICE DE INTELIGENCIA EMOCIONAL IIE:</div>
    <div class="val" id="iieVal">—</div>
  </div>

  <!-- Estilos de comunicación -->
  <h2>ESTILOS DE COMUNICACIÓN INTERPERSONAL</h2>

  <div class="rowBar">
    <div style="font-weight:700;margin-bottom:4px">AGRESIÓN</div>
    <div class="bar"><span class="segR"></span><span class="segA"></span><span class="segV"></span><span class="mark" id="mkAgresion" style="left:0%"></span></div>
    <div class="scale"><span>10</span><span>40</span><span>70</span><span>100</span></div>
  </div>

  <div class="rowBar">
    <div style="font-weight:700;margin-bottom:4px">TIMIDEZ</div>
    <div class="bar"><span class="segR"></span><span class="segA"></span><span class="segV"></span><span class="mark" id="mkTimidez" style="left:0%"></span></div>
    <div class="scale"><span>10</span><span>40</span><span>70</span><span>100</span></div>
  </div>

  <div class="subnote">* Un puntaje bajo indica mejor manejo en estas áreas.</div>

  <!-- Propensión al cambio -->
  <h2 style="margin-top:16px">PROPENSIÓN AL CAMBIO</h2>
  <div class="rowBar" style="margin-top:6px">
    <div class="bar"><span class="segR"></span><span class="segA"></span><span class="segV"></span><span class="mark" id="mkCambio" style="left:0%"></span></div>
    <div class="scale"><span>10</span><span>40</span><span>70</span><span>100</span></div>
  </div>

  <!-- Grid principal -->
  <div class="mainGrid">

    <!-- Tabla sub-habilidades -->
    <div class="card">
      <h2 style="margin-top:0">Por sub-habilidad</h2>
      <table id="tblSubs">
        <tr>
          <th style="width:34%">Bloque</th>
          <th style="width:32%">Sub-habilidad</th>
          <th style="width:8%">Ítems</th>
          <th style="width:10%">Puntos</th>
          <th style="width:8%">%</th>
          <th style="width:8%">Rango</th>
        </tr>
      </table>
    </div>

    <!-- Curva + IVs -->
    <div class="card">
      <div class="canvasBox">
        <h2 style="margin:0 0 8px">Curva de distribución de frecuencias</h2>
        <canvas id="curve" width="320" height="180"></canvas>
        <div class="scale" style="margin-top:2px"><span>1</span><span>40</span><span>70</span><span>100</span></div>
      </div>

      <div style="margin-top:14px">
        <h2 style="margin:0 0 8px">IV1 – IV2 – IV3</h2>
        <table class="matrix" id="tblIV">
          <tr>
            <th style="width:25%"></th>
            <th style="width:25%">Se conoce o se<br/>compromete</th>
            <th style="width:25%">Se conoce o se<br/>compromete poco</th>
            <th style="width:25%">Se requiere mayor<br/>autoconocimiento o auto<br/>compromiso</th>
          </tr>
          <tr>
            <th>IV1</th><td id="iv1c0"></td><td id="iv1c1"></td><td id="iv1c2"></td>
          </tr>
          <tr>
            <th>IV2</th>
            <td id="iv2c0">No se contradice</td>
            <td id="iv2c1">Se contradice</td>
            <td id="iv2c2">Se contradice frecuentemente</td>
          </tr>
          <tr>
            <th>IV3</th>
            <td id="iv3c0">Entre 30 y 90<br/>minutos<br/><span style="font-size:12px;color:var(--mut)">Tomó el tiempo<br/>adecuado</span></td>
            <td id="iv3c1">Entre 10 y 20<br/>minutos<br/><span style="font-size:12px;color:var(--mut)">Demasiado breve</span></td>
            <td id="iv3c2">Más de 90 minutos<br/><span style="font-size:12px;color:var(--mut)">Demasiado lento</span></td>
          </tr>
        </table>
      </div>
    </div>
  </div>

  <!-- Por bloque -->
  <div class="card" style="margin-top:14px">
    <h2 style="margin-top:0">Por bloque</h2>
    <table id="tblBloques">
      <tr><th>Bloque</th><th style="width:12%">Promedio %</th><th style="width:18%">Rango</th></tr>
    </table>
    <div class="subnote" style="margin-top:8px">Rangos: <span class="badge r">1–40</span> · <span class="badge a">41–70</span> · <span class="badge v">71–100</span></div>
  </div>

</div>

<script>
/* ----------------- utilidades ----------------- */
const $=s=>document.querySelector(s);
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const pct=v=>Number.isFinite(+v)?+v:null;
function badgeFor(p){
  if(p==null) return '';
  if(p<=40) return '<span class="badge r">1–40</span>';
  if(p<=70) return '<span class="badge a">41–70</span>';
  return '<span class="badge v">71–100</span>';
}
function setMarker(id, val){
  const el=$(id);
  if(!el) return;
  if(val==null){ el.style.display="none"; return; }
  const left=clamp(Math.round(val),10,100); // escala 10–100
  el.style.left=left+'%';
  el.style.display="block";
}

/* ----------------- curva ----------------- */
function drawCurve(canvas, iie){
  const ctx=canvas.getContext('2d');
  const W=canvas.width, H=canvas.height;
  ctx.clearRect(0,0,W,H);

  const x0=16, x1=W-16, y0=H-22; // base
  // banda de colores
  const stops=[
    {x:x0+((40-1)/(100-1))*(x1-x0), color:'#e64a45'},
    {x:x0+((70-1)/(100-1))*(x1-x0), color:'#f6c544'},
    {x:x1, color:'#26b36a'}
  ];
  ctx.lineWidth=6;
  // rojo
  ctx.strokeStyle='#e64a45'; ctx.beginPath(); ctx.moveTo(x0,y0); ctx.lineTo(stops[0].x,y0); ctx.stroke();
  // amarillo
  ctx.strokeStyle='#f6c544'; ctx.beginPath(); ctx.moveTo(stops[0].x,y0); ctx.lineTo(stops[1].x,y0); ctx.stroke();
  // verde
  ctx.strokeStyle='#26b36a'; ctx.beginPath(); ctx.moveTo(stops[1].x,y0); ctx.lineTo(stops[2].x,y0); ctx.stroke();

  // arco
  ctx.strokeStyle='#111'; ctx.lineWidth=2;
  ctx.beginPath();
  ctx.moveTo(x0,y0);
  ctx.quadraticCurveTo( (x0+x1)/2, 16, x1, y0 );
  ctx.stroke();

  // marcador de IIE
  if(pct(iie)!=null){
    const t=(clamp(iie,1,100)-1)/(100-1);
    const x=x0 + t*(x1-x0);
    const y=y0 - ( (1 - Math.abs(2*t-1)) * (y0-20) ); // proyectado al arco
    ctx.fillStyle='#111';
    ctx.beginPath(); ctx.arc(x,y,3.5,0,Math.PI*2); ctx.fill();
  }
}

/* ----------------- IVs ----------------- */
function hit(cellId){ const td=$(cellId); if(td) td.classList.add('hit'); }

/* ----------------- mapeo de respuesta ----------------- */
function putFicha(p){
  const f=$('#ficha');
  f.children[0].innerHTML = `<b>Nombre:</b> ${p.nombre??'—'}`;
  f.children[1].innerHTML = `<b>Edad:</b> ${p.edad_anios??'—'}`;
  f.children[2].innerHTML = `<b>Curso/Grado:</b> ${p.curso??'—'}`;
  f.children[3].innerHTML = `<b>Institución:</b> ${p.institucion??'—'}`;
  f.children[4].innerHTML = `<b>Grupo:</b> ${p.grupo??'—'}`;
  f.children[5].innerHTML = `<b>Fecha:</b> ${(p.created_at||p.fecha||'').toString().slice(0,10) || '—'}`;
}

function fillTables(data){
  const A = data.attempt || data.intento || data || {};
  const R = A.resultados || data.resultados || {};

  /* IIE */
  const iie = A.iie ?? (R.globales && R.globales.IIE) ?? null;
  $('#iieVal').textContent = (iie??'—');

  /* Barras */
  let agresion=null, timidez=null, prop=null;
  const subs = (R.subhabilidades||[]);
  for(const s of subs){
    const sub=(s.sub||s.subhabilidad||'').toLowerCase();
    const v=pct(s.pct);
    if(sub==='agresión' || sub==='agresion') agresion=v;
    if(sub==='timidez') timidez=v;
    if(sub==='propensión al cambio' || sub==='propension al cambio') prop=v;
  }
  if(prop==null && R.bloques && R.bloques.propension_cambio!=null) prop=pct(R.bloques.propension_cambio);

  setMarker('#mkAgresion',agresion);
  setMarker('#mkTimidez',timidez);
  setMarker('#mkCambio',prop);

  /* Curva */
  drawCurve(document.getElementById('curve'), iie);

  /* IVs (resalta amarillo) */
  // IV1 por terciles del IIE (coherente con PDF)
  if(pct(iie)!=null){
    if(iie>=71) hit('#iv1c0');        // Se conoce o se compromete
    else if(iie>=41) hit('#iv1c1');   // Se conoce o se compromete poco
    else hit('#iv1c2');               // Requiere mayor autoconocimiento...
  }
  // IV2 por dispersión/consistencia si viene; si no, aproximación
  const iv2 = A.iv2 ?? (R.globales && R.globales.IV2);
  if(typeof iv2==='number'){
    if(iv2===0) hit('#iv2c0'); else if(iv2===1) hit('#iv2c1'); else if(iv2===2) hit('#iv2c2');
  }else{
    // Heurística: si bloques muy uniformes => no se contradice
    const bi=pct(A.b_intra ?? (R.bloques&&R.bloques.intrapersonales));
    const be=pct(A.b_inter ?? (R.bloques&&R.bloques.interpersonales));
    const bv=pct(A.b_pv    ?? (R.bloques&&R.bloques.para_la_vida));
    if([bi,be,bv].every(v=>v!=null)){
      const dif=Math.max(bi,be,bv)-Math.min(bi,be,bv);
      if(dif<=8) hit('#iv2c0'); else if(dif<=18) hit('#iv2c1'); else hit('#iv2c2');
    }
  }
  // IV3 por tiempo efectivo si llega; si no, no se marca
  const iv3 = A.iv3 ?? (R.globales && R.globales.IV3);
  if(typeof iv3==='number'){
    if(iv3===0) hit('#iv3c0'); else if(iv3===1) hit('#iv3c1'); else if(iv3===2) hit('#iv3c2');
  }else if(A.tiempo_min!=null){
    const t=A.tiempo_min;
    if(t>90) hit('#iv3c2'); else if(t<25) hit('#iv3c1'); else hit('#iv3c0');
  }

  /* Tabla sub-habilidades */
  const tblS=$('#tblSubs');
  tblS.innerHTML = `
    <tr>
      <th style="width:34%">Bloque</th>
      <th style="width:32%">Sub-habilidad</th>
      <th style="width:8%">Ítems</th>
      <th style="width:10%">Puntos</th>
      <th style="width:8%">%</th>
      <th style="width:8%">Rango</th>
    </tr>`;
  for(const s of subs){
    const b=s.bloque||s.block||'';
    const sub=s.sub||s.subhabilidad||'';
    const it=s.items||s.items_count||s.ítems||'';
    const pt=s.puntos??'—';
    const p=s.pct;
    tblS.insertAdjacentHTML('beforeend',
      `<tr>
        <td>${b||''}</td>
        <td>${sub||''}</td>
        <td>${it||''}</td>
        <td>${pt}</td>
        <td>${p??'—'}</td>
        <td style="text-align:center">${badgeFor(p)}</td>
      </tr>`);
  }

  /* Por bloque */
  const bi=pct(A.b_intra ?? (R.bloques&&R.bloques.intrapersonales));
  const be=pct(A.b_inter ?? (R.bloques&&R.bloques.interpersonales));
  const bv=pct(A.b_pv    ?? (R.bloques&&R.bloques.para_la_vida));
  const pc=pct(R.bloques && R.bloques.propension_cambio);

  const tblB=$('#tblBloques');
  tblB.innerHTML=`
    <tr><th>Bloque</th><th style="width:12%">Promedio %</th><th style="width:18%">Rango</th></tr>
    <tr><td>Estilos de comunicación interpersonal</td><td>${pct(R.bloques&&R.bloques.estilos_comunicacion)||'—'}</td><td>${badgeFor(pct(R.bloques&&R.bloques.estilos_comunicacion))}</td></tr>
    <tr><td>Habilidades interpersonales</td><td>${be??'—'}</td><td>${badgeFor(be)}</td></tr>
    <tr><td>Habilidades intrapersonales</td><td>${bi??'—'}</td><td>${badgeFor(bi)}</td></tr>
    <tr><td>Habilidades para la vida</td><td>${bv??'—'}</td><td>${badgeFor(bv)}</td></tr>
    <tr><td>Propensión al cambio</td><td>${pc??'—'}</td><td>${badgeFor(pc)}</td></tr>
  `;
}

/* ----------------- fetch del reporte ----------------- */
async function loadReport(){
  const code=$('#code').value.trim(); const msg=$('#msg'); msg.textContent='';
  if(!code){ msg.textContent='Ingresa un código'; return; }

  try{
    const res=await fetch('/api/report?codigo='+encodeURIComponent(code));
    if(!res.ok) throw new Error('No encontrado');
    const data=await res.json();

    const P=data.participante||data.participant||{};
    const A=data.attempt||data.intento||data||{};
    putFicha({...P,...A});
    fillTables(data);
  }catch(e){
    console.error(e); msg.textContent='No se pudo generar el reporte (verifica /api/report y el código).';
  }
}
$('#btnLoad').addEventListener('click',loadReport);
$('#code').addEventListener('keydown',e=>{if(e.key==='Enter') loadReport();});
</script>
</body>
</html>
