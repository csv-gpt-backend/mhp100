<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ESTEGRÁFICA INDIVIDUAL — MHP100</title>
<style>
  :root{
    --txt:#1d1d1f; --mut:#6b7280; --line:#e5e7eb; --card:#ffffff;
    --red:#e74c3c; --amber:#f3b323; --green:#23b36b;
    --hilite:#fff3bf;
  }
  *{box-sizing:border-box}
  body{
    margin:20px auto; max-width:1060px; padding:0 16px;
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    color:var(--txt); background:#fafafa;
  }
  .row{display:flex; align-items:center; gap:14px}
  .between{display:flex; align-items:center; justify-content:space-between}
  .card{background:var(--card); border:1px solid var(--line); border-radius:10px; padding:14px}
  h1{font-size:22px; margin:0 0 6px; font-weight:800; letter-spacing:.2px}
  .brandbar{margin-bottom:12px}
  .logoL{height:46px}
  .logoM{height:40px}
  .small{font-size:12px; color:var(--mut)}
  label{font-weight:600}
  input[type=text]{padding:9px 12px; border:1px solid var(--line); border-radius:10px; min-width:200px; font-size:14px}
  button{padding:9px 12px; border:1px solid var(--line); background:#fff; border-radius:10px; cursor:pointer}
  button:hover{background:#f6f6f6}

  /* Reporte */
  .grid6{display:grid; grid-template-columns:repeat(6,1fr); gap:8px}
  .k{background:var(--card); border:1px solid var(--line); border-radius:10px; padding:10px 12px; font-size:13px}
  .k b{font-weight:700}
  .k .v{font-weight:600; color:#111}

  .iieLine{
    font-weight:800; border:1px solid var(--line); border-radius:10px;
    padding:10px 12px; display:flex; align-items:center; justify-content:space-between;
  }
  .iieVal{font-weight:800; min-width:60px; text-align:right}

  h2{font-size:14px; margin:14px 0 8px; font-weight:800; letter-spacing:.2px}

  .bar{
    position:relative; height:14px; border-radius:7px; overflow:hidden;
    background:linear-gradient(90deg, var(--red) 0 40%, var(--amber) 40% 70%, var(--green) 70% 100%);
    border:1px solid var(--line);
  }
  .bar .marker{
    position:absolute; top:-4px; width:2px; height:22px; background:#111; border-radius:2px;
  }
  .barScale{display:flex; justify-content:space-between; font-size:11px; color:var(--mut); margin-top:4px}
  .note{font-size:12px; color:var(--mut); margin-top:6px}

  .cols{display:grid; grid-template-columns: 1fr 360px; gap:14px; margin-top:14px}
  table{width:100%; border-collapse:collapse; font-size:13px; background:#fff}
  th,td{border:1px solid var(--line); padding:8px 10px; vertical-align:top}
  th{background:#fbfbfb; font-weight:800}
  .chip{display:inline-flex; align-items:center; justify-content:center; min-width:40px; height:26px; padding:0 8px; border-radius:13px; font-weight:800; color:#111}
  .cR{background:#ffd8d2} .cY{background:#ffe8b3} .cG{background:#c8f3da}

  .ivCard table{table-layout:fixed}
  .ivCard th, .ivCard td{text-align:center}
  .hilite{background:var(--hilite)!important}

  .byBlock{margin-top:16px}

  @media print{
    .brandbar .search{display:none}
    body{background:#fff}
    .card{break-inside:avoid}
  }
</style>
</head>
<body>

  <!-- Encabezado / Logotipos -->
  <div class="brandbar between">
    <div class="row">
      <img src="assets/img_ident.jpg" alt="MHP" class="logoM">
      <h1>GRÁFICA INDIVIDUAL — MHP100</h1>
    </div>
    <img src="assets/img_sello.png" alt="Lexium" class="logoL">
  </div>

  <!-- Buscador por código -->
  <div class="card row search" style="gap:8px;">
    <label for="code">Código</label>
    <input id="code" type="text" placeholder="Ej. LEX003" />
    <button id="btn">Buscar</button>
    <span id="msg" class="small"></span>
  </div>

  <!-- Reporte (oculto por defecto) -->
  <div id="report" style="display:none">

    <!-- Ficha -->
    <div class="card" style="margin-top:10px">
      <div class="grid6">
        <div class="k"><b>Nombre:</b> <span id="k_nombre" class="v">—</span></div>
        <div class="k"><b>Edad:</b> <span id="k_edad" class="v">—</span></div>
        <div class="k"><b>Curso/Grado:</b> <span id="k_curso" class="v">—</span></div>
        <div class="k"><b>Institución:</b> <span id="k_inst" class="v">—</span></div>
        <div class="k"><b>Grupo:</b> <span id="k_grupo" class="v">—</span></div>
        <div class="k"><b>Fecha:</b> <span id="k_fecha" class="v">—</span></div>
      </div>
      <div class="iieLine" style="margin-top:10px">
        <div>ÍNDICE DE INTELIGENCIA EMOCIONAL IIE:</div>
        <div id="iieVal" class="iieVal">—</div>
      </div>
    </div>

    <!-- Estilos -->
    <div class="card">
      <h2>ESTILOS DE COMUNICACIÓN INTERPERSONAL</h2>

      <div style="margin:10px 0 6px; font-weight:800">AGRESIÓN</div>
      <div class="bar"><span id="mk_agresion" class="marker" style="left:0%"></span></div>
      <div class="barScale"><span>10</span><span>40</span><span>70</span><span>100</span></div>

      <div style="margin:14px 0 6px; font-weight:800">TIMIDEZ</div>
      <div class="bar"><span id="mk_timidez" class="marker" style="left:0%"></span></div>
      <div class="barScale"><span>10</span><span>40</span><span>70</span><span>100</span></div>

      <div class="note">* Un puntaje bajo indica mejor manejo en estas áreas.</div>
    </div>

    <!-- Propensión -->
    <div class="card">
      <h2>PROPENSIÓN AL CAMBIO</h2>
      <div class="bar"><span id="mk_prop" class="marker" style="left:0%"></span></div>
      <div class="barScale"><span>10</span><span>40</span><span>70</span><span>100</span></div>
    </div>

    <!-- Tablas + Curva -->
    <div class="cols">
      <div class="card">
        <h2>Por sub-habilidad</h2>
        <table id="tblSubs">
          <thead>
          <tr>
            <th style="width:28%">Bloque</th>
            <th style="width:28%">Sub-habilidad</th>
            <th style="width:8%">Ítems</th>
            <th style="width:10%">Puntos</th>
            <th style="width:8%">%</th>
            <th style="width:18%">Rango</th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card ivCard">
        <h2>Curva de distribución de frecuencias</h2>
        <svg id="arc" viewBox="0 0 300 150" width="100%" height="160" style="margin-bottom:8px">
          <!-- arco -->
          <path d="M 10 140 Q 150 10 290 140" fill="none" stroke="#111" stroke-width="2"/>
          <!-- franja de colores -->
          <line x1="20" y1="140" x2="110" y2="140" stroke="#e74c3c" stroke-width="6"/>
          <line x1="110" y1="140" x2="210" y2="140" stroke="#f3b323" stroke-width="6"/>
          <line x1="210" y1="140" x2="290" y2="140" stroke="#23b36b" stroke-width="6"/>
          <!-- marcador -->
          <circle id="dotArc" cx="150" cy="80" r="4" fill="#111"/>
          <!-- ticks -->
          <text x="18" y="148" font-size="10" fill="#444">1</text>
          <text x="105" y="148" font-size="10" fill="#444">40</text>
          <text x="205" y="148" font-size="10" fill="#444">70</text>
          <text x="288" y="148" font-size="10" fill="#444">100</text>
        </svg>

        <h2>IV1 – IV2 – IV3</h2>
        <table id="tblIV">
          <colgroup>
            <col style="width:25%"><col style="width:25%"><col style="width:25%"><col style="width:25%">
          </colgroup>
          <thead>
            <tr>
              <th></th>
              <th>Se conoce o se compromete</th>
              <th>Se conoce o se compromete poco</th>
              <th>Se requiere mayor autoconocimiento o auto compromiso</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <th>IV1</th>
              <td id="iv1c0"></td><td id="iv1c1"></td><td id="iv1c2"></td>
            </tr>
            <tr>
              <th>IV2</th>
              <td id="iv2c0">No se contradice</td>
              <td id="iv2c1">Se contradice</td>
              <td id="iv2c2">Se contradice frecuentemente</td>
            </tr>
            <tr>
              <th>IV3</th>
              <td id="iv3c0">Entre 30 y 90 minutos<br><span class="small">Tomó el tiempo adecuado</span></td>
              <td id="iv3c1">Entre 10 y 20 minutos<br><span class="small">Demasiado breve</span></td>
              <td id="iv3c2">Más de 90 minutos<br><span class="small">Demasiado lento</span></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Por bloque -->
    <div class="card byBlock">
      <h2>Por bloque</h2>
      <table id="tblBloques">
        <thead>
          <tr><th>Bloque</th><th style="width:18%">Promedio %</th><th style="width:22%">Rango</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="small" style="margin-top:8px">Rangos: <span class="chip cR">1–40</span> · <span class="chip cY">41–70</span> · <span class="chip cG">71–100</span></div>
    </div>

  </div><!-- /#report -->

<script>
  const $ = s => document.querySelector(s);
  const el = s => document.getElementById(s);

  function showReport(on){ el('report').style.display = on ? '' : 'none'; }
  function toPct(v){ const n=Number(v); return Number.isFinite(n)? Math.max(0,Math.min(100,n)) : null; }
  function chip(val){
    if(val==null) return '—';
    if(val <= 40) return `<span class="chip cR">1–40</span>`;
    if(val <= 70) return `<span class="chip cY">41–70</span>`;
    return `<span class="chip cG">71–100</span>`;
  }
  function setMarker(id, pctVal, min=10, max=100){
    const m = el(id);
    if(!m){return;}
    if(pctVal==null){ m.style.display='none'; return; }
    const p = (pctVal - min) / (max - min); // 0..1
    m.style.display='block';
    m.style.left = Math.round(p*100) + '%';
  }
  function setArc(ii){
    const n = Math.max(1, Math.min(100, Number(ii)||1));
    const x = 10 + (n/100)*(290-10);
    const h = 140 - ( (Math.pow((x-150)/140,2)) * 130 );
    el('dotArc').setAttribute('cx', x);
    el('dotArc').setAttribute('cy', Math.max(20, Math.min(140, h)));
  }
  function clearIV(){
    ['iv1c0','iv1c1','iv1c2','iv2c0','iv2c1','iv2c2','iv3c0','iv3c1','iv3c2'].forEach(id=>{
      el(id).classList.remove('hilite');
    });
    el('iv1c0').textContent = 'Se conoce o se compromete';
    el('iv1c1').textContent = 'Se conoce o se compromete poco';
    el('iv1c2').textContent = 'Se requiere mayor autoconocimiento o auto compromiso';
  }
  function hiliteIV(r, c){ const td = el(`iv${r}c${c}`); if(td) td.classList.add('hilite'); }
  function putHeader(P, A){
    el('k_nombre').textContent = A.nombre || P.nombre || '—';
    el('k_edad').textContent   = A.edad_anios ?? P.edad_anios ?? '—';
    el('k_curso').textContent  = A.curso || P.curso || '—';
    el('k_inst').textContent   = A.institucion || P.institucion || '—';
    el('k_grupo').textContent  = A.grupo || P.grupo || '—';
    const f = (A.created_at || A.fecha || '').toString().slice(0,10) || '—';
    el('k_fecha').textContent  = f;
  }

  async function load(){
    const code = el('code').value.trim();
    const msg  = el('msg');
    msg.textContent = '';
    showReport(false);
    if(!code){ msg.textContent = 'Ingresa un código.'; return; }

    try{
      const res = await fetch('/api/report?codigo=' + encodeURIComponent(code));
      if(!res.ok) throw new Error('No encontrado');
      const data = await res.json();

      const P = data.participante || data.participant || {};
      const A = data.attempt || data.intento || data || {};
      const R = A.resultados || data.resultados || {};

      // Ficha + IIE
      putHeader(P,A);
      const iie = A.iie ?? (R.globales && R.globales.IIE) ?? '—';
      el('iieVal').textContent = iie;
      setArc(iie);

      // Estilos + Propensión
      let agresion=null, timidez=null, prop=null;
      const subs = R.subhabilidades || [];
      for(const s of subs){
        const name = (s.sub || s.subhabilidad || '').toLowerCase();
        const v = toPct(s.pct);
        if(name==='agresión' || name==='agresion') agresion = v;
        if(name==='timidez') timidez = v;
        if(name==='propensión al cambio' || name==='propension al cambio') prop = v;
      }
      if(prop==null && R.bloques && (R.bloques.propension_cambio!=null)){
        prop = toPct(R.bloques.propension_cambio);
      }
      setMarker('mk_agresion', agresion, 10, 100);
      setMarker('mk_timidez',  timidez,  10, 100);
      setMarker('mk_prop',     prop,     10, 100);

      // Sub-habilidades
      const tbody = document.querySelector('#tblSubs tbody');
      tbody.innerHTML = '';
      for(const s of subs){
        const b = s.bloque || s.block || '—';
        const sub = s.sub || s.subhabilidad || '—';
        const items = s.items ?? s.ítems ?? s.itens ?? '—';
        const pts = s.puntos ?? '—';
        const pct = toPct(s.pct);
        const rngTxt = pct==null ? '—' : (pct<=40?'1–40':(pct<=70?'41–70':'71–100'));
        tbody.innerHTML += `
          <tr>
            <td>${b}</td>
            <td>${sub}</td>
            <td style="text-align:center">${items}</td>
            <td style="text-align:center">${pts}</td>
            <td style="text-align:center">${pct ?? '—'}</td>
            <td>${pct==null ? '—' : chip(pct)} <span class="small" style="margin-left:6px">${rngTxt}</span></td>
          </tr>`;
      }

      // Por bloque
      const bIntra = A.b_intra ?? (R.bloques && R.bloques.intrapersonales);
      const bInter = A.b_inter ?? (R.bloques && R.bloques.interpersonales);
      const bPV    = A.b_pv    ?? (R.bloques && R.bloques.para_la_vida);
      const bPC    = A.b_pc    ?? (R.bloques && (R.bloques.propension_cambio ?? null));

      const tbB = document.querySelector('#tblBloques tbody');
      tbB.innerHTML = `
        <tr><td>Estilos de comunicación interpersonal</td><td style="text-align:center">${bInter ?? '—'}</td><td>${chip(bInter)}</td></tr>
        <tr><td>Habilidades interpersonales</td><td style="text-align:center">${bInter ?? '—'}</td><td>${chip(bInter)}</td></tr>
        <tr><td>Habilidades intrapersonales</td><td style="text-align:center">${bIntra ?? '—'}</td><td>${chip(bIntra)}</td></tr>
        <tr><td>Habilidades para la vida</td><td style="text-align:center">${bPV ?? '—'}</td><td>${chip(bPV)}</td></tr>
        <tr><td>Propensión al cambio</td><td style="text-align:center">${bPC ?? '—'}</td><td>${chip(bPC)}</td></tr>
      `;

      // IVs (una celda amarilla por fila)
      clearIV();
      let iv1 = A.iv1 ?? (R.globales && R.globales.IV1);
      let iv2 = A.iv2 ?? (R.globales && R.globales.IV2);
      let iv3 = A.iv3 ?? (R.globales && R.globales.IV3);

      // Normalizar si llegan como texto
      if(typeof iv1 === 'string'){
        const s = iv1.toLowerCase();
        if(s.includes('poco')) iv1 = 1;
        else if(s.includes('requiere') || s.includes('auto')) iv1 = 2;
        else iv1 = 0;
      }
      if(typeof iv2 === 'string'){
        const s = iv2.toLowerCase();
        if(s.includes('frecuente')) iv2 = 2;
        else if(s.includes('contradice') && !s.includes('no')) iv2 = 1;
        else iv2 = 0;
      }
      if(typeof iv3 === 'string'){
        const s = iv3.toLowerCase();
        if(s.includes('30') || s.includes('90') || s.includes('adecuado')) iv3 = 0;
        else if(s.includes('10') || s.includes('20') || s.includes('breve')) iv3 = 1;
        else iv3 = 2;
      }

      if(iv1!=null) hiliteIV(1, Number(iv1));
      if(iv2!=null) hiliteIV(2, Number(iv2));
      if(iv3!=null) hiliteIV(3, Number(iv3));

      showReport(true);
      window.scrollTo({top:0,behavior:'smooth'});

    }catch(e){
      msg.textContent = 'No se pudo generar el reporte (verifica el código y el endpoint /api/report).';
      console.error(e);
    }
  }

  document.getElementById('btn').addEventListener('click', load);
  document.getElementById('code').addEventListener('keydown', (ev)=>{ if(ev.key==='Enter') load(); });
</script>
</body>
</html>
