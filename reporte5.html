<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>DEL 3 MHP100 — GRÁFICA INDIVIDUAL</title>
<style>
  :root{
    --ink:#111; --mut:#666; --line:#e5e7eb; --paper:#fff;
    --hilite:#fff3a6;
    --red:#ef4444; --amber:#f59e0b; --green:#22c55e;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:#fafafa;color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:980px;margin:20px auto 48px;padding:0 14px}

  /* Top */
  h1{margin:0;font-size:22px;letter-spacing:.2px;font-weight:800}
  .brand{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
  .brand .left{display:flex;align-items:center;gap:10px}
  .brand img{display:block}
  .logoL{height:44px}
  .logoR{height:40px}

  /* Buscador */
  .panel{display:flex;align-items:center;gap:10px;background:var(--paper);border:1px solid var(--line);border-radius:10px;padding:12px}
  label{font-weight:700}
  input[type=text]{border:1px solid var(--line);border-radius:10px;padding:8px 10px;font-size:14px;min-width:220px;text-transform:uppercase}
  button{border:1px solid var(--line);border-radius:10px;background:#fff;padding:8px 12px;cursor:pointer}
  button:hover{background:#f6f6f6}
  .msg{font-size:12px;color:#b42318;font-weight:700}

  /* Caja ficha + IIE */
  .card{background:var(--paper);border:1px solid var(--line);border-radius:10px;padding:12px;margin-top:12px}
  .grid6{display:grid;grid-template-columns:repeat(6,1fr);gap:8px}
  .k{border:1px solid var(--line);border-radius:8px;padding:8px 10px;font-size:13px}
  .k b{font-weight:800}
  .k .v{font-weight:600}

  .iie{display:flex;align-items:center;justify-content:space-between;margin-top:10px;
       border:1px solid var(--line);border-radius:10px;padding:10px 12px;font-weight:800}
  .iie .val{min-width:64px;text-align:right}

  /* Dos columnas (curva + IV) */
  .cols2{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
  h2{font-size:14px;margin:0 0 6px;font-weight:800;letter-spacing:.2px}

  /* Curva */
  .curve{background:var(--paper);border:1px solid var(--line);border-radius:10px;padding:10px}
  svg text{fill:#374151}

  /* IV */
  table{width:100%;border-collapse:collapse;background:#fff}
  th,td{border:1px solid #111;padding:6px 8px;font-size:12px;text-align:left;vertical-align:top}
  .iv td.hl{background:var(--hilite)}

  /* Estilos / Propensión */
  .railCard{background:var(--paper);border:1px solid var(--line);border-radius:10px;padding:10px}
  .rail{position:relative;height:16px;border:1px solid #9ca3af;border-radius:8px;overflow:hidden;
        background:linear-gradient(90deg,var(--red) 0 40%, var(--amber) 40% 70%, var(--green) 70% 100%)}
  .tick{position:absolute;top:-4px;width:1px;height:24px;background:#9ca3af}
  .ticlbl{position:absolute;top:18px;font-size:10px;color:#374151;transform:translateX(-50%)}
  .mark{position:absolute;top:-3px;width:3px;height:22px;background:#111;border-radius:2px;display:none}

  /* Sub-habilidades y Bloques */
  .colsMain{display:grid;grid-template-columns: 1fr 360px; gap:12px; margin-top:12px}
  .card h3{margin:6px 0 6px;font-size:13px;font-weight:800}
  .mut{color:#6b7280;font-size:12px}
  .chip{display:inline-flex;align-items:center;justify-content:center;min-width:42px;height:24px;border-radius:999px;font-weight:800;font-size:12px;color:#111}
  .cR{background:#ffd8d2} .cY{background:#ffe6b3} .cG{background:#c8f3da}

  /* Impresión */
  @media print{
    @page{ size:A4; margin:14mm 12mm }
    .panel{display:none!important}
    body{background:#fff}
    .card{break-inside:avoid}
  }
</style>
</head>
<body>
<div class="wrap">

  <!-- Encabezado -->
  <div class="brand">
    <div class="left">
      <img src="assets/img_ident.jpg" alt="Identidad" class="logoL">
      <h1>GRÁFICA INDIVIDUAL — MHP100</h1>
    </div>
    <img src="assets/img_sello.png" alt="Sello" class="logoR">
  </div>

  <!-- Buscador por código -->
  <div class="panel">
    <label for="code">Código</label>
    <input id="code" type="text" placeholder="LEX001" maxlength="16"/>
    <button id="go">Ver reporte</button>
    <span id="msg" class="msg"></span>
  </div>

  <!-- Reporte -->
  <div id="report" style="display:none">

    <!-- Ficha + IIE -->
    <div class="card">
      <div class="grid6">
        <div class="k"><b>Nombre:</b> <span id="k_nombre" class="v">—</span></div>
        <div class="k"><b>Edad:</b> <span id="k_edad" class="v">—</span></div>
        <div class="k"><b>Curso/Grado:</b> <span id="k_curso" class="v">—</span></div>
        <div class="k"><b>Institución:</b> <span id="k_inst" class="v">—</span></div>
        <div class="k"><b>Grupo:</b> <span id="k_grupo" class="v">—</span></div>
        <div class="k"><b>Fecha:</b> <span id="k_fecha" class="v">—</span></div>
      </div>
      <div class="iie">
        <div>ÍNDICE DE INTELIGENCIA EMOCIONAL IIE:</div>
        <div id="iieVal" class="val">—</div>
      </div>
    </div>

    <!-- Curva + IV -->
    <div class="cols2">
      <div class="curve">
        <h2>CURVA DE DISTRIBUCIÓN DE FRECUENCIAS</h2>
        <svg id="curve" viewBox="0 0 520 150" width="100%" height="150" aria-label="Curva IIE">
          <!-- franja 1–100 en base -->
          <rect x="10" y="120" width="500" height="6"
                fill="url(#grad)"/>
          <defs>
            <linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="0%">
              <stop offset="0%" stop-color="#ef4444"/>
              <stop offset="40%" stop-color="#ef4444"/>
              <stop offset="40%" stop-color="#f59e0b"/>
              <stop offset="70%" stop-color="#f59e0b"/>
              <stop offset="70%" stop-color="#22c55e"/>
              <stop offset="100%" stop-color="#22c55e"/>
            </linearGradient>
          </defs>
          <!-- ticks 1/40/70/100 -->
          <line x1="10"  y1="112" x2="10"  y2="134" stroke="#111"/>
          <text x="10"  y="146" font-size="11">1</text>
          <line x1="210" y1="112" x2="210" y2="134" stroke="#111"/>
          <text x="210" y="146" font-size="11" text-anchor="middle">40</text>
          <line x1="360" y1="112" x2="360" y2="134" stroke="#111"/>
          <text x="360" y="146" font-size="11" text-anchor="middle">70</text>
          <line x1="510" y1="112" x2="510" y2="134" stroke="#111"/>
          <text x="510" y="146" font-size="11" text-anchor="end">100</text>

          <!-- campana -->
          <path id="bell" d="" fill="none" stroke="#111" stroke-width="2"/>
          <!-- marcador -->
          <circle id="dot" cx="260" cy="60" r="4.5" fill="#111"/>
        </svg>
      </div>

      <div class="card">
        <h2>IV1 – IV2 – IV3</h2>
        <table class="iv" id="tblIV">
          <colgroup><col style="width:16%"><col style="width:28%"><col style="width:28%"><col style="width:28%"></colgroup>
          <tr id="iv1r">
            <th>IV1</th>
            <td id="iv1c0">Se conoce o se compromete</td>
            <td id="iv1c1">Se conoce o se compromete poco</td>
            <td id="iv1c2">Se requiere mayor autoconocimiento o auto compromiso</td>
          </tr>
          <tr id="iv2r">
            <th>IV2</th>
            <td id="iv2c0">No se contradice</td>
            <td id="iv2c1">Se contradice</td>
            <td id="iv2c2">Se contradice frecuentemente</td>
          </tr>
          <tr id="iv3r">
            <th>IV3</th>
            <td id="iv3c0">Entre 30 y 90 minutos<br><span class="mut">Tomó el tiempo adecuado</span></td>
            <td id="iv3c1">Entre 10 y 20 minutos<br><span class="mut">Demasiado breve</span></td>
            <td id="iv3c2">Más de 90 minutos<br><span class="mut">Demasiado lento</span></td>
          </tr>
        </table>
      </div>
    </div>

    <!-- Estilos + Propensión -->
    <div class="cols2">
      <div class="railCard">
        <h2>ESTILOS DE COMUNICACIÓN INTERPERSONAL</h2>
        <div style="font-weight:800;margin:8px 0 6px">AGRESIÓN</div>
        <div class="rail">
          <span class="tick" style="left:0%"></span>
          <span class="tick" style="left:40%"></span>
          <span class="tick" style="left:70%"></span>
          <span class="tick" style="left:100%"></span>
          <span class="ticlbl" style="left:0%">10</span>
          <span class="ticlbl" style="left:40%">40</span>
          <span class="ticlbl" style="left:70%">70</span>
          <span class="ticlbl" style="left:100%">100</span>
          <span id="mkAg" class="mark"></span>
        </div>

        <div style="font-weight:800;margin:14px 0 6px">TIMIDEZ</div>
        <div class="rail">
          <span class="tick" style="left:0%"></span>
          <span class="tick" style="left:40%"></span>
          <span class="tick" style="left:70%"></span>
          <span class="tick" style="left:100%"></span>
          <span class="ticlbl" style="left:0%">10</span>
          <span class="ticlbl" style="left:40%">40</span>
          <span class="ticlbl" style="left:70%">70</span>
          <span class="ticlbl" style="left:100%">100</span>
          <span id="mkTi" class="mark"></span>
        </div>

        <div class="mut" style="margin-top:6px">* Un puntaje bajo indica mejor manejo en estas áreas.</div>
      </div>

      <div class="railCard">
        <h2>PROPENSIÓN AL CAMBIO</h2>
        <div class="rail">
          <span class="tick" style="left:0%"></span>
          <span class="tick" style="left:40%"></span>
          <span class="tick" style="left:70%"></span>
          <span class="tick" style="left:100%"></span>
          <span class="ticlbl" style="left:0%">10</span>
          <span class="ticlbl" style="left:40%">40</span>
          <span class="ticlbl" style="left:70%">70</span>
          <span class="ticlbl" style="left:100%">100</span>
          <span id="mkPc" class="mark"></span>
        </div>
      </div>
    </div>

    <!-- Sub-habilidades + Por bloque -->
    <div class="colsMain">
      <div class="card">
        <h2>RESULTADOS (sub-habilidades)</h2>
        <table id="tblSubs">
          <thead>
            <tr>
              <th style="width:28%">Bloque</th>
              <th style="width:28%">Sub-habilidad</th>
              <th style="width:8%">Ítems</th>
              <th style="width:10%">Puntos</th>
              <th style="width:8%">%</th>
              <th style="width:18%">Rango</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card">
        <h2>Por bloque</h2>
        <table id="tblBloq">
          <thead>
            <tr><th>Bloque</th><th style="width:18%">Promedio %</th><th style="width:22%">Rango</th></tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="mut" style="margin-top:6px">
          Rangos: <span class="chip cR">1–40</span> · <span class="chip cY">41–70</span> · <span class="chip cG">71–100</span>
        </div>
      </div>
    </div>

  </div><!--/report-->
</div><!--/wrap-->

<script>
  const $ = s=>document.querySelector(s);
  const el = id=>document.getElementById(id);

  // ---------- util ----------
  const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));
  const pct = v => { const n=Number(v); return Number.isFinite(n)? n : null; };
  const chip = v => v==null ? '—'
    : (v<=40? '<span class="chip cR">1–40</span>'
    : v<=70? '<span class="chip cY">41–70</span>'
    : '<span class="chip cG">71–100</span>');

  // ---------- curva ----------
  function drawBell(){
    const p=el('bell'); if(!p) return;
    const left=10,right=510,base=115,top=25;
    const mid=(left+right)/2, sigma=90;
    const pts=[];
    for(let x=left;x<=right;x+=4){
      const z=(x-mid)/sigma;
      const y = base - Math.exp(-0.5*z*z)*(base-top);
      pts.push([x,y]);
    }
    let d=`M${pts[0][0]} ${pts[0][1]}`;
    for(let i=1;i<pts.length;i++) d+=` L${pts[i][0]} ${pts[i][1]}`;
    p.setAttribute('d', d);
  }
  function setCurveDot(iie){
    drawBell();
    const left=10,right=510,base=115,top=25, mid=260, sigma=90;
    const s=clamp(Number(iie)||1,1,100);
    const x = left + (s-1)/99*(right-left);
    const z=(x-mid)/sigma;
    const y = base - Math.exp(-0.5*z*z)*(base-top);
    el('dot').setAttribute('cx', x);
    el('dot').setAttribute('cy', y);
  }

  // ---------- IV hilite (una celda) ----------
  function clearIV(){
    ['iv1c0','iv1c1','iv1c2','iv2c0','iv2c1','iv2c2','iv3c0','iv3c1','iv3c2']
      .forEach(id=>el(id).classList.remove('hl'));
  }
  function hiliteIV(row, col){
    const td = el(`iv${row}c${col}`);
    if(td) td.classList.add('hl');
  }
  function toCol(v, row){
    // acepta 0/1/2, 1/2/3, % y texto
    if(v===null || v===undefined) return null;
    if(typeof v==='number'){
      if(v===0||v===1||v===2) return v;
      if(v>=1&&v<=3) return v-1;
      if(v<=40) return 0; if(v<=70) return 1; return 2;
    }
    const s=String(v).toLowerCase();
    if(row===1){ // IV1
      if(s.includes('poco')) return 1;
      if(s.includes('requiere')||s.includes('auto')) return 2;
      return 0;
    }
    if(row===2){ // IV2
      if(s.includes('frecuen')) return 2;
      if(s.includes('contradice') && !s.includes('no')) return 1;
      return 0;
    }
    if(row===3){ // IV3
      if(s.includes('10')||s.includes('20')||s.includes('breve')) return 1;
      if(s.includes('90')||s.includes('lento')) return 2;
      return 0; // 30–90 adecuado
    }
    return null;
  }

  // ---------- barras estilos / propensión ----------
  function setMarker(id, val){
    const m=el(id); if(!m) return;
    const v=pct(val);
    if(v==null){ m.style.display='none'; return; }
    const pos = (clamp(v,10,100)-10)/90*100;
    m.style.left = pos+'%';
    m.style.display='block';
  }

  // ---------- tablas ----------
  function fillSubs(rows){
    const tb = $('#tblSubs tbody'); tb.innerHTML='';
    (rows||[]).forEach(r=>{
      const b = r.bloque||r.block||'';
      const s = r.sub || r.subhabilidad || '';
      const items = r.items ?? r.n_items ?? '';
      const pts = r.puntos ?? r.points ?? r.pts ?? '';
      const p = pct(r.pct ?? r.percent ?? r.porcentaje);
      tb.innerHTML += `
        <tr>
          <td>${b}</td>
          <td>${s}</td>
          <td style="text-align:center">${items}</td>
          <td style="text-align:center">${pts}</td>
          <td style="text-align:center">${p ?? '—'}</td>
          <td>${chip(p)}</td>
        </tr>`;
    });
  }
  function fillBloques(obj){
    const t = $('#tblBloq tbody'); t.innerHTML='';
    const asList = Array.isArray(obj) ? obj
      : Object.keys(obj||{}).map(k=>({bloque:k, pct: obj[k]}));
    asList.forEach(r=>{
      const p = pct(r.pct ?? r.percent ?? r.porcentaje ?? r.value);
      t.innerHTML += `
        <tr>
          <td>${r.bloque||r.block||''}</td>
          <td style="text-align:center">${p ?? '—'}</td>
          <td>${chip(p)}</td>
        </tr>`;
    });
  }

  // ---------- header ----------
  function putHeader(P,A){
    el('k_nombre').textContent = A.nombre || P.nombre || '—';
    el('k_edad').textContent   = A.edad_anios ?? P.edad_anios ?? '—';
    el('k_curso').textContent  = A.curso || P.curso || '—';
    el('k_inst').textContent   = A.institucion || P.institucion || '—';
    el('k_grupo').textContent  = A.grupo || P.grupo || '—';
    const f = (A.created_at || A.fecha || '').toString().slice(0,10) || '—';
    el('k_fecha').textContent  = f;
  }

  // ---------- main load ----------
  async function load(){
    const code = el('code').value.trim().toUpperCase();
    const msg = el('msg');
    msg.textContent='';
    $('#report').style.display='none';
    if(!code){ msg.textContent='Ingresa un código.'; return; }

    try{
      const res = await fetch('/api/report?codigo='+encodeURIComponent(code));
      if(!res.ok) throw new Error('No encontrado');
      const data = await res.json();

      const P = data.participante || data.participant || {};
      const A = data.attempt || data.intento || data || {};
      const R = A.resultados || data.resultados || {};

      // Header + IIE + curva
      putHeader(P,A);
      const iie = A.iie ?? (R.globales && R.globales.IIE) ?? null;
      el('iieVal').textContent = (iie ?? '—');
      setCurveDot(iie ?? 1);

      // IVs
      const iv1 = toCol(A.iv1 ?? (R.globales && R.globales.IV1), 1);
      const iv2 = toCol(A.iv2 ?? (R.globales && R.globales.IV2), 2);
      const iv3 = toCol(A.iv3 ?? (R.globales && R.globales.IV3), 3);
      clearIV();
      if(iv1!=null) hiliteIV(1, iv1);
      if(iv2!=null) hiliteIV(2, iv2);
      if(iv3!=null) hiliteIV(3, iv3);

      // Estilos y propensión (marcadores)
      let agresion=null, timidez=null, prop=null;
      const subs = R.subhabilidades || [];
      for(const s of subs){
        const name=(s.sub||s.subhabilidad||'').toLowerCase();
        const v=pct(s.pct ?? s.percent ?? s.porcentaje);
        if(name==='agresión' || name==='agresion') agresion=v;
        if(name==='timidez') timidez=v;
        if(name==='propensión al cambio' || name==='propension al cambio') prop=v;
      }
      if(prop==null && R.bloques && (R.bloques.propension_cambio!=null))
        prop = pct(R.bloques.propension_cambio);

      setMarker('mkAg', agresion);
      setMarker('mkTi', timidez);
      setMarker('mkPc', prop);

      // tablas
      fillSubs(subs);
      fillBloques(R.bloques || A.bloques || []);

      // listo
      $('#report').style.display='';
      window.scrollTo({top:0,behavior:'smooth'});
    }catch(e){
      msg.textContent='No se pudo generar el reporte (verifica el código y el endpoint /api/report).';
      console.error(e);
    }
  }

  // eventos
  el('go').addEventListener('click', load);
  el('code').addEventListener('keydown', e=>{ if(e.key==='Enter') load(); });

  // dibujar campana estática al cargar
  drawBell();
</script>
</body>
</html>
