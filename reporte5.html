<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>A5 GRÁFICA INDIVIDUAL — MHP100</title>
<style>
  :root{
    --rojo:#e74c3c;
    --ambar:#f1c40f;
    --verde:#2ecc71;
    --gris:#666;
    --texto:#111;
    --borde:#e8e8e8;
  }
  @media print {
    @page { size: A4; margin: 16mm; }
    .no-print { display:none !important; }
  }
  html, body { background:#fff; color:var(--texto); font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Liberation Sans', 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'; }
  .wrap { max-width: 980px; margin: 24px auto 48px; }
  header { display:flex; align-items:center; justify-content:space-between; gap:16px; }
  .brand { display:flex; align-items:center; gap:12px; }
  .brand img { height:56px; border-radius:999px }
  h1 { margin: 0; font-size: 20px; font-weight:800; letter-spacing:.3px; }
  .idbar { display:grid; grid-template-columns: repeat(6, 1fr); gap:12px; padding:12px 16px; border:1px solid var(--borde); border-radius:10px; margin-top:12px; }
  .idbar div b { color:#444; font-weight:700; }
  .section-title { margin:28px 0 12px; font-weight:800; font-size:18px; }
  .row { margin:10px 0 18px; }
  .scale { position:relative; height:28px; border-radius:6px; overflow:hidden; background:linear-gradient(90deg, var(--rojo) 0 40%, var(--ambar) 40% 70%, var(--verde) 70% 100%); }
  .scale .marker { position:absolute; top:-6px; width:10px; height:40px; background:#000; border-radius:3px; }
  .ticks { display:flex; justify-content:space-between; font-size:12px; color:#333; padding:4px 2px 0; }
  .note { font-size:12px; color:#666; margin-top:4px; }
  .grid2 { display:grid; grid-template-columns: 1fr 360px; gap:24px; align-items:start; }
  .card { border:1px solid var(--borde); border-radius:10px; overflow:hidden; }
  .card h3 { margin:0; font-size:16px; font-weight:800; padding:12px 14px; border-bottom:1px solid var(--borde); background:#fafafa; }
  table { width:100%; border-collapse:collapse; }
  th, td { font-size:14px; padding:10px 12px; border-bottom:1px solid var(--borde); }
  th { text-align:left; color:#333; background:#fff; position:sticky; top:0; }
  .chips { display:flex; gap:10px; align-items:center; font-size:12px; }
  .chip { display:inline-block; padding:4px 10px; border-radius:14px; color:#fff; font-weight:700; }
  .chip.red { background:var(--rojo); }
  .chip.amber { background:var(--ambar); color:#000; }
  .chip.green { background:var(--verde); }
  .curve { width:100%; height:210px; border:1px solid var(--borde); border-radius:10px; padding:8px; background:#fff; }
  .curve svg { width:100%; height:100%; }
  .band { fill:none; stroke-width:6; }
  .band.red { stroke:var(--rojo); }
  .band.amber { stroke:var(--ambar); }
  .band.green { stroke:var(--verde); }
  .dot { fill:#111; stroke:#111; }
  .ivgrid { display:grid; grid-template-columns: 140px 1fr 1fr 1fr; border:1px solid var(--borde); border-radius:10px; overflow:hidden; }
  .ivgrid div { border-right:1px solid var(--borde); border-bottom:1px solid var(--borde); padding:12px; font-size:14px; }
  .ivgrid div:last-child { border-right:none; }
  .ivhead { font-weight:800; background:#fafafa; }
  .ivmark { background:#fff3cd; font-weight:700; }
  .right-figure { display:flex; gap:16px; align-items:center; justify-content:flex-end; }
  .right-figure h2 { margin:0; font-size:18px; font-weight:800; }
  .right-figure .iie-box { font-weight:800; }
  .controls { margin: 10px 0 14px; display:flex; gap:8px; align-items:center; }
  .controls input { padding:10px 12px; border:1px solid var(--borde); border-radius:8px; width:220px; }
  .controls button { padding:10px 12px; border-radius:8px; border:1px solid #ddd; background:#111; color:#fff; font-weight:700; cursor:pointer; }
  .mini { font-size:12px; color:#666; }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <!-- Reemplaza src por tu /mnt/data/img_ident.jpg si quieres -->
      <img src="" alt="MHP 100"/>
      <h1>GRÁFICA INDIVIDUAL — MHP100</h1>
    </div>
    <!-- Reemplaza src por tu /mnt/data/img_sello.png si quieres -->
    <img src="" alt="Lexium" style="height:48px"/>
  </header>

  <div class="controls no-print">
    <input id="codeInput" placeholder="Ingresar código (ej. LEX004)" />
    <button id="btnBuscar">Buscar</button>
    <span class="mini">Consulta en vivo: <b>/api/report?code=&lt;código&gt;</b></span>
  </div>

  <div class="idbar" id="idbar">
    <div><b>Nombre:</b> <span id="nombre">—</span></div>
    <div><b>Edad:</b> <span id="edad">—</span></div>
    <div><b>Curso/Grado:</b> <span id="curso">—</span></div>
    <div><b>Institución:</b> <span id="institucion">—</span></div>
    <div><b>Grupo:</b> <span id="grupo">—</span></div>
    <div class="right-figure"><h2>IIE:</h2> <span id="iie" class="iie-box">—</span></div>
  </div>

  <div class="section-title">ÍNDICE DE INTELIGENCIA EMOCIONAL</div>

  <div class="section-title" style="margin-top:18px">ESTILOS DE COMUNICACIÓN INTERPERSONAL</div>
  <div class="row">
    <div style="font-weight:800; margin-bottom:6px;">AGRESIÓN</div>
    <div class="scale" id="agresionScale"><span class="marker" id="agresionMarker" style="left:0%"></span></div>
    <div class="ticks"><span>10</span><span>20</span><span>30</span><span>40</span><span>50</span><span>60</span><span>70</span><span>80</span><span>90</span><span>100</span></div>
  </div>
  <div class="row">
    <div style="font-weight:800; margin-bottom:6px;">TIMIDEZ</div>
    <div class="scale" id="timidezScale"><span class="marker" id="timidezMarker" style="left:0%"></span></div>
    <div class="ticks"><span>10</span><span>20</span><span>30</span><span>40</span><span>50</span><span>60</span><span>70</span><span>80</span><span>90</span><span>100</span></div>
  </div>
  <div class="note">* Un puntaje bajo indica mejor manejo en estas áreas.</div>

  <div class="section-title">PROPENSIÓN AL CAMBIO</div>
  <div class="row">
    <div style="font-weight:800; margin-bottom:6px;">PROPENSIÓN AL CAMBIO</div>
    <div class="scale" id="cambioScale"><span class="marker" id="cambioMarker" style="left:0%"></span></div>
    <div class="ticks"><span>10</span><span>20</span><span>30</span><span>40</span><span>50</span><span>60</span><span>70</span><span>80</span><span>90</span><span>100</span></div>
  </div>

  <div class="grid2">
    <div>
      <div class="section-title">Resultados</div>
      <div style="margin:4px 0 10px;">Contestadas: <span id="contestadas">—</span></div>
      <div class="card" style="margin-bottom:16px;">
        <h3>Por sub-habilidad</h3>
        <table id="tablaSub">
          <thead><tr><th>Bloque</th><th>Sub-habilidad</th><th>Ítems</th><th>Puntos</th><th>%</th><th>Rango</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="card">
        <h3>Por bloque</h3>
        <table id="tablaBloques">
          <thead><tr><th>Bloque</th><th>Promedio %</th><th>Rango</th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="chips" style="padding:10px 12px">
          <span>Rangos:</span>
          <span class="chip red">1–40</span>
          <span class="chip amber">41–70</span>
          <span class="chip green">71–100</span>
        </div>
      </div>
    </div>
    <div>
      <div class="card" style="margin-bottom:16px;">
        <h3>Curva de distribución de frecuencias</h3>
        <div class="curve">
          <svg viewBox="0 0 400 210">
            <!-- arco base -->
            <path id="arc" d="M10,170 C120,30 280,30 390,170" stroke="#111" stroke-width="2" fill="none"/>
            <!-- bandas 1-40 / 41-70 / 71-100 -->
            <path class="band red" d="M10,170 C40,150 70,140 100,135" />
            <path class="band amber" d="M100,135 C160,115 220,115 280,135" />
            <path class="band green" d="M280,135 C320,150 360,160 390,170" />
            <!-- marcas -->
            <line x1="10" y1="175" x2="10" y2="180" stroke="#333"/>
            <line x1="145" y1="175" x2="145" y2="180" stroke="#333"/>
            <line x1="280" y1="175" x2="280" y2="180" stroke="#333"/>
            <line x1="390" y1="175" x2="390" y2="180" stroke="#333"/>
            <text x="8" y="195" font-size="10">1</text>
            <text x="140" y="195" font-size="10">40</text>
            <text x="275" y="195" font-size="10">70</text>
            <text x="385" y="195" font-size="10">100</text>
            <!-- punto IIE -->
            <circle id="iieDot" class="dot" cx="390" cy="170" r="4"/>
          </svg>
        </div>
      </div>
      <div class="card">
        <h3>IV1 – IV2 – IV3</h3>
        <div class="ivgrid" id="ivgrid">
          <div class="ivhead"> </div>
          <div class="ivhead">Se conoce o se compromete</div>
          <div class="ivhead">Se conoce o se compromete poco</div>
          <div class="ivhead">Se requiere mayor autoconocimiento o auto compromiso</div>

          <div class="ivhead">IV1</div>
          <div id="iv1c1"> </div>
          <div id="iv1c2"> </div>
          <div id="iv1c3"> </div>

          <div class="ivhead">IV2</div>
          <div id="iv2c1">No se contradice</div>
          <div id="iv2c2">Se contradice</div>
          <div id="iv2c3">Se contradice frecuentemente</div>

          <div class="ivhead">IV3</div>
          <div id="iv3c1">Entre 30 y 90 minutos<br/><span class="mini">Tomó el tiempo adecuado</span></div>
          <div id="iv3c2">Entre 10 y 20 minutos<br/><span class="mini">Demasiado breve</span></div>
          <div id="iv3c3">Más de 90 minutos<br/><span class="mini">Demasiado lento</span></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const API_URL = '/api/report?code='; // cambia si tu ruta difiere

function rangoChip(p){
  if(p<=40) return '<span class="chip red">1–40 Por desarrollar</span>';
  if(p<=70) return '<span class="chip amber">41–70 Por fortalecer</span>';
  return '<span class="chip green">71–100 Por enriquecer</span>';
}

function setMarker(id, val){
  if(!val){ val = 10; }
  const el = document.getElementById(id);
  const pct = Math.max(10, Math.min(100, val));
  el.style.left = (pct - 10) / 90 * 100 + '%';
}

function setIVHighlight(targetId){
  document.querySelectorAll('#ivgrid div').forEach(d=> d.classList.remove('ivmark'));
  document.getElementById(targetId).classList.add('ivmark');
}

function placeIIEDot(iie){
  // map 1..100 al eje x del arco
  const x = 10 + (iie-1)/99 * (390-10);
  // y aproximado (170 base, ~130 pico)
  const t = (iie-1)/99;
  const y = 170 - (1 - (Math.abs(t-0.5)*2)) * 40;
  const dot = document.getElementById('iieDot');
  dot.setAttribute('cx', x);
  dot.setAttribute('cy', y);
}

function fillTables(subs=[], blocks=[]){
  const tb = document.querySelector('#tablaSub tbody');
  tb.innerHTML = '';
  subs.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.bloque||''}</td>
      <td>${r.sub||''}</td>
      <td>${r.items||''}</td>
      <td>${r.puntos||''}</td>
      <td>${r.p||''}</td>
      <td>${rangoChip(r.p||0)}</td>`;
    tb.appendChild(tr);
  });

  const tb2 = document.querySelector('#tablaBloques tbody');
  tb2.innerHTML='';
  blocks.forEach(b=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${b.bloque||''}</td>
      <td>${b.p||''}</td>
      <td>${rangoChip(b.p||0)}</td>`;
    tb2.appendChild(tr);
  });
}

function ivCoherencia(payload){
  // IV1 por IIE
  const iie = Number(payload.iie || 0);
  if(iie >= 71) setIVHighlight('iv1c1');
  else if(iie >= 41) setIVHighlight('iv1c2');
  else setIVHighlight('iv1c3');

  // IV2 por dispersión de bloques
  const blocks = payload.blocks || [];
  const vals = blocks.map(b=> Number(b.p||0)).filter(x=>!isNaN(x));
  if(vals.length>0){
    const mx = Math.max(...vals), mn = Math.min(...vals);
    const spread = mx - mn;
    if(spread <= 10) setIVHighlight('iv2c1');
    else if(spread <= 25) setIVHighlight('iv2c2');
    else setIVHighlight('iv2c3');
  } else {
    setIVHighlight('iv2c1');
  }

  // IV3 por minutos (si hay), si no, asumir adecuado
  const t = Number(payload.minutos || 45);
  if(t >= 30 && t <= 90) setIVHighlight('iv3c1');
  else if(t < 30) setIVHighlight('iv3c2');
  else setIVHighlight('iv3c3');
}

function render(payload){
  document.getElementById('nombre').textContent = payload.nombre || '—';
  document.getElementById('edad').textContent = payload.edad ?? '—';
  document.getElementById('curso').textContent = payload.curso || '—';
  document.getElementById('institucion').textContent = payload.institucion || '—';
  document.getElementById('grupo').textContent = payload.grupo || '—';
  document.getElementById('iie').textContent = payload.iie ?? '—';
  document.getElementById('contestadas').textContent = payload.contestadas ?? '—';

  setMarker('agresionMarker', Number(payload.agresion||0));
  setMarker('timidezMarker', Number(payload.timidez||0));
  setMarker('cambioMarker', Number(payload.cambio||0));

  placeIIEDot(Number(payload.iie||1));

  fillTables(payload.subs || [], payload.blocks || []);
  ivCoherencia(payload);
}

// DEMO local para ver layout si la API aún no responde
const DEMO = {
  nombre:'FRANCISCO PAEZ', edad:23, curso:'TERCERO A', institucion:'LEXIUM', grupo:'2025-2026',
  iie:54, contestadas:175,
  agresion:95, timidez:33, cambio:55,
  minutos:45,
  subs:[
    {bloque:'Estilos de comunicación interpersonal', sub:'Agresión', items:19, puntos:57, p:100},
    {bloque:'Estilos de comunicación interpersonal', sub:'Timidez', items:19, puntos:51, p:89},
  ],
  blocks:[
    {bloque:'Estilos de comunicación interpersonal', p:64},
    {bloque:'Habilidades interpersonales', p:34},
    {bloque:'Habilidades intrapersonales', p:2},
    {bloque:'Habilidades para la vida', p:21},
    {bloque:'Propensión al cambio', p:18},
  ]
};

async function buscar(code){
  try{
    const res = await fetch(API_URL + encodeURIComponent(code));
    if(!res.ok) throw new Error('HTTP '+res.status);
    const data = await res.json();
    render(data);
  }catch(e){
    // fallback visual
    render(DEMO);
  }
}

document.getElementById('btnBuscar').addEventListener('click',()=>{
  const code = document.getElementById('codeInput').value.trim();
  if(!code) return;
  buscar(code);
});
document.getElementById('codeInput').addEventListener('keydown',e=>{
  if(e.key==='Enter'){
    document.getElementById('btnBuscar').click();
  }
});

// Render inicial para comprobar diseño
render(DEMO);
</script>
</body>
</html>
