
<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>OKMHP100 – Reporte PPA</title>

<style>
  :root{
    --ink:#111; --muted:#666; --line:#ddd; --soft:#f7f7f7;
    --yellow:#ffe36a; --green:#2e9b4f; --orange:#f4a338; --red:#e45757;
  }
  body{font-family:system-ui,Arial,sans-serif;background:#fff;color:var(--ink);margin:0}
  .wrap{max-width:1100px;margin:24px auto;padding:0 18px}
  h1,h2,h3{margin:0 0 8px 0}
  .topbar{display:flex;gap:12px;align-items:center;margin-bottom:12px}
  .topbar input{
    flex:0 0 180px;padding:8px 10px;border:1px solid #bbb;border-radius:8px;font-size:16px
  }
  .btn{
    padding:9px 14px;border-radius:999px;border:0;background:#1a8f3b;color:#fff;
    font-weight:700;font-size:16px;cursor:pointer
  }
  .msg{margin-left:8px;font-weight:700}
  .msg.ok{color:#0a8b2a}
  .msg.err{color:#b30000}

  .page{margin-top:10px}
  .page-break{height:0;margin:0;border:0}
  @media print{
    .topbar,.hint{display:none !important}
    .page-break{page-break-before:always}
    .page{break-inside:avoid}
    body{margin:0}
  }

  .p1-header{
    display:flex;align-items:flex-start;justify-content:space-between;margin-top:8px
  }
  .p1-title h2{font-size:22px;font-weight:800;letter-spacing:.2px}
  .p1-title .sub{font-size:13px;color:var(--muted)}
  .logos{display:flex;gap:10px;align-items:center}
  .logos img{height:46px;object-fit:contain}

  .info-box{
    margin-top:8px;border:1px solid var(--line);border-radius:10px;padding:8px 10px;
    display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:14px
  }
  .info-row{display:flex;gap:6px}
  .info-row b{min-width:90px}
  .info-row span{font-weight:700}

  .curve-wrap{display:grid;grid-template-columns:1.1fr .9fr;gap:14px;margin-top:10px}
  .curve-card{border:1px solid var(--line);border-radius:10px;padding:10px}
  .curve-title{font-weight:800;margin-bottom:6px}
  .curve-bar{
    position:relative;height:14px;border-radius:999px;overflow:hidden;border:1px solid #999;
    background:linear-gradient(90deg,#e74c3c 0%, #f39c12 35%, #2ecc71 70%, #5dade2 100%);
  }
  .curve-marker{
    position:absolute;top:-4px;width:10px;height:10px;border-radius:50%;
    background:#111;border:2px solid #fff;transform:translateX(-50%);
  }
  .curve-scale{display:flex;justify-content:space-between;font-size:12px;color:#222;margin-top:4px}

  table{border-collapse:collapse;width:100%}
  .iv-table td,.iv-table th{border:1px solid #aaa;padding:6px 7px;font-size:13px;vertical-align:middle}
  .iv-table th{background:#f0f0f0;text-align:center}
  .iv-table .ivcol{width:80px;font-weight:800;text-align:center}
  .iv-table .hl{background:var(--yellow)}

  .skills-block{margin-top:12px}
  .skills-head{
    display:flex;justify-content:space-between;align-items:center;font-weight:800;margin-bottom:4px
  }
  .skills-grid{
    display:grid;grid-template-columns:220px 1fr 1fr 1fr;gap:6px;align-items:center;font-size:13px
  }
  .skills-grid .colhead{font-size:12px;color:#333;text-align:center}
  .slot{
    height:14px;border:1px solid #aab;border-radius:4px;background:#f3f5f8;position:relative;overflow:hidden
  }
  .fill{position:absolute;left:0;top:0;bottom:0;background:#6b7280}
  .namecell{padding-left:2px}

  .bars-card{border:1px solid var(--line);border-radius:10px;padding:10px;margin-top:10px}
  .barrow{margin:8px 0}
  .barlabel{font-weight:800;font-size:14px}
  .bar{
    position:relative;height:14px;border-radius:999px;overflow:hidden;border:1px solid #999;
    background:linear-gradient(90deg,#e74c3c 0%, #f39c12 50%, #2ecc71 100%);
  }
  .bar .marker{
    position:absolute;top:-6px;width:8px;height:24px;background:#111;border-radius:2px;transform:translateX(-50%);
  }
  .bar-scale{display:flex;justify-content:space-between;font-size:12px;color:#222;margin-top:2px}

  .p2-title{display:flex;justify-content:space-between;align-items:center;margin-top:6px}
  .p2-title h2{font-size:18px;font-weight:800}
  .card{border:1px solid var(--line);border-radius:10px;padding:10px;margin-top:8px}
  .result-table th,.result-table td{
    border-bottom:1px solid #e5e5e5;padding:6px 8px;font-size:13px;text-align:left
  }
  .result-table th{font-weight:800}
  .badge{
    display:inline-block;padding:2px 8px;border-radius:999px;font-weight:800;font-size:12px;color:#fff
  }
  .b-red{background:var(--red)}
  .b-orange{background:var(--orange)}
  .b-green{background:var(--green)}

  .hint{font-size:12px;color:var(--muted);margin-top:4px}
</style>
</head>
<body>
<div class="wrap">

  <div class="topbar">
    <input id="codigoInput" placeholder="LEX001" maxlength="10" style="text-transform:uppercase"/>
    <button class="btn" id="btnVer">Ver reporte</button>
    <span id="msg" class="msg"></span>
  </div>
  <div class="hint">Tip: también puedes abrir /reporte.html?codigo=LEX004</div>

  <div id="reporteContainer" style="display:none">

    <section class="page page-1" id="page1">
      <div class="p1-header">
        <div class="p1-title">
          <h2>SKILL MAP — INTELIGENCIA EMOCIONAL</h2>
          <div class="sub" id="fechaLine">Fecha: —</div>
        </div>
        <div class="logos">
          <img src="/assets/sellolexium.png" alt="Lexium"/>
          <img src="/assets/mhp100.jpg" alt="MHP100"/>
        </div>
      </div>

      <div class="info-box">
        <div class="info-row"><b>Nombre:</b> <span id="pNombre">—</span></div>
        <div class="info-row"><b>Edad:</b> <span id="pEdad">—</span></div>
        <div class="info-row"><b>Institución:</b> <span id="pInst">—</span></div>
        <div class="info-row"><b>Grupo:</b> <span id="pGrupo">—</span></div>
        <div class="info-row"><b>Curso:</b> <span id="pCurso">—</span></div>
        <div class="info-row"><b>Código:</b> <span id="pCodigo">—</span></div>
      </div>

      <div class="curve-wrap">
        <div class="curve-card">
          <div class="curve-title">CURVA DE DISTRIBUCIÓN DE FRECUENCIAS</div>
          <div class="curve-bar">
            <div class="curve-marker" id="curveMarker" style="left:50%"></div>
          </div>
          <div class="curve-scale"><span>1</span><span>40</span><span>70</span><span>100</span></div>
        </div>

        <div class="curve-card">
          <table class="iv-table">
            <thead>
              <tr>
                <th style="width:60px"></th>
                <th>Se conoce o se compromete</th>
                <th>Se conoce o se compromete poco</th>
                <th>Se requiere mayor autoconocimiento o auto compromiso</th>
              </tr>
            </thead>
            <tbody>
              <tr id="iv1Row">
                <td class="ivcol">IV1</td>
                <td class="iv1c1">Responde coherentemente</td>
                <td class="iv1c2">—</td>
                <td class="iv1c3">Se contradice frecuentemente</td>
              </tr>
              <tr id="iv2Row">
                <td class="ivcol">IV2</td>
                <td class="iv2c1">No se contradice</td>
                <td class="iv2c2">Se contradice</td>
                <td class="iv2c3">Se contradice frecuentemente</td>
              </tr>
              <tr id="iv3Row">
                <td class="ivcol">IV3</td>
                <td class="iv3c1">Entre 30 y 90 minutos<br/>Tomó el tiempo adecuado</td>
                <td class="iv3c2">Entre 10 y 20 minutos<br/>Demasiado breve</td>
                <td class="iv3c3">Más de 90 minutos<br/>Demasiado lento</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div id="skillsBlocks"></div>

      <div class="bars-card">
        <div style="font-weight:800;margin-bottom:4px">ESTILOS DE COMUNICACIÓN INTERPERSONAL</div>
        <div class="hint">Puntaje bajo = mejor manejo (marcador a la izquierda). Solo aparece si hay datos.</div>

        <div class="barrow">
          <div class="barlabel">Agresión (10–100)</div>
          <div class="bar"><div class="marker" id="mAgresion" style="display:none"></div></div>
          <div class="bar-scale"><span>10</span><span>100</span></div>
        </div>

        <div class="barrow">
          <div class="barlabel">Timidez (10–100)</div>
          <div class="bar"><div class="marker" id="mTimidez" style="display:none"></div></div>
          <div class="bar-scale"><span>10</span><span>100</span></div>
        </div>

        <div style="font-weight:800;margin:10px 0 4px">PROPENSIÓN AL CAMBIO</div>
        <div class="barrow">
          <div class="barlabel">Propensión al cambio (10–100)</div>
          <div class="bar"><div class="marker" id="mCambio" style="display:none"></div></div>
          <div class="bar-scale"><span>10</span><span>100</span></div>
        </div>
      </div>

    </section>

    <div class="page-break"></div>

    <section class="page page-2" id="page2">
      <div class="p2-title">
        <h2>RESULTADOS</h2>
        <div>
          <button class="btn" id="btnPDF" style="background:#2563eb">Imprimir / PDF</button>
          <button class="btn" id="btnJSON" style="background:#6b7280">Exportar JSON</button>
        </div>
      </div>

      <div class="card">
        <div><b>Contestadas:</b> <span id="contestadasLine">—</span></div>

        <h3 style="margin-top:8px">Por sub-habilidad</h3>
        <table class="result-table" id="subTable">
          <thead>
            <tr>
              <th>Bloque</th><th>Sub-habilidad</th><th>Ítems</th><th>Puntos</th><th>%</th><th>Rango</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <h3 style="margin-top:10px">Por bloque</h3>
        <table class="result-table" id="bloqTable">
          <thead>
            <tr><th>Bloque</th><th>Promedio %</th><th>Rango</th></tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="hint" style="margin-top:6px">
          Rangos: <span class="badge b-red">1–40</span>
          <span class="badge b-orange">41–70</span>
          <span class="badge b-green">71–100</span>
        </div>
      </div>
    </section>

  </div>
</div>

<script>
const $ = sel => document.querySelector(sel);

function rangoBadge(p){
  if (p<=40) return {txt:"1–40 Por desarrollar", cls:"b-red"};
  if (p<=70) return {txt:"41–70 Por fortalecer", cls:"b-orange"};
  return {txt:"71–100 Por enriquecer", cls:"b-green"};
}
function clamp(n,min,max){ return Math.max(min,Math.min(max,n)); }

function highlightIV(rowId, colIndex){
  const row = document.getElementById(rowId);
  if(!row) return;
  [...row.children].forEach((td)=>td.classList.remove("hl"));
  const idx = Math.max(1, Math.min(3, colIndex|0));
  const td = row.children[idx];
  if(td) td.classList.add("hl");
}

// Traduce cualquier valor de IV (1–3 ó 0–100) a columna 1/2/3
function ivToCol(v){
  if (v === null || v === undefined) return 2;
  const n = Number(v);
  if (!Number.isNaN(n)){
    if (Number.isInteger(n) && n>=1 && n<=3){
      return n; // ya viene 1,2,3
    }
    if (n <= 40) return 1;
    if (n <= 70) return 2;
    return 3;
  }
  // Si llegaran strings, intenta por palabras clave básicas
  const s = String(v).toLowerCase();
  if (s.includes("responde coher") || s.includes("no se contradice") || s.includes("30 y 90")) return 2;
  if (s.includes("se contradice frecuentemente") || s.includes("más de 90")) return 3;
  return 2;
}

function setMarker(id, val){
  const el = document.getElementById(id);
  if(val==null || isNaN(val)) { el.style.display="none"; return; }
  const pct = (clamp(val,10,100)-10)/90*100;
  el.style.left = pct + "%";
  el.style.display="block";
}

function renderSkillsBlocks(subRows){
  const host = $("#skillsBlocks");
  host.innerHTML = "";
  const byBlock = {};
  subRows.forEach(r=>{
    const b = r.bloque || r.block || "Bloque";
    (byBlock[b] ||= []).push(r);
  });

  for(const [bloque, rows] of Object.entries(byBlock)){
    if(!/intra|inter|vida|pv/i.test(bloque)) continue;
    const totalPct = Math.round(rows.reduce((a,r)=>a+(r.percent??r.pct??0),0)/rows.length||0);

    const div = document.createElement("div");
    div.className="skills-block";
    const ihLabel = /intra/i.test(bloque) ? "IH INTRA" : /inter/i.test(bloque) ? "IH INTER" : "IH PV";
    div.innerHTML = `
      <div class="skills-head">
        <div>${bloque.toUpperCase()}</div>
        <div>${ihLabel}: ${totalPct}</div>
      </div>
      <div class="skills-grid">
        <div></div>
        <div class="colhead">POR DESARROLLAR</div>
        <div class="colhead">POR FORTALECER</div>
        <div class="colhead">POR ENRIQUECER</div>
      </div>
    `;

    rows.forEach(r=>{
      const name = (r.subhabilidad || r.sub || r.subskill || "").toUpperCase();
      const pct = Math.round(r.percent ?? r.pct ?? 0);
      const bucket = pct<=40?1:pct<=70?2:3;
      const row = document.createElement("div");
      row.className="skills-grid";
      row.innerHTML = `
        <div class="namecell">${name}</div>
        <div class="slot">${bucket===1?`<div class="fill" style="width:${pct}%"></div>`:""}</div>
        <div class="slot">${bucket===2?`<div class="fill" style="width:${pct}%"></div>`:""}</div>
        <div class="slot">${bucket===3?`<div class="fill" style="width:${pct}%"></div>`:""}</div>
      `;
      div.appendChild(row);
    });

    host.appendChild(div);
  }
}

function renderPage2(subRows, bloqRows){
  const subT = $("#subTable tbody");
  subT.innerHTML = "";
  subRows.forEach(r=>{
    const bloque = r.bloque || r.block || "";
    const sub = r.subhabilidad || r.sub || "";
    const items = r.items ?? r.n_items ?? "";
    const puntos = r.puntos ?? r.points ?? "";
    const pct = Math.round(r.percent ?? r.pct ?? 0);
    const badge = rangoBadge(pct);
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${bloque}</td>
      <td>${sub}</td>
      <td>${items}</td>
      <td>${puntos}</td>
      <td><b>${pct}%</b></td>
      <td><span class="badge ${badge.cls}">${badge.txt}</span></td>
    `;
    subT.appendChild(tr);
  });

  const bloqT = $("#bloqTable tbody");
  bloqT.innerHTML = "";
  bloqRows.forEach(r=>{
    const bloque = r.bloque || r.block || "";
    const pct = Math.round(r.percent ?? r.pct ?? 0);
    const badge = rangoBadge(pct);
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${bloque}</td>
      <td><b>${pct}%</b></td>
      <td><span class="badge ${badge.cls}">${badge.txt}</span></td>
    `;
    bloqT.appendChild(tr);
  });
}

function renderAll(data){
  const attempt = data.attempt || data;
  const snap = attempt.snapshot || attempt.snap || attempt;
  const subRows = attempt.subhabilidades || attempt.subhabilidad || attempt.subRows || attempt.sub || [];
  const bloqRows = attempt.bloqPercents || attempt.bloqRows || attempt.bloques || [];

  window.__LAST_REPORT__ = data;

  $("#pCodigo").textContent = snap.codigo || attempt.codigo || $("#codigoInput").value.toUpperCase();
  $("#pNombre").textContent = snap.nombre || attempt.nombre || "—";
  $("#pEdad").textContent = snap.edad_anios ?? snap.edad ?? attempt.edad_anios ?? "—";
  $("#pInst").textContent = snap.institucion || attempt.institucion || "—";
  $("#pGrupo").textContent = snap.grupo || attempt.grupo || "—";
  $("#pCurso").textContent = snap.curso || attempt.curso || "—";

  const fecha = attempt.created_at || attempt.creado_en || attempt.fecha_intento;
  $("#fechaLine").textContent = "Fecha: " + (fecha ? new Date(fecha).toLocaleString("es-EC") : "—");

  const iie = attempt.iie ?? attempt.IIE ?? attempt.indice_ie;
  if(iie!=null){
    $("#curveMarker").style.left = clamp(iie,1,100) + "%";
  }

  const iv1Val = attempt.iv1Cat ?? attempt.iv1_cat ?? attempt.iv1 ?? attempt.IV1;
  const iv2Val = attempt.iv2Cat ?? attempt.iv2_cat ?? attempt.iv2 ?? attempt.IV2;
  const iv3Val = attempt.iv3Cat ?? attempt.iv3_cat ?? attempt.iv3 ?? attempt.IV3;

  highlightIV("iv1Row", ivToCol(iv1Val));
  highlightIV("iv2Row", ivToCol(iv2Val));
  highlightIV("iv3Row", ivToCol(iv3Val));

  renderSkillsBlocks(subRows);

  setMarker("mAgresion", attempt.agresion ?? attempt.Agresion);
  setMarker("mTimidez", attempt.timidez ?? attempt.Timidez);
  setMarker("mCambio", attempt.propension_cambio ?? attempt.propCambio ?? attempt.PropCambio);

  const contestadas = attempt.contestadas || attempt.n_respondidas || "244 de 244";
  $("#contestadasLine").textContent = contestadas;
  renderPage2(subRows, bloqRows);

  $("#reporteContainer").style.display="block";
}

async function cargarReporte(codigo){
  $("#msg").textContent = "Buscando...";
  $("#msg").className = "msg";
  $("#reporteContainer").style.display="none";

  try{
    const r = await fetch(`/api/report?codigo=${encodeURIComponent(codigo)}`);
    const data = await r.json();
    if(!r.ok || data.error){
      $("#msg").textContent = data.error || "No encontrado";
      $("#msg").className="msg err";
      return;
    }
    $("#msg").textContent = "Código válido.";
    $("#msg").className="msg ok";
    renderAll(data);
    window.scrollTo({top:0,behavior:"smooth"});
  }catch(e){
    $("#msg").textContent="Error de conexión";
    $("#msg").className="msg err";
  }
}

$("#btnVer").addEventListener("click", ()=>{
  const c = $("#codigoInput").value.trim().toUpperCase();
  if(!c) return;
  cargarReporte(c);
});

$("#btnPDF").addEventListener("click", ()=>window.print());
$("#btnJSON").addEventListener("click", ()=>{
  const payload = window.__LAST_REPORT__ || {};
  const blob = new Blob([JSON.stringify(payload,null,2)],{type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "mhp100-reporte.json";
  a.click();
});

(function init(){
  const qp = new URLSearchParams(location.search);
  const c = (qp.get("codigo")||"").trim().toUpperCase();
  if(c){
    $("#codigoInput").value=c;
    cargarReporte(c);
  }
})();
</script>
</body>
</html>
