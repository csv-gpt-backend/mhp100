<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ZZMHP100 — Reporte en vivo por código</title>
<style>
  :root{--txt:#222;--mut:#666;--line:#e5e5e5}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:24px;color:var(--txt)}
  h1{font-size:18px;margin:0 0 12px}
  .card{border:1px solid var(--line); border-radius:12px; padding:16px; margin-bottom:16px}
  .row{display:flex; gap:8px; align-items:center}
  input[type=text]{padding:8px 10px; border:1px solid var(--line); border-radius:8px; font-size:14px; width:220px}
  button{padding:8px 12px; border:1px solid var(--line); border-radius:10px; background:#fafafa; cursor:pointer}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:14px;margin-bottom:14px}
  .grid b{font-weight:600}
  .section{margin:18px 0}
  .iie{font-weight:700;border-top:1px solid #ddd;border-bottom:1px solid #ddd;padding:8px 0}
  .iie .val{float:right;font-weight:700}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{border:1px solid var(--line);padding:6px 8px;text-align:left}
  .small{font-size:12px;color:var(--mut)}
  .rail{position:relative;height:12px;background:#eee;border-radius:6px}
  .tick{position:absolute;top:0;bottom:0;width:2px;background:#ccc}
  .marker{position:absolute;top:-4px;width:2px;height:20px;background:#111}
  .hide{display:none}
  @media print{
    body{margin:10mm}
    .noprint{display:none}
  }
</style>
</head>
<body>
  <h1>GRÁFICA INDIVIDUAL — MHP100</h1>

  <div class="card noprint">
    <div class="row">
      <label for="code"><b>Código</b></label>
      <input id="code" type="text" placeholder="Ej. LEX004" />
      <button id="btnLoad">Generar reporte</button>
      <span id="msg" class="small" style="margin-left:10px;color:#a00"></span>
    </div>
    <div class="small" style="margin-top:8px">Este archivo consulta <code>/api/report?codigo=&lt;CÓDIGO&gt;</code> en tu proyecto (mismo dominio).</div>
  </div>

  <div id="report" class="hide">
    <div class="grid" id="hdr"></div>

    <div class="section iie" id="iieLine">
      ÍNDICE DE INTELIGENCIA EMOCIONAL IIE: <span class="val" id="iieVal">-</span>
    </div>

    <div class="section" id="bloquesSec">
      <b>Promedios por bloque (0–100)</b>
      <table id="tblBloques">
        <tr><th>Bloque</th><th>%</th></tr>
      </table>
    </div>

    <div class="section" id="ivsSec">
      <b>IV1 / IV2 / IV3</b>
      <table id="tblIV">
        <tr><th>IV1</th><td id="iv1">-</td></tr>
        <tr><th>IV2</th><td id="iv2">-</td></tr>
        <tr><th>IV3</th><td id="iv3">-</td></tr>
      </table>
    </div>

    <div class="section" id="estilosSec">
      <b>Estilos de comunicación interpersonal</b><br/>
      <div class="small">* Un puntaje bajo indica mejor manejo en estas áreas.</div>
      <p>Agresión (10–100):</p>
      <div class="rail">
        <span class="marker" id="agresionMk" style="left:0%"></span>
        <span class="tick" style="left:10%"></span>
        <span class="tick" style="left:40%"></span>
        <span class="tick" style="left:70%"></span>
        <span class="tick" style="left:100%"></span>
      </div>
      <p>Timidez (10–100):</p>
      <div class="rail">
        <span class="marker" id="timidezMk" style="left:0%"></span>
        <span class="tick" style="left:10%"></span>
        <span class="tick" style="left:40%"></span>
        <span class="tick" style="left:70%"></span>
        <span class="tick" style="left:100%"></span>
      </div>
    </div>

    <div class="section" id="propSec">
      <b>Propensión al cambio (10–100)</b>
      <div class="rail">
        <span class="marker" id="propMk" style="left:0%"></span>
        <span class="tick" style="left:10%"></span>
        <span class="tick" style="left:40%"></span>
        <span class="tick" style="left:70%"></span>
        <span class="tick" style="left:100%"></span>
      </div>
    </div>

    <div class="section" id="subsSec">
      <b>Resultados (sub-habilidades)</b>
      <table id="tblSubs">
        <tr><th>Bloque</th><th>Sub-habilidad</th><th>%</th></tr>
      </table>
    </div>
  </div>

<script>
const $ = sel => document.querySelector(sel);

function text(v){ return (v===undefined || v===null || v==='') ? '-' : v; }
function pct(v){ const n = Number(v); return Number.isFinite(n) ? n : null; }
function setMarker(id, v){
  const el = $(id);
  if(!el) return;
  if(v===null){ el.style.display='none'; return; }
  const x = Math.max(0, Math.min(100, Math.round(v)));
  el.style.display='block';
  el.style.left = x + '%';
}
function mapIV(labelOrCode, map){
  if(labelOrCode===undefined || labelOrCode===null || labelOrCode==='') return '-';
  if(typeof labelOrCode==='number' && map[labelOrCode]!==undefined) return map[labelOrCode];
  return labelOrCode;
}

async function loadReport(){
  const msg = $('#msg');
  msg.textContent = '';
  const code = $('#code').value.trim();
  if(!code){ msg.textContent='Ingresa un código'; return; }

  try{
    const res = await fetch('/api/report?codigo=' + encodeURIComponent(code));
    if(!res.ok){ throw new Error('No encontrado o error del servidor'); }
    const data = await res.json();

    const P = data.participante || data.participant || {};
    const A = data.attempt || data.intento || data || {};
    const R = A.resultados || data.resultados || {};

    // Encabezado
    const nombre = A.nombre || P.nombre || '';
    const edad = A.edad_anios || P.edad_anios || '';
    const institucion = A.institucion || P.institucion || '';
    const grupo = A.grupo || P.grupo || '';
    const curso = A.curso || P.curso || '';
    const fecha = (A.created_at || A.fecha || '').toString().slice(0,10);
    const codigo = A.codigo || P.codigo || code;

    $('#hdr').innerHTML = `
      <div><b>Nombre:</b> ${text(nombre)}</div>
      <div><b>Edad:</b> ${text(edad)}</div>
      <div><b>Curso/Grado:</b> ${text(curso)}</div>
      <div><b>Institución:</b> ${text(institucion)}</div>
      <div><b>Grupo:</b> ${text(grupo)}</div>
      <div><b>Fecha:</b> ${text(fecha)}</div>
      <div><b>Código:</b> ${text(codigo)}</div>
    `;

    // IIE
    const iie = A.iie ?? (R.globales && R.globales.IIE);
    $('#iieVal').textContent = text(iie);

    // Bloques
    const bIntra = A.b_intra ?? (R.bloques && R.bloques.intrapersonales);
    const bInter = A.b_inter ?? (R.bloques && R.bloques.interpersonales);
    const bPV    = A.b_pv    ?? (R.bloques && R.bloques.para_la_vida);
    const tblB = $('#tblBloques');
    tblB.innerHTML = '<tr><th>Bloque</th><th>%</th></tr>'
      + `<tr><td>Habilidades intrapersonales</td><td>${text(bIntra)}</td></tr>`
      + `<tr><td>Habilidades interpersonales</td><td>${text(bInter)}</td></tr>`
      + `<tr><td>Habilidades para la vida</td><td>${text(bPV)}</td></tr>`;

    // IVs
    const iv1 = A.iv1 ?? (R.globales && R.globales.IV1);
    const iv2 = A.iv2 ?? (R.globales && R.globales.IV2);
    const iv3 = A.iv3 ?? (R.globales && R.globales.IV3);
    $('#iv1').textContent = mapIV(iv1,{0:'Se conoce o se compromete',1:'Se conoce o se compromete poco',2:'Se requiere mayor autoconocimiento o auto compromiso'});
    $('#iv2').textContent = mapIV(iv2,{0:'No se contradice',1:'Se contradice',2:'Se contradice frecuentemente'});
    $('#iv3').textContent = mapIV(iv3,{0:'10–20 min',1:'30–90 min',2:'Más de 90 min'});

    // Estilos + Propensión
    let agresion = null, timidez = null, prop = null;
    const subs = (R.subhabilidades || []);
    for(const s of subs){
      const sub = (s.sub||'').toLowerCase();
      if(sub === 'agresión' || sub==='agresion') agresion = pct(s.pct);
      if(sub === 'timidez') timidez = pct(s.pct);
      if(sub === 'propensión al cambio' || sub==='propension al cambio') prop = pct(s.pct);
    }
    if(prop===null && R.bloques && (R.bloques.propension_cambio!=null)) prop = Number(R.bloques.propension_cambio);

    setMarker('#agresionMk', agresion);
    setMarker('#timidezMk', timidez);
    setMarker('#propMk', prop);

    // Sub-habilidades (si viene)
    const tblS = $('#tblSubs');
    tblS.innerHTML = '<tr><th>Bloque</th><th>Sub-habilidad</th><th>%</th></tr>';
    for(const s of subs){
      const b = s.bloque || s.block || '';
      const sub = s.sub || s.subhabilidad || '';
      const val = s.pct;
      if(sub){ tblS.innerHTML += `<tr><td>${text(b)}</td><td>${text(sub)}</td><td>${text(val)}</td></tr>`; }
    }

    $('#report').classList.remove('hide');
    window.scrollTo(0, document.body.scrollHeight);
  }catch(err){
    console.error(err);
    msg.textContent = 'No se pudo generar: verifique el código o el endpoint /api/report';
  }
}

document.getElementById('btnLoad').addEventListener('click', loadReport);
document.getElementById('code').addEventListener('keydown', (e)=>{ if(e.key==='Enter') loadReport(); });
</script>
</body>
</html>
